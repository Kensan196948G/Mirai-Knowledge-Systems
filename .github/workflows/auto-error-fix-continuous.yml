name: ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ5åˆ†é–“éš”ãƒ»ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰

on:
  # 10åˆ†ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œï¼ˆ15å›ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œå¾Œã€æ¬¡ã®ãƒˆãƒªã‚¬ãƒ¼ã¾ã§10åˆ†å¾…æ©Ÿï¼‰
  schedule:
    - cron: '*/10 * * * *'  # æ¯10åˆ†ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ ï¼‰- å®Ÿè¡Œé‡è¤‡ã‚’é˜²ããŸã‚5åˆ†ã‹ã‚‰å¤‰æ›´

  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15ï¼‰'
        required: false
        default: '15'
      create_issue:
        description: 'Issueä½œæˆï¼ˆyes/noï¼‰'
        required: false
        default: 'yes'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  MAX_LOOPS: 15
  MKS_ENV: test
  MKS_SECRET_KEY: test-secret-key-for-ci
  MKS_JWT_SECRET_KEY: test-jwt-secret-key-for-ci
  MKS_CORS_ORIGINS: http://localhost:5100

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ - å‰å›ã®å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¾ã§æ–°ã—ã„å®Ÿè¡Œã‚’å¾…æ©Ÿ
concurrency:
  group: auto-error-fix-continuous
  cancel-in-progress: false

jobs:
  auto-error-detection-and-fix:
    name: ã‚¨ãƒ©ãƒ¼è‡ªå‹•æ¤œçŸ¥ãƒ»ä¿®å¾©ï¼ˆ15å›ãƒ«ãƒ¼ãƒ—ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆäºˆæœŸã›ã¬ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²æ­¢ï¼‰

    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write
      issues: write  # Issueã®ä½œæˆã«å¿…è¦

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          playwright install --with-deps

      - name: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆ15å›ï¼‰
        id: error_fix_loop
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://mks_user:mks_password@localhost:5432/mks_db
          REDIS_URL: redis://localhost:6379/0
          PGHOST: localhost
          PGPORT: 5432
          MKS_PORT: 5100
          MKS_ENV: test
          MKS_SECRET_KEY: test-secret-key-for-ci
          MKS_JWT_SECRET_KEY: test-jwt-secret-key-for-ci
          MKS_CORS_ORIGINS: http://localhost:5100
          MKS_SKIP_HTTP_CHECK: true
        run: |
          echo "==================================="
          echo "ã‚¨ãƒ©ãƒ¼è‡ªå‹•æ¤œçŸ¥ãƒ»ä¿®å¾©é–‹å§‹"
          echo "æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°: ${{ github.event.inputs.max_loops || env.MAX_LOOPS }}"
          echo "==================================="
          echo ""

          # ãƒ«ãƒ¼ãƒ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
          LOOP_COUNT=0
          MAX_LOOPS=${{ github.event.inputs.max_loops || env.MAX_LOOPS }}
          ERROR_COUNT=0
          FIX_COUNT=0

          # æ—©æœŸçµ‚äº†æ¡ä»¶ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
          CONSECUTIVE_ERRORS=0
          CONSECUTIVE_SUCCESS=0

          # çµæœãƒ•ã‚¡ã‚¤ãƒ«
          RESULT_FILE="${GITHUB_WORKSPACE}/error_fix_results.txt"
          echo "# ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ­ã‚°" > "$RESULT_FILE"
          echo "å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')" >> "$RESULT_FILE"
          echo "æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°: ${MAX_LOOPS}" >> "$RESULT_FILE"
          echo "" >> "$RESULT_FILE"

          while [ $LOOP_COUNT -lt $MAX_LOOPS ]; do
            LOOP_COUNT=$((LOOP_COUNT + 1))
            echo "----------------------------------------"
            echo "ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT}/${MAX_LOOPS}"
            echo "----------------------------------------"
            echo "## ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT}/${MAX_LOOPS}" >> "$RESULT_FILE"

            # ã‚¨ãƒ©ãƒ¼æ¤œå‡ºãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            ERROR_DETECTED=0

            # 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            echo "[STEP 1] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
            if python scripts/health_monitor.py > health_check.log 2>&1; then
              echo "âœ“ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
              cat health_check.log >> "$RESULT_FILE"
            else
              echo "âœ— ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
              ERROR_DETECTED=1
              ERROR_COUNT=$((ERROR_COUNT + 1))
              cat health_check.log >> "$RESULT_FILE"
            fi

            # 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ï¼‰
            echo "[STEP 2] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
            if pytest tests/ -v --tb=short > test_results.log 2>&1; then
              echo "âœ“ å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼"
              echo "### ãƒ†ã‚¹ãƒˆçµæœ: åˆæ ¼" >> "$RESULT_FILE"
            else
              echo "âœ— ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’æ¤œå‡º"
              ERROR_DETECTED=1
              ERROR_COUNT=$((ERROR_COUNT + 1))
              echo "### ãƒ†ã‚¹ãƒˆçµæœ: å¤±æ•—" >> "$RESULT_FILE"
              grep -A 3 "FAILED" test_results.log >> "$RESULT_FILE" || true

              # 3. è‡ªå‹•ä¿®å¾©è©¦è¡Œ
              echo "[STEP 3] è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œä¸­..."
              if python scripts/auto_fix_daemon.py --once >> "$RESULT_FILE" 2>&1; then
                echo "âœ“ è‡ªå‹•ä¿®å¾©å®Œäº†"
                FIX_COUNT=$((FIX_COUNT + 1))
              else
                echo "âœ— è‡ªå‹•ä¿®å¾©å¤±æ•—"
                echo "### è‡ªå‹•ä¿®å¾©: å¤±æ•—" >> "$RESULT_FILE"
              fi
            fi

            # 4. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
            echo "[STEP 4] ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªä¸­..."
            if [ -f logs/app.log ]; then
              ERROR_LINES=$(grep -i "error\|exception\|critical" logs/app.log | tail -10 || true)
              if [ -n "$ERROR_LINES" ]; then
                echo "âœ— ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º"
                ERROR_DETECTED=1
                ERROR_COUNT=$((ERROR_COUNT + 1))
                echo "### ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼:" >> "$RESULT_FILE"
                echo "$ERROR_LINES" >> "$RESULT_FILE"
              else
                echo "âœ“ ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãªã—"
              fi
            fi

            echo ""
            echo "ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT} å®Œäº† - ã‚¨ãƒ©ãƒ¼: ${ERROR_COUNT}, ä¿®å¾©: ${FIX_COUNT}"
            echo "" >> "$RESULT_FILE"

            # æ—©æœŸçµ‚äº†æ¡ä»¶ãƒã‚§ãƒƒã‚¯
            if [ $ERROR_DETECTED -eq 1 ]; then
              CONSECUTIVE_ERRORS=$((CONSECUTIVE_ERRORS + 1))
              CONSECUTIVE_SUCCESS=0
              
              if [ $CONSECUTIVE_ERRORS -ge 5 ]; then
                echo "âš ï¸ é€£ç¶šã‚¨ãƒ©ãƒ¼5å›æ¤œå‡º - æ—©æœŸçµ‚äº†ã—ã¾ã™"
                echo "âš ï¸ **æ—©æœŸçµ‚äº†**: é€£ç¶šã‚¨ãƒ©ãƒ¼5å›æ¤œå‡º" >> "$RESULT_FILE"
                break
              fi
            else
              CONSECUTIVE_SUCCESS=$((CONSECUTIVE_SUCCESS + 1))
              CONSECUTIVE_ERRORS=0
              
              if [ $CONSECUTIVE_SUCCESS -ge 5 ]; then
                echo "âœ“ é€£ç¶šæˆåŠŸ5å› - æ­£å¸¸ã®ãŸã‚æ—©æœŸçµ‚äº†ã—ã¾ã™"
                echo "âœ“ **æ—©æœŸçµ‚äº†**: é€£ç¶šæˆåŠŸ5å› - ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸" >> "$RESULT_FILE"
                break
              fi
            fi

            # æœ€å¾Œã®ãƒ«ãƒ¼ãƒ—ã§ãªã‘ã‚Œã°5ç§’å¾…æ©Ÿ
            if [ $LOOP_COUNT -lt $MAX_LOOPS ]; then
              sleep 5
            fi
          done

          echo "==================================="
          echo "ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©å®Œäº†"
          echo "ç·ãƒ«ãƒ¼ãƒ—å›æ•°: ${LOOP_COUNT}"
          echo "æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}"
          echo "ä¿®å¾©å®Ÿè¡Œå›æ•°: ${FIX_COUNT}"
          echo "==================================="

          # ã‚µãƒãƒªãƒ¼ã‚’çµæœãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 
          echo "" >> "$RESULT_FILE"
          echo "---" >> "$RESULT_FILE"
          echo "## ã‚µãƒãƒªãƒ¼" >> "$RESULT_FILE"
          echo "- ç·ãƒ«ãƒ¼ãƒ—å›æ•°: ${LOOP_COUNT}" >> "$RESULT_FILE"
          echo "- æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}" >> "$RESULT_FILE"
          echo "- ä¿®å¾©å®Ÿè¡Œå›æ•°: ${FIX_COUNT}" >> "$RESULT_FILE"

          # GitHubç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "error_count=${ERROR_COUNT}" >> $GITHUB_OUTPUT
          echo "fix_count=${FIX_COUNT}" >> $GITHUB_OUTPUT
          echo "loop_count=${LOOP_COUNT}" >> $GITHUB_OUTPUT

      - name: çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: generate_report
        run: |
          REPORT_FILE="${GITHUB_WORKSPACE}/error_fix_report.md"
          RESULT_FILE="${GITHUB_WORKSPACE}/error_fix_results.txt"

          cat > "$REPORT_FILE" << 'REPORT_EOF'
          # ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

          **å®Ÿè¡Œæ—¥æ™‚:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼Run:** #${{ github.run_number }}
          **ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.sha }}

          ## ğŸ“Š å®Ÿè¡Œçµæœ

          | é …ç›® | å€¤ |
          |------|-----|
          | ãƒ«ãƒ¼ãƒ—å›æ•° | ${{ steps.error_fix_loop.outputs.loop_count }} / ${{ github.event.inputs.max_loops || env.MAX_LOOPS }} |
          | æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•° | ${{ steps.error_fix_loop.outputs.error_count }} |
          | ä¿®å¾©å®Ÿè¡Œå›æ•° | ${{ steps.error_fix_loop.outputs.fix_count }} |

          ## ğŸ“‹ è©³ç´°ãƒ­ã‚°

          REPORT_EOF

          # è©³ç´°ãƒ­ã‚°ã®ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ã¨æœ€é©åŒ–
          # GitHub Issues APIã¯65KBåˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€50KBã‚’è¶…ãˆã‚‹å ´åˆã¯è¦ç´„ç‰ˆã‚’ä½œæˆ
          MAX_LOG_LINES=500  # å…ˆé ­ã¨æœ«å°¾ã‹ã‚‰ä¿æŒã™ã‚‹è¡Œæ•°
          
          if [ -f "$RESULT_FILE" ]; then
            FILE_SIZE=$(stat -c%s "$RESULT_FILE" 2>/dev/null || stat -f%z "$RESULT_FILE" 2>/dev/null || echo 0)
            if [ $FILE_SIZE -gt 50000 ]; then
              echo "âš ï¸ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆ${FILE_SIZE} bytesï¼‰- è¦ç´„ç‰ˆã‚’ä½œæˆ"
              # æœ€åˆã®MAX_LOG_LINESè¡Œã¨æœ€å¾Œã®MAX_LOG_LINESè¡Œã®ã¿ä¿æŒï¼ˆåˆè¨ˆ1000è¡Œï¼‰
              head -n $MAX_LOG_LINES "$RESULT_FILE" > "${RESULT_FILE}.tmp"
              echo -e "\n... (ä¸­ç•¥: ãƒ­ã‚°ã‚µã‚¤ã‚º ${FILE_SIZE} bytes) ...\n" >> "${RESULT_FILE}.tmp"
              tail -n $MAX_LOG_LINES "$RESULT_FILE" >> "${RESULT_FILE}.tmp"
              mv "${RESULT_FILE}.tmp" "$RESULT_FILE"
            fi
            cat "$RESULT_FILE" >> "$REPORT_FILE"
          else
            echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> "$REPORT_FILE"
          fi

          echo "report_path=${REPORT_FILE}" >> $GITHUB_OUTPUT

      - name: GitHub Issueã«çµæœã‚’æŠ•ç¨¿
        if: always() && github.event.inputs.create_issue != 'no'
        uses: actions/github-script@v7
        with:
          script: |
            const errorCount = '${{ steps.error_fix_loop.outputs.error_count }}';
            const fixCount = '${{ steps.error_fix_loop.outputs.fix_count }}';
            const loopCount = '${{ steps.error_fix_loop.outputs.loop_count }}';
            const maxLoops = '${{ github.event.inputs.max_loops || env.MAX_LOOPS }}';

            // ã‚µãƒãƒªãƒ¼ã®ã¿ã®Issueæœ¬æ–‡ï¼ˆ65KBåˆ¶é™å¯¾ç­–ï¼‰
            const reportBody = `# ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚:** ${new Date().toISOString()}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼Run:** #${{ github.run_number }}
            **ã‚³ãƒŸãƒƒãƒˆ:** \`${{ github.sha }}\`

            ## ğŸ“Š å®Ÿè¡Œçµæœ

            | é …ç›® | å€¤ |
            |------|-----|
            | ãƒ«ãƒ¼ãƒ—å›æ•° | ${loopCount} / ${maxLoops} |
            | æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•° | ${errorCount} |
            | ä¿®å¾©å®Ÿè¡Œå›æ•° | ${fixCount} |

            ## ğŸ“‹ è©³ç´°ãƒ­ã‚°

            è©³ç´°ãƒ­ã‚°ã¯ä»¥ä¸‹ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š

            ğŸ“¦ **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå**: \`error-fix-results-${{ github.run_number }}\`

            1. [Actions ã‚¿ãƒ–](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’é–‹ã
            2. ä¸‹éƒ¨ã®ã€ŒArtifactsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ \`error-fix-results-${{ github.run_number }}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. \`error_fix_report.md\` ã«å…¨ãƒ«ãƒ¼ãƒ—ã®è©³ç´°ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™

            ---

            ğŸ¤– Generated by [GitHub Actions Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            // Issueã‚¿ã‚¤ãƒˆãƒ«
            const title = errorCount > 0
              ? `[è‡ªå‹•ä¿®å¾©] ã‚¨ãƒ©ãƒ¼${errorCount}ä»¶æ¤œå‡ºãƒ»ä¿®å¾©${fixCount}ä»¶å®Ÿè¡Œ (${new Date().toISOString().split('T')[0]})`
              : `[è‡ªå‹•ä¿®å¾©] æ­£å¸¸å‹•ä½œç¢ºèª (${new Date().toISOString().split('T')[0]})`;

            // Issueãƒ©ãƒ™ãƒ«
            const labels = errorCount > 0 ? ['auto-fix', 'error-detected'] : ['auto-fix', 'healthy'];

            // Issueä½œæˆ
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: reportBody,
              labels: labels
            });

            console.log('Issueä½œæˆå®Œäº†:', issue.data.html_url);

      - name: Artifactã«çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: error-fix-results-${{ github.run_number }}
          path: |
            error_fix_results.txt
            error_fix_report.md
            backend/logs/*.log
          retention-days: 30

      - name: æ¬¡å›å®Ÿè¡Œã¾ã§ã‚¹ãƒªãƒ¼ãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: false  # é€šå¸¸ã¯ç„¡åŠ¹ï¼ˆcronã§30åˆ†å¾Œã«å†å®Ÿè¡Œï¼‰
        run: |
          echo "æ¬¡å›å®Ÿè¡Œã¾ã§30åˆ†å¾…æ©Ÿ..."
          sleep 1800
