name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ30åˆ†é–“éš”ãƒ»ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰

on:
  # 30åˆ†ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†

  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15ï¼‰'
        required: false
        default: '15'
      create_issue:
        description: 'Issueä½œæˆï¼ˆyes/noï¼‰'
        required: false
        default: 'yes'

env:
  MAX_LOOPS: 15
  PYTHON_VERSION: '3.12'

jobs:
  auto-error-detection-and-fix:
    name: ã‚¨ãƒ©ãƒ¼è‡ªå‹•æ¤œçŸ¥ãƒ»ä¿®å¾©ï¼ˆ15å›ãƒ«ãƒ¼ãƒ—ï¼‰
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: PostgreSQLèµ·å‹•ï¼ˆDockerï¼‰
        run: |
          docker run -d \
            --name postgres \
            -e POSTGRES_USER=mks_user \
            -e POSTGRES_PASSWORD=mks_password \
            -e POSTGRES_DB=mks_db \
            -p 5432:5432 \
            postgres:16-alpine

          # PostgreSQLèµ·å‹•å¾…æ©Ÿ
          for i in {1..30}; do
            if docker exec postgres pg_isready -U mks_user; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      - name: Redisèµ·å‹•ï¼ˆDockerï¼‰
        run: |
          docker run -d \
            --name redis \
            -p 6379:6379 \
            redis:7-alpine

          # Redisèµ·å‹•å¾…æ©Ÿ
          sleep 5

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://mks_user:mks_password@localhost:5432/mks_db
          REDIS_URL: redis://localhost:6379/0
        run: |
          python -c "from app_v2 import db, app; app.app_context().push(); db.create_all(); print('Database initialized')" || echo "Database already exists"

      - name: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆ15å›ï¼‰
        id: error_fix_loop
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://mks_user:mks_password@localhost:5432/mks_db
          REDIS_URL: redis://localhost:6379/0
          MKS_PORT: 5010
          MKS_ENV: test
        run: |
          echo "==================================="
          echo "ã‚¨ãƒ©ãƒ¼è‡ªå‹•æ¤œçŸ¥ãƒ»ä¿®å¾©é–‹å§‹"
          echo "æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°: ${{ github.event.inputs.max_loops || env.MAX_LOOPS }}"
          echo "==================================="
          echo ""

          # ãƒ«ãƒ¼ãƒ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
          LOOP_COUNT=0
          MAX_LOOPS=${{ github.event.inputs.max_loops || env.MAX_LOOPS }}
          ERROR_COUNT=0
          FIX_COUNT=0

          # çµæœãƒ•ã‚¡ã‚¤ãƒ«
          RESULT_FILE="${GITHUB_WORKSPACE}/error_fix_results.txt"
          echo "# ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ­ã‚°" > "$RESULT_FILE"
          echo "å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')" >> "$RESULT_FILE"
          echo "æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°: ${MAX_LOOPS}" >> "$RESULT_FILE"
          echo "" >> "$RESULT_FILE"

          while [ $LOOP_COUNT -lt $MAX_LOOPS ]; do
            LOOP_COUNT=$((LOOP_COUNT + 1))
            echo "----------------------------------------"
            echo "ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT}/${MAX_LOOPS}"
            echo "----------------------------------------"
            echo "## ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT}/${MAX_LOOPS}" >> "$RESULT_FILE"

            # 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            echo "[STEP 1] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
            if python scripts/health_monitor.py > health_check.log 2>&1; then
              echo "âœ“ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
              cat health_check.log >> "$RESULT_FILE"
            else
              echo "âœ— ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
              ERROR_COUNT=$((ERROR_COUNT + 1))
              cat health_check.log >> "$RESULT_FILE"
            fi

            # 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ï¼‰
            echo "[STEP 2] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
            if pytest tests/ -v --tb=short > test_results.log 2>&1; then
              echo "âœ“ å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼"
              echo "### ãƒ†ã‚¹ãƒˆçµæœ: åˆæ ¼" >> "$RESULT_FILE"
            else
              echo "âœ— ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’æ¤œå‡º"
              ERROR_COUNT=$((ERROR_COUNT + 1))
              echo "### ãƒ†ã‚¹ãƒˆçµæœ: å¤±æ•—" >> "$RESULT_FILE"
              grep -A 3 "FAILED" test_results.log >> "$RESULT_FILE" || true

              # 3. è‡ªå‹•ä¿®å¾©è©¦è¡Œ
              echo "[STEP 3] è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œä¸­..."
              if python scripts/auto_fix_daemon.py --once >> "$RESULT_FILE" 2>&1; then
                echo "âœ“ è‡ªå‹•ä¿®å¾©å®Œäº†"
                FIX_COUNT=$((FIX_COUNT + 1))
              else
                echo "âœ— è‡ªå‹•ä¿®å¾©å¤±æ•—"
                echo "### è‡ªå‹•ä¿®å¾©: å¤±æ•—" >> "$RESULT_FILE"
              fi
            fi

            # 4. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
            echo "[STEP 4] ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªä¸­..."
            if [ -f logs/app.log ]; then
              ERROR_LINES=$(grep -i "error\|exception\|critical" logs/app.log | tail -10 || true)
              if [ -n "$ERROR_LINES" ]; then
                echo "âœ— ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º"
                ERROR_COUNT=$((ERROR_COUNT + 1))
                echo "### ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼:" >> "$RESULT_FILE"
                echo "$ERROR_LINES" >> "$RESULT_FILE"
              else
                echo "âœ“ ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãªã—"
              fi
            fi

            echo ""
            echo "ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT} å®Œäº† - ã‚¨ãƒ©ãƒ¼: ${ERROR_COUNT}, ä¿®å¾©: ${FIX_COUNT}"
            echo "" >> "$RESULT_FILE"

            # æœ€å¾Œã®ãƒ«ãƒ¼ãƒ—ã§ãªã‘ã‚Œã°5ç§’å¾…æ©Ÿ
            if [ $LOOP_COUNT -lt $MAX_LOOPS ]; then
              sleep 5
            fi
          done

          echo "==================================="
          echo "ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©å®Œäº†"
          echo "ç·ãƒ«ãƒ¼ãƒ—å›æ•°: ${LOOP_COUNT}"
          echo "æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}"
          echo "ä¿®å¾©å®Ÿè¡Œå›æ•°: ${FIX_COUNT}"
          echo "==================================="

          # ã‚µãƒãƒªãƒ¼ã‚’çµæœãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 
          echo "" >> "$RESULT_FILE"
          echo "---" >> "$RESULT_FILE"
          echo "## ã‚µãƒãƒªãƒ¼" >> "$RESULT_FILE"
          echo "- ç·ãƒ«ãƒ¼ãƒ—å›æ•°: ${LOOP_COUNT}" >> "$RESULT_FILE"
          echo "- æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}" >> "$RESULT_FILE"
          echo "- ä¿®å¾©å®Ÿè¡Œå›æ•°: ${FIX_COUNT}" >> "$RESULT_FILE"

          # GitHubç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "error_count=${ERROR_COUNT}" >> $GITHUB_OUTPUT
          echo "fix_count=${FIX_COUNT}" >> $GITHUB_OUTPUT
          echo "loop_count=${LOOP_COUNT}" >> $GITHUB_OUTPUT

      - name: çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: generate_report
        run: |
          REPORT_FILE="${GITHUB_WORKSPACE}/error_fix_report.md"

          cat > "$REPORT_FILE" << 'REPORT_EOF'
          # ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

          **å®Ÿè¡Œæ—¥æ™‚:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼Run:** #${{ github.run_number }}
          **ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.sha }}

          ## ğŸ“Š å®Ÿè¡Œçµæœ

          | é …ç›® | å€¤ |
          |------|-----|
          | ãƒ«ãƒ¼ãƒ—å›æ•° | ${{ steps.error_fix_loop.outputs.loop_count }} / ${{ github.event.inputs.max_loops || env.MAX_LOOPS }} |
          | æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•° | ${{ steps.error_fix_loop.outputs.error_count }} |
          | ä¿®å¾©å®Ÿè¡Œå›æ•° | ${{ steps.error_fix_loop.outputs.fix_count }} |

          ## ğŸ“‹ è©³ç´°ãƒ­ã‚°

          REPORT_EOF

          # è©³ç´°ãƒ­ã‚°ã‚’è¿½åŠ 
          cat "${GITHUB_WORKSPACE}/error_fix_results.txt" >> "$REPORT_FILE" || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> "$REPORT_FILE"

          echo "report_path=${REPORT_FILE}" >> $GITHUB_OUTPUT

      - name: GitHub Issueã«çµæœã‚’æŠ•ç¨¿
        if: always() && github.event.inputs.create_issue != 'no'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorCount = '${{ steps.error_fix_loop.outputs.error_count }}';
            const fixCount = '${{ steps.error_fix_loop.outputs.fix_count }}';
            const loopCount = '${{ steps.error_fix_loop.outputs.loop_count }}';

            // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            let reportBody = 'è©³ç´°ãƒ­ã‚°ã¯æ·»ä»˜ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            try {
              reportBody = fs.readFileSync('${{ steps.generate_report.outputs.report_path }}', 'utf8');
            } catch (e) {
              console.log('ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
            }

            // Issueã‚¿ã‚¤ãƒˆãƒ«
            const title = errorCount > 0
              ? `[è‡ªå‹•ä¿®å¾©] ã‚¨ãƒ©ãƒ¼${errorCount}ä»¶æ¤œå‡ºãƒ»ä¿®å¾©${fixCount}ä»¶å®Ÿè¡Œ (${new Date().toISOString().split('T')[0]})`
              : `[è‡ªå‹•ä¿®å¾©] æ­£å¸¸å‹•ä½œç¢ºèª (${new Date().toISOString().split('T')[0]})`;

            // Issueãƒ©ãƒ™ãƒ«
            const labels = errorCount > 0 ? ['auto-fix', 'error-detected'] : ['auto-fix', 'healthy'];

            // Issueä½œæˆ
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: reportBody,
              labels: labels
            });

            console.log('Issueä½œæˆå®Œäº†:', issue.data.html_url);

      - name: Artifactã«çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: error-fix-results-${{ github.run_number }}
          path: |
            error_fix_results.txt
            error_fix_report.md
            backend/logs/*.log
          retention-days: 30

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          docker stop postgres redis || true
          docker rm postgres redis || true

      - name: æ¬¡å›å®Ÿè¡Œã¾ã§ã‚¹ãƒªãƒ¼ãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: false  # é€šå¸¸ã¯ç„¡åŠ¹ï¼ˆcronã§30åˆ†å¾Œã«å†å®Ÿè¡Œï¼‰
        run: |
          echo "æ¬¡å›å®Ÿè¡Œã¾ã§30åˆ†å¾…æ©Ÿ..."
          sleep 1800
