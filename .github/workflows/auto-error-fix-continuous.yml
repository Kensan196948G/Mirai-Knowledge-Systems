name: ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ5åˆ†é–“éš”ãƒ»ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰

on:
  # âœ… å–¶æ¥­æ™‚é–“ã®ã¿å®Ÿè¡Œï¼ˆæœˆ-é‡‘ã€9-18æ™‚ã®æ¯æ­£æ™‚ï¼‰
  # é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè£…ã«ã‚ˆã‚Šå®‰å…¨ã«å†æœ‰åŠ¹åŒ–ï¼ˆ2026-02-06ï¼‰
  schedule:
    - cron: '0 9-18 * * 1-5'  # æœˆ-é‡‘ã€9-18æ™‚ï¼ˆ10å›/æ—¥ï¼‰

  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ»æ¤œè¨¼ç”¨ï¼‰
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15ï¼‰'
        required: false
        default: '15'
      create_issue:
        description: 'Issueä½œæˆï¼ˆyes/noï¼‰'
        required: false
        default: 'yes'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  MAX_LOOPS: 15
  MKS_ENV: test
  MKS_SECRET_KEY: test-secret-key-for-ci
  MKS_JWT_SECRET_KEY: test-jwt-secret-key-for-ci
  MKS_CORS_ORIGINS: http://localhost:5100

jobs:
  auto-error-detection-and-fix:
    name: ã‚¨ãƒ©ãƒ¼è‡ªå‹•æ¤œçŸ¥ãƒ»ä¿®å¾©ï¼ˆ15å›ãƒ«ãƒ¼ãƒ—ï¼‰
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write
      issues: write  # Issueã®ä½œæˆã«å¿…è¦

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          playwright install --with-deps

      - name: PostgreSQLèµ·å‹•ï¼ˆDockerï¼‰
        run: |
          docker run -d \
            --name postgres \
            -e POSTGRES_USER=mks_user \
            -e POSTGRES_PASSWORD=mks_password \
            -e POSTGRES_DB=mks_db \
            -p 5432:5432 \
            postgres:16-alpine

          # PostgreSQLèµ·å‹•å¾…æ©Ÿ
          for i in {1..30}; do
            if docker exec postgres pg_isready -U mks_user; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      - name: Redisèµ·å‹•ï¼ˆDockerï¼‰
        run: |
          docker run -d \
            --name redis \
            -p 6379:6379 \
            redis:7-alpine

          # Redisèµ·å‹•å¾…æ©Ÿ
          sleep 5

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://mks_user:mks_password@localhost:5432/mks_db
          REDIS_URL: redis://localhost:6379/0
          MKS_ENV: test
          MKS_SECRET_KEY: test-secret-key-for-ci
          MKS_JWT_SECRET_KEY: test-jwt-secret-key-for-ci
          MKS_CORS_ORIGINS: http://localhost:5100
        run: |
          python -c "from app_v2 import db, app; app.app_context().push(); db.create_all(); print('Database initialized')" || echo "Database already exists"

      - name: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆ15å›ï¼‰
        id: error_fix_loop
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://mks_user:mks_password@localhost:5432/mks_db
          REDIS_URL: redis://localhost:6379/0
          PGHOST: localhost
          PGPORT: 5432
          MKS_PORT: 5100
          MKS_ENV: test
          MKS_SECRET_KEY: test-secret-key-for-ci
          MKS_JWT_SECRET_KEY: test-jwt-secret-key-for-ci
          MKS_CORS_ORIGINS: http://localhost:5100
          MKS_SKIP_HTTP_CHECK: true
        run: |
          echo "==================================="
          echo "ã‚¨ãƒ©ãƒ¼è‡ªå‹•æ¤œçŸ¥ãƒ»ä¿®å¾©é–‹å§‹"
          echo "æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°: ${{ github.event.inputs.max_loops || env.MAX_LOOPS }}"
          echo "==================================="
          echo ""

          # ãƒ«ãƒ¼ãƒ—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
          LOOP_COUNT=0
          MAX_LOOPS=${{ github.event.inputs.max_loops || env.MAX_LOOPS }}
          ERROR_COUNT=0
          FIX_COUNT=0

          # çµæœãƒ•ã‚¡ã‚¤ãƒ«
          RESULT_FILE="${GITHUB_WORKSPACE}/error_fix_results.txt"
          echo "# ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ­ã‚°" > "$RESULT_FILE"
          echo "å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')" >> "$RESULT_FILE"
          echo "æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°: ${MAX_LOOPS}" >> "$RESULT_FILE"
          echo "" >> "$RESULT_FILE"

          while [ $LOOP_COUNT -lt $MAX_LOOPS ]; do
            LOOP_COUNT=$((LOOP_COUNT + 1))
            echo "----------------------------------------"
            echo "ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT}/${MAX_LOOPS}"
            echo "----------------------------------------"
            echo "## ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT}/${MAX_LOOPS}" >> "$RESULT_FILE"

            # 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            echo "[STEP 1] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
            if python scripts/health_monitor.py > health_check.log 2>&1; then
              echo "âœ“ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
              cat health_check.log >> "$RESULT_FILE"
            else
              echo "âœ— ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
              ERROR_COUNT=$((ERROR_COUNT + 1))
              cat health_check.log >> "$RESULT_FILE"
            fi

            # 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ï¼‰
            echo "[STEP 2] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
            if pytest tests/ -v --tb=short > test_results.log 2>&1; then
              echo "âœ“ å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼"
              echo "### ãƒ†ã‚¹ãƒˆçµæœ: åˆæ ¼" >> "$RESULT_FILE"
            else
              echo "âœ— ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’æ¤œå‡º"
              ERROR_COUNT=$((ERROR_COUNT + 1))
              echo "### ãƒ†ã‚¹ãƒˆçµæœ: å¤±æ•—" >> "$RESULT_FILE"
              grep -A 3 "FAILED" test_results.log >> "$RESULT_FILE" || true

              # 3. è‡ªå‹•ä¿®å¾©è©¦è¡Œ
              echo "[STEP 3] è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œä¸­..."
              if python scripts/auto_fix_daemon.py --once >> "$RESULT_FILE" 2>&1; then
                echo "âœ“ è‡ªå‹•ä¿®å¾©å®Œäº†"
                FIX_COUNT=$((FIX_COUNT + 1))
              else
                echo "âœ— è‡ªå‹•ä¿®å¾©å¤±æ•—"
                echo "### è‡ªå‹•ä¿®å¾©: å¤±æ•—" >> "$RESULT_FILE"
              fi
            fi

            # 4. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
            echo "[STEP 4] ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªä¸­..."
            if [ -f logs/app.log ]; then
              ERROR_LINES=$(grep -i "error\|exception\|critical" logs/app.log | tail -10 || true)
              if [ -n "$ERROR_LINES" ]; then
                echo "âœ— ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º"
                ERROR_COUNT=$((ERROR_COUNT + 1))
                echo "### ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼:" >> "$RESULT_FILE"
                echo "$ERROR_LINES" >> "$RESULT_FILE"
              else
                echo "âœ“ ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãªã—"
              fi
            fi

            echo ""
            echo "ãƒ«ãƒ¼ãƒ— ${LOOP_COUNT} å®Œäº† - ã‚¨ãƒ©ãƒ¼: ${ERROR_COUNT}, ä¿®å¾©: ${FIX_COUNT}"
            echo "" >> "$RESULT_FILE"

            # æœ€å¾Œã®ãƒ«ãƒ¼ãƒ—ã§ãªã‘ã‚Œã°5ç§’å¾…æ©Ÿ
            if [ $LOOP_COUNT -lt $MAX_LOOPS ]; then
              sleep 5
            fi
          done

          echo "==================================="
          echo "ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©å®Œäº†"
          echo "ç·ãƒ«ãƒ¼ãƒ—å›æ•°: ${LOOP_COUNT}"
          echo "æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}"
          echo "ä¿®å¾©å®Ÿè¡Œå›æ•°: ${FIX_COUNT}"
          echo "==================================="

          # ã‚µãƒãƒªãƒ¼ã‚’çµæœãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 
          echo "" >> "$RESULT_FILE"
          echo "---" >> "$RESULT_FILE"
          echo "## ã‚µãƒãƒªãƒ¼" >> "$RESULT_FILE"
          echo "- ç·ãƒ«ãƒ¼ãƒ—å›æ•°: ${LOOP_COUNT}" >> "$RESULT_FILE"
          echo "- æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}" >> "$RESULT_FILE"
          echo "- ä¿®å¾©å®Ÿè¡Œå›æ•°: ${FIX_COUNT}" >> "$RESULT_FILE"

          # GitHubç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "error_count=${ERROR_COUNT}" >> $GITHUB_OUTPUT
          echo "fix_count=${FIX_COUNT}" >> $GITHUB_OUTPUT
          echo "loop_count=${LOOP_COUNT}" >> $GITHUB_OUTPUT

      - name: çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: generate_report
        run: |
          REPORT_FILE="${GITHUB_WORKSPACE}/error_fix_report.md"

          cat > "$REPORT_FILE" << 'REPORT_EOF'
          # ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

          **å®Ÿè¡Œæ—¥æ™‚:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼Run:** #${{ github.run_number }}
          **ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.sha }}

          ## ğŸ“Š å®Ÿè¡Œçµæœ

          | é …ç›® | å€¤ |
          |------|-----|
          | ãƒ«ãƒ¼ãƒ—å›æ•° | ${{ steps.error_fix_loop.outputs.loop_count }} / ${{ github.event.inputs.max_loops || env.MAX_LOOPS }} |
          | æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•° | ${{ steps.error_fix_loop.outputs.error_count }} |
          | ä¿®å¾©å®Ÿè¡Œå›æ•° | ${{ steps.error_fix_loop.outputs.fix_count }} |

          ## ğŸ“‹ è©³ç´°ãƒ­ã‚°

          REPORT_EOF

          # è©³ç´°ãƒ­ã‚°ã‚’è¿½åŠ 
          cat "${GITHUB_WORKSPACE}/error_fix_results.txt" >> "$REPORT_FILE" || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> "$REPORT_FILE"

          echo "report_path=${REPORT_FILE}" >> $GITHUB_OUTPUT

      - name: é‡è¤‡Issueç¢ºèª
        id: dedup
        if: always() && github.event.inputs.create_issue != 'no'
        uses: actions/github-script@v8
        with:
          script: |
            try {
              const today = new Date().toISOString().split('T')[0];
              const errorCount = '${{ steps.error_fix_loop.outputs.error_count }}';

              console.log(`[Dedup] Checking for duplicate issues on ${today}...`);
              console.log(`[Dedup] Error count: ${errorCount}`);

              // ã‚¨ãƒ©ãƒ¼æ•°ãŒ0ã®å ´åˆã¯é‡è¤‡ãƒã‚§ãƒƒã‚¯ä¸è¦ï¼ˆä½œæˆã—ãªã„ï¼‰
              if (errorCount === '0' || errorCount === '') {
                core.setOutput('duplicate', 'false');
                core.setOutput('skip_reason', 'no_errors');
                console.log('[Dedup] No errors detected. Skipping issue creation.');
                return;
              }

              // åŒæ—¥ã® auto-fix ãƒ©ãƒ™ãƒ«ä»˜ãIssueã‚’æ¤œç´¢
              console.log('[Dedup] Fetching existing issues with auto-fix label...');
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'auto-fix',
                state: 'open',
                per_page: 100
              });

              console.log(`[Dedup] Found ${issues.data.length} open issues with auto-fix label`);

              // åŒæ—¥ + åŒã˜ã‚¨ãƒ©ãƒ¼æ•°ã®IssueãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
              const duplicate = issues.data.find(i => {
                const titleMatch = i.title.includes(today) && i.title.includes(`ã‚¨ãƒ©ãƒ¼${errorCount}ä»¶`);
                if (titleMatch) {
                  console.log(`[Dedup] Potential duplicate: #${i.number} - ${i.title}`);
                }
                return titleMatch;
              });

              if (duplicate) {
                core.setOutput('duplicate', 'true');
                core.setOutput('skip_reason', 'duplicate_found');
                console.log(`[Dedup] âœ— Duplicate issue found: #${duplicate.number} - ${duplicate.title}`);
                console.log('[Dedup] Skipping issue creation to prevent duplicates.');
              } else {
                core.setOutput('duplicate', 'false');
                core.setOutput('skip_reason', 'none');
                console.log('[Dedup] âœ“ No duplicate issue found. Proceeding with issue creation.');
              }
            } catch (error) {
              // APIå¤±æ•—æ™‚ã¯ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•: Issueä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—
              console.error(`[Dedup] Error during duplicate check: ${error.message}`);
              core.setOutput('duplicate', 'true');
              core.setOutput('skip_reason', 'api_error');
              console.log('[Dedup] âš ï¸ Skipping issue creation due to API error (fail-safe).');
            }

      - name: GitHub Issueã«çµæœã‚’æŠ•ç¨¿
        # Issueä½œæˆæ¡ä»¶:
        # - always(): å‰ã‚¹ãƒ†ãƒƒãƒ—ã®å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
        # - create_issue != 'no': æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã§ã®ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½
        # - duplicate == 'false': é‡è¤‡Issueã§ã¯ãªã„
        # - skip_reason == 'none': ã‚¨ãƒ©ãƒ¼0ä»¶ã€é‡è¤‡ã€APIå¤±æ•—ã§ãªã„
        if: >-
          always() &&
          github.event.inputs.create_issue != 'no' &&
          steps.dedup.outputs.duplicate == 'false' &&
          steps.dedup.outputs.skip_reason == 'none'
        uses: actions/github-script@v8
        with:
          script: |
            const errorCount = '${{ steps.error_fix_loop.outputs.error_count }}';
            const fixCount = '${{ steps.error_fix_loop.outputs.fix_count }}';
            const loopCount = '${{ steps.error_fix_loop.outputs.loop_count }}';
            const maxLoops = '${{ github.event.inputs.max_loops || env.MAX_LOOPS }}';

            // ã‚µãƒãƒªãƒ¼ã®ã¿ã®Issueæœ¬æ–‡ï¼ˆ65KBåˆ¶é™å¯¾ç­–ï¼‰
            const reportBody = `# ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚:** ${new Date().toISOString()}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼Run:** #${{ github.run_number }}
            **ã‚³ãƒŸãƒƒãƒˆ:** \`${{ github.sha }}\`

            ## ğŸ“Š å®Ÿè¡Œçµæœ

            | é …ç›® | å€¤ |
            |------|-----|
            | ãƒ«ãƒ¼ãƒ—å›æ•° | ${loopCount} / ${maxLoops} |
            | æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•° | ${errorCount} |
            | ä¿®å¾©å®Ÿè¡Œå›æ•° | ${fixCount} |

            ## ğŸ“‹ è©³ç´°ãƒ­ã‚°

            è©³ç´°ãƒ­ã‚°ã¯ä»¥ä¸‹ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š

            ğŸ“¦ **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå**: \`error-fix-results-${{ github.run_number }}\`

            1. [Actions ã‚¿ãƒ–](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’é–‹ã
            2. ä¸‹éƒ¨ã®ã€ŒArtifactsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ \`error-fix-results-${{ github.run_number }}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. \`error_fix_report.md\` ã«å…¨ãƒ«ãƒ¼ãƒ—ã®è©³ç´°ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™

            ---

            ğŸ¤– Generated by [GitHub Actions Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            // Issueã‚¿ã‚¤ãƒˆãƒ«
            const title = errorCount > 0
              ? `[è‡ªå‹•ä¿®å¾©] ã‚¨ãƒ©ãƒ¼${errorCount}ä»¶æ¤œå‡ºãƒ»ä¿®å¾©${fixCount}ä»¶å®Ÿè¡Œ (${new Date().toISOString().split('T')[0]})`
              : `[è‡ªå‹•ä¿®å¾©] æ­£å¸¸å‹•ä½œç¢ºèª (${new Date().toISOString().split('T')[0]})`;

            // Issueãƒ©ãƒ™ãƒ«
            const labels = errorCount > 0 ? ['auto-fix', 'error-detected'] : ['auto-fix', 'healthy'];

            // Issueä½œæˆ
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: reportBody,
              labels: labels
            });

            console.log('Issueä½œæˆå®Œäº†:', issue.data.html_url);

      - name: Artifactã«çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: error-fix-results-${{ github.run_number }}
          path: |
            error_fix_results.txt
            error_fix_report.md
            backend/logs/*.log
          retention-days: 30

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          docker stop postgres redis || true
          docker rm postgres redis || true

      - name: æ¬¡å›å®Ÿè¡Œã¾ã§ã‚¹ãƒªãƒ¼ãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: false  # é€šå¸¸ã¯ç„¡åŠ¹ï¼ˆcronã§30åˆ†å¾Œã«å†å®Ÿè¡Œï¼‰
        run: |
          echo "æ¬¡å›å®Ÿè¡Œã¾ã§30åˆ†å¾…æ©Ÿ..."
          sleep 1800
