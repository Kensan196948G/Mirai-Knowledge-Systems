name: Post-merge Refinement Issue

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  create-refinement-issue:
    name: Create Refinement Issue
    # 5-layer loop prevention:
    # Layer 1: Only merged PRs
    # Layer 2: Skip if round-trip:3 (max iteration reached)
    # Layer 3: Skip bot-created PRs
    if: >-
      github.event.pull_request.merged == true &&
      !contains(github.event.pull_request.title, '[round-trip:3]') &&
      github.event.pull_request.user.login != 'github-actions[bot]'
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Extract round-trip iteration
        id: iteration
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if [[ "$TITLE" =~ \[round-trip:([0-9]+)\] ]]; then
            CURRENT=${BASH_REMATCH[1]}
          else
            CURRENT=0
          fi
          NEXT=$((CURRENT + 1))
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "next=$NEXT" >> $GITHUB_OUTPUT

          # Layer 4: Hard cap at 3 iterations
          if [ "$NEXT" -gt 3 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Loop limit (3) reached. Skipping issue creation."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # Layer 5: Duplicate issue detection
      - name: Check for duplicate issues
        if: steps.iteration.outputs.skip == 'false'
        id: dedup
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const prNumber = context.payload.pull_request.number;
              console.log(`[Dedup] Checking for duplicate issues for PR #${prNumber}...`);

              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'refinement-needed',
                state: 'open',
                per_page: 50
              });

              console.log(`[Dedup] Found ${issues.data.length} open refinement-needed issues`);

              const duplicate = issues.data.find(i =>
                i.body && i.body.includes(`Source-PR: #${prNumber}`)
              );

              if (duplicate) {
                core.setOutput('duplicate', 'true');
                console.log(`[Dedup] ✗ Duplicate issue found: #${duplicate.number}`);
                console.log('[Dedup] Skipping issue creation to prevent duplicates.');
              } else {
                core.setOutput('duplicate', 'false');
                console.log('[Dedup] ✓ No duplicate issue found. Proceeding with issue creation.');
              }
            } catch (error) {
              // API失敗時はフェイルセーフ: Issue作成を許可（重複リスクより見逃しリスクを優先）
              console.error(`[Dedup] Error during duplicate check: ${error.message}`);
              core.setOutput('duplicate', 'false');
              console.log('[Dedup] ⚠️ Proceeding with issue creation due to API error (fail-safe).');
            }

      - name: Get PR diff stats
        if: steps.iteration.outputs.skip == 'false' && steps.dedup.outputs.duplicate == 'false'
        id: diff
        run: |
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          FILES=$(git diff --name-only ${MERGE_SHA}^..${MERGE_SHA} 2>/dev/null || echo "unknown")
          STAT=$(git diff --stat ${MERGE_SHA}^..${MERGE_SHA} 2>/dev/null | tail -1 || echo "unknown")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "stat=$STAT" >> $GITHUB_OUTPUT

      - name: Create refinement issue
        if: steps.iteration.outputs.skip == 'false' && steps.dedup.outputs.duplicate == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const next = '${{ steps.iteration.outputs.next }}';
            const prTitle = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            const mergeSha = '${{ github.event.pull_request.merge_commit_sha }}';
            const files = `${{ steps.diff.outputs.files }}`;
            const stat = `${{ steps.diff.outputs.stat }}`;

            const body = [
              `## Refinement Request [round-trip:${next}]`,
              '',
              `**Source-PR**: #${prNumber}`,
              `**Author**: @${prAuthor}`,
              `**Merge SHA**: \`${mergeSha}\``,
              `**Iteration**: ${next} / 3`,
              '',
              '### Changed Files',
              '```',
              files,
              '```',
              `**Diff stats**: ${stat}`,
              '',
              '### Refinement Checklist',
              '- [ ] コードレビュー指摘の反映',
              '- [ ] テストカバレッジ確認（Python 80%+, JS 70%+）',
              '- [ ] Lint/フォーマットチェック（ruff check .）',
              '- [ ] セキュリティチェック（該当する場合）',
              '- [ ] ドキュメント更新（該当する場合）',
              '',
              '### Instructions for ClaudeCode',
              '1. このIssueの変更ファイルを確認',
              '2. テストカバレッジ不足があれば追加テスト作成',
              '3. コード品質の改善点があれば修正',
              `4. ブランチ名: \`refinement/${next}/pr-${prNumber}\``,
              `5. コミットメッセージに \`[round-trip:${next}]\` を含める`,
              `6. PRタイトルに \`[round-trip:${next}]\` を含める`,
              '',
              '---',
              '_Auto-generated by post-merge-notify workflow_'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[refinement] ${prTitle} [round-trip:${next}]`,
              body: body,
              labels: ['refinement-needed', 'round-trip']
            });

            console.log(`Created issue: ${issue.data.html_url}`);
