name: ğŸ¤– PRè‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©

on:
  workflow_run:
    workflows: ["Backend CI (Improved)", "Frontend Tests", "Mirai Knowledge Systems CI/CD"]
    types: [completed]
    branches-ignore: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  auto-fix-pr-errors:
    name: PRè‡ªå‹•ä¿®å¾©
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±ã‚’å–å¾—
        id: workflow_info
        run: |
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "workflow=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --break-system-packages black isort flake8 pytest
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt --break-system-packages
          fi

      - name: ğŸ” ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»è‡ªå‹•ä¿®å¾©
        id: auto_fix
        run: |
          echo "=== ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥é–‹å§‹ ==="

          # 1. Lintã‚¨ãƒ©ãƒ¼ä¿®å¾©
          echo "[STEP 1] Lintä¿®å¾©ä¸­..."
          black backend/ || true
          isort backend/ || true

          # 2. Import ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
          echo "[STEP 2] Import ã‚¨ãƒ©ãƒ¼ç¢ºèªä¸­..."
          python -c "import sys; sys.path.insert(0, 'backend'); from app_v2 import app" 2>&1 | tee import_errors.log || true

          # 3. æ§‹æ–‡ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
          echo "[STEP 3] æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ç¢ºèªä¸­..."
          python -m py_compile backend/app_v2.py 2>&1 | tee syntax_errors.log || true

          # 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆè»½é‡ãƒã‚§ãƒƒã‚¯ï¼‰
          echo "[STEP 4] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          cd backend
          pytest tests/unit/ -v --tb=short -x --maxfail=3 > ../test_results.log 2>&1 || true
          cd ..

          # 5. å¤‰æ›´ç¢ºèª
          if [ -n "$(git status --porcelain)" ]; then
            echo "fixed=true" >> $GITHUB_OUTPUT
            echo "ä¿®å¾©å®Ÿè¡Œï¼ˆå¤‰æ›´ã‚ã‚Šï¼‰"
            git status --short
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
            echo "ä¿®å¾©ä¸è¦ï¼ˆå¤‰æ›´ãªã—ï¼‰"
          fi

      - name: ğŸ’¾ ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.auto_fix.outputs.fixed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "fix: CIè‡ªå‹•ä¿®å¾© - Lint/Import ã‚¨ãƒ©ãƒ¼ä¿®æ­£" \
                     -m "" \
                     -m "è‡ªå‹•ä¿®å¾©å†…å®¹:" \
                     -m "- black ã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ" \
                     -m "- isort ã«ã‚ˆã‚‹ import æ•´ç†" \
                     -m "" \
                     -m "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ steps.workflow_info.outputs.workflow }}" \
                     -m "ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.workflow_info.outputs.branch }}" \
                     -m "" \
                     -m "ğŸ¤– Generated by GitHub Actions"
          git push

      - name: ğŸ’¬ PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆä¿®å¾©æˆåŠŸï¼‰
        if: steps.auto_fix.outputs.fixed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (!pr) {
              console.log('No PR found');
              return;
            }

            const comment = `ğŸ¤– **è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ**

            CI/CDãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸãŸã‚ã€ä»¥ä¸‹ã®ä¿®æ­£ã‚’è‡ªå‹•é©ç”¨ã—ã¾ã—ãŸï¼š

            âœ… **å®Ÿè¡Œæ¸ˆã¿ä¿®å¾©**:
            - Python ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆblackï¼‰
            - Import æ•´ç†ï¼ˆisortï¼‰

            ğŸ“‹ **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±**:
            - ãƒˆãƒªã‚¬ãƒ¼: ${{ steps.workflow_info.outputs.workflow }}
            - ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.workflow_info.outputs.branch }}
            - Run ID: #${{ steps.workflow_info.outputs.run_id }}

            å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãƒ†ã‚¹ãƒˆãŒå†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });

      - name: ğŸ’¬ PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆä¿®å¾©ä¸è¦ï¼‰
        if: steps.auto_fix.outputs.fixed == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (!pr) {
              console.log('No PR found');
              return;
            }

            const comment = `ğŸ¤– **è‡ªå‹•ä¿®å¾©ã‚’ç¢ºèªã—ã¾ã—ãŸ**

            CI/CDãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€è‡ªå‹•ä¿®å¾©å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

            âŒ **æ¤œå‡ºã•ã‚Œãªã‹ã£ãŸã‚¨ãƒ©ãƒ¼**:
            - Lint ã‚¨ãƒ©ãƒ¼ï¼ˆblack/isortï¼‰
            - Import ã‚¨ãƒ©ãƒ¼

            ğŸ” **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
            æ‰‹å‹•ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            ğŸ“‹ **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±**:
            - ãƒˆãƒªã‚¬ãƒ¼: ${{ steps.workflow_info.outputs.workflow }}
            - ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.workflow_info.outputs.branch }}
            - Run ID: #${{ steps.workflow_info.outputs.run_id }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });

      - name: ğŸ“Š ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-logs-${{ steps.workflow_info.outputs.branch }}-${{ github.run_number }}
          path: |
            import_errors.log
            syntax_errors.log
            test_results.log
          retention-days: 7
          if-no-files-found: ignore
