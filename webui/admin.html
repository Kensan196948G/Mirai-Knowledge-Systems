<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理画面 - 建設土木ナレッジシステム</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 28px;
    }

    .admin-panel {
      background: var(--surface-strong);
      border: 1px solid var(--line);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
    }

    .admin-panel h2 {
      font-family: "Shippori Mincho B1", serif;
      margin: 0 0 24px;
      font-size: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--steel);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      font-family: inherit;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .tag-input-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      min-height: 48px;
    }

    .tag-input-item {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--moss);
      color: #fff;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tag-input-item button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      line-height: 1;
    }

    .tag-input-field {
      border: none;
      outline: none;
      flex: 1;
      min-width: 120px;
      font-family: inherit;
    }

    .admin-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--line);
    }

    .data-table th {
      background: rgba(47, 75, 82, 0.08);
      font-weight: 600;
      color: var(--steel);
    }

    .data-table tr:hover {
      background: rgba(155, 181, 176, 0.08);
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      font-size: 12px;
      margin-right: 6px;
    }

    .action-btn.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-block;
    }

    .status-badge.active {
      background: rgba(79, 108, 91, 0.16);
      color: var(--moss);
    }

    .status-badge.draft {
      background: rgba(155, 181, 176, 0.2);
      color: var(--steel);
    }

    .message {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: none;
    }

    .message.success {
      background: rgba(79, 108, 91, 0.16);
      color: var(--moss);
      border: 1px solid rgba(79, 108, 91, 0.3);
    }

    .message.error {
      background: rgba(197, 83, 58, 0.16);
      color: var(--danger);
      border: 1px solid rgba(197, 83, 58, 0.3);
    }

    .message.show {
      display: block;
    }

    /* ユーザー情報表示スタイル */
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-right: 16px;
    }

    .user-name {
      font-weight: 600;
      color: var(--steel);
    }

    .user-dept {
      font-size: 12px;
      color: var(--muted);
    }

    .logout-btn {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--danger);
      background: transparent;
      color: var(--danger);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: var(--danger);
      color: #fff;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="brand">
      <div class="brand-mark">MK</div>
      <div>
        <h1>Mirai Construction Knowledge</h1>
        <span>管理画面</span>
      </div>
    </div>
    <div class="header-actions">
      <div class="user-info">
        <span class="user-name"></span>
        <span class="user-dept"></span>
        <button class="logout-btn" onclick="logout()">ログアウト</button>
      </div>
      <a href="index.html" class="cta ghost">ダッシュボードへ戻る</a>
    </div>
  </header>

  <div class="admin-container">
    <!-- メッセージエリア -->
    <div id="message" class="message"></div>

    <!-- 新規ナレッジ登録 -->
    <div id="new-knowledge" class="admin-panel">
      <h2>新規ナレッジ登録</h2>
      <form id="knowledgeForm">
        <div class="form-group">
          <label for="title">タイトル *</label>
          <input type="text" id="title" name="title" required />
        </div>

        <div class="form-group">
          <label for="summary">概要 *</label>
          <textarea id="summary" name="summary" required></textarea>
        </div>

        <div class="form-group">
          <label for="content">詳細内容</label>
          <textarea id="content" name="content"></textarea>
        </div>

        <div class="form-group">
          <label for="category">カテゴリ *</label>
          <select id="category" name="category" required>
            <option value="">選択してください</option>
            <option value="施工計画">施工計画</option>
            <option value="品質">品質</option>
            <option value="安全衛生">安全衛生</option>
            <option value="施工管理">施工管理</option>
            <option value="原価管理">原価管理</option>
            <option value="出来形管理">出来形管理</option>
          </select>
        </div>

        <div class="form-group">
          <label for="project">プロジェクト/工区</label>
          <input type="text" id="project" name="project" placeholder="例: B-03-3-2" />
        </div>

        <div class="form-group">
          <label for="owner">担当者/部門 *</label>
          <input type="text" id="owner" name="owner" required placeholder="例: 工事技術部" />
        </div>

        <div class="form-group">
          <label for="priority">優先度</label>
          <select id="priority" name="priority">
            <option value="low">低</option>
            <option value="medium" selected>中</option>
            <option value="high">高</option>
          </select>
        </div>

        <div class="form-group">
          <label>タグ</label>
          <div class="tag-input-container" id="tagContainer">
            <input type="text" class="tag-input-field" id="tagInput" placeholder="タグを入力してEnter" />
          </div>
        </div>

        <div class="admin-actions">
          <button type="submit" class="cta">登録する</button>
          <button type="reset" class="cta ghost">クリア</button>
        </div>
      </form>
    </div>

    <!-- ナレッジ一覧 -->
    <div id="knowledge-list" class="admin-panel">
      <h2>ナレッジ一覧</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>タイトル</th>
            <th>カテゴリ</th>
            <th>ステータス</th>
            <th>更新日</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="knowledgeList">
          <tr>
            <td colspan="6" style="text-align: center; color: var(--muted);">読み込み中...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 承認待ちアイテム -->
    <div id="approvals" class="admin-panel">
      <h2>承認待ちアイテム</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>タイトル</th>
            <th>種別</th>
            <th>申請者</th>
            <th>ステータス</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="approvalList">
          <tr>
            <td colspan="6" style="text-align: center; color: var(--muted);">読み込み中...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 監査ログ -->
    <div id="audit-logs" class="admin-panel">
      <h2>監査ログ</h2>
      <div class="audit-log-filters" style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
        <select id="auditUserFilter" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--line);">
          <option value="">全ユーザー</option>
        </select>
        <select id="auditActionFilter" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--line);">
          <option value="">全アクション</option>
          <option value="login">ログイン</option>
          <option value="knowledge">ナレッジ操作</option>
          <option value="search">検索</option>
          <option value="sop">SOP操作</option>
        </select>
        <select id="auditStatusFilter" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--line);">
          <option value="">全ステータス</option>
          <option value="success">成功</option>
          <option value="failure">失敗</option>
        </select>
        <button onclick="loadAuditLogs()" class="cta ghost" style="padding: 8px 16px;">検索</button>
        <button onclick="loadAuditLogStats()" class="cta ghost" style="padding: 8px 16px;">統計表示</button>
      </div>
      <div id="auditLogStats" style="display: none; margin-bottom: 16px; padding: 16px; background: var(--surface); border-radius: 12px;">
        <!-- 統計情報がここに表示される -->
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>日時</th>
            <th>ユーザー</th>
            <th>アクション</th>
            <th>リソース</th>
            <th>ステータス</th>
            <th>IPアドレス</th>
          </tr>
        </thead>
        <tbody id="auditLogList">
          <tr>
            <td colspan="6" style="text-align: center; color: var(--muted);">読み込み中...</td>
          </tr>
        </tbody>
      </table>
      <div id="auditLogPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;">
        <!-- ページネーションがここに表示される -->
      </div>
    </div>
  </div>

  <script>
    // 動的にAPIベースURLを設定（localhost、IPアドレス、ホスト名に対応）
    const API_BASE = `${window.location.protocol}//${window.location.hostname}:${window.location.port || '5000'}/api/v1`;
    let selectedTags = [];

    // 本番環境判定
    const IS_PRODUCTION = (() => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('env') === 'production') return true;
      if (urlParams.get('env') === 'development') return false;
      const envSetting = localStorage.getItem('MKS_ENV');
      if (envSetting === 'production') return true;
      if (envSetting === 'development') return false;
      const hostname = window.location.hostname;
      return hostname !== 'localhost' && hostname !== '127.0.0.1';
    })();

    // セキュアロガー（本番環境ではログ出力を抑制）
    const logger = {
      log: (...args) => { if (!IS_PRODUCTION) console.log(...args); },
      warn: (...args) => { if (!IS_PRODUCTION) logger.warn(...args); },
      error: (...args) => { logger.error(...args); },
      debug: (...args) => { if (!IS_PRODUCTION) console.debug(...args); }
    };

    // ============================================================
    // 認証管理
    // ============================================================

    // 認証チェック
    function checkAuth() {
      const token = localStorage.getItem('access_token');
      logger.log('[AUTH] Checking authentication. Token exists:', token ? 'YES' : 'NO');
      if (!token) {
        logger.log('[AUTH] No token found. Redirecting to login...');
        window.location.href = '/login.html';
        return false;
      }
      logger.log('[AUTH] Token found. Length:', token.length);
      return true;
    }

    // ログアウト
    function logout() {
      logger.log('[AUTH] Logging out...');
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    // ユーザー情報取得
    function getCurrentUser() {
      const userStr = localStorage.getItem('user');
      if (userStr) {
        try {
          return JSON.parse(userStr);
        } catch (e) {
          logger.error('[AUTH] Failed to parse user data:', e);
          return null;
        }
      }
      return null;
    }

    // ユーザー情報表示
    function displayUserInfo() {
      const user = getCurrentUser();
      logger.log('[AUTH] Displaying user info:', user);
      if (!user) return;

      const userNameEl = document.querySelector('.user-name');
      const userDeptEl = document.querySelector('.user-dept');

      if (userNameEl) {
        userNameEl.textContent = user.full_name || user.username || '';
      }
      if (userDeptEl) {
        userDeptEl.textContent = user.department || '';
      }
    }

    // トークンリフレッシュ関数
    async function refreshAccessToken() {
      const refreshToken = localStorage.getItem('refresh_token');

      if (!refreshToken) {
        logger.log('[AUTH] No refresh token available');
        return false;
      }

      try {
        logger.log('[AUTH] Refreshing access token...');
        const response = await fetch(`${API_BASE}/auth/refresh`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${refreshToken}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            localStorage.setItem('access_token', result.data.access_token);
            logger.log('[AUTH] Access token refreshed successfully');
            return true;
          }
        }

        logger.log('[AUTH] Token refresh failed');
        return false;
      } catch (error) {
        logger.error('[AUTH] Token refresh error:', error);
        return false;
      }
    }

    // 認証付きfetch関数
    async function fetchAPI(endpoint, options = {}) {
      const token = localStorage.getItem('access_token');

      logger.log('[API] Calling:', endpoint);
      logger.log('[API] Token exists:', token ? 'YES' : 'NO');

      if (!token && !endpoint.includes('/auth/')) {
        logger.log('[API] No token for non-auth endpoint. Redirecting...');
        window.location.href = '/login.html';
        throw new Error('No authentication token');
      }

      try {
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };

        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
          logger.log('[API] Authorization header added');
        }

        let response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers
        });

        logger.log('[API] Response status:', response.status);

        // 認証エラー（401）の場合、トークンリフレッシュを試行
        if (response.status === 401 && !endpoint.includes('/auth/')) {
          logger.log('[API] 401 Unauthorized. Attempting token refresh...');

          const refreshed = await refreshAccessToken();

          if (refreshed) {
            // リフレッシュ成功 → リクエストをリトライ
            logger.log('[API] Retrying request with new token...');
            const newToken = localStorage.getItem('access_token');
            headers['Authorization'] = `Bearer ${newToken}`;

            response = await fetch(`${API_BASE}${endpoint}`, {
              ...options,
              headers
            });

            logger.log('[API] Retry response status:', response.status);
          } else {
            // リフレッシュ失敗 → ログアウト
            logger.log('[API] Token refresh failed. Logging out...');
            logout();
            throw new Error('Authentication failed');
          }
        }

        // 権限エラー（403）
        if (response.status === 403) {
          logger.error('[API] 403 Forbidden.');
          showMessage('この操作を実行する権限がありません。', 'error');
          throw new Error('Permission denied');
        }

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        logger.error('[API] Error:', error);
        throw error;
      }
    }

    // ============================================================
    // ユーティリティ関数
    // ============================================================

    function showMessage(text, type = 'success') {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type} show`;

      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 5000);
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
    }

    // ============================================================
    // タグ入力機能
    // ============================================================

    // XSS対策: DOM API使用によるタグレンダリング
    function renderTags() {
      const container = document.getElementById('tagContainer');
      const inputField = container.querySelector('.tag-input-field');

      // 既存のタグ要素を削除（入力フィールドは保持）
      const existingTags = container.querySelectorAll('.tag-input-item');
      existingTags.forEach(tag => tag.remove());

      // 新しいタグ要素を作成
      selectedTags.forEach((tag, index) => {
        const tagSpan = document.createElement('span');
        tagSpan.className = 'tag-input-item';
        tagSpan.textContent = tag + ' ';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = '×';
        removeBtn.addEventListener('click', () => removeTag(index));

        tagSpan.appendChild(removeBtn);
        container.insertBefore(tagSpan, inputField);
      });
    }

    function addTag(tag) {
      const trimmedTag = tag.trim();
      if (trimmedTag && !selectedTags.includes(trimmedTag)) {
        selectedTags.push(trimmedTag);
        renderTags();
      }
    }

    function removeTag(index) {
      selectedTags.splice(index, 1);
      renderTags();
    }

    function handleTagInput(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addTag(e.target.value);
        e.target.value = '';
      }
    }

    // 初期化
    document.getElementById('tagInput').addEventListener('keypress', handleTagInput);

    // ============================================================
    // ナレッジ登録
    // ============================================================

    document.getElementById('knowledgeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title'),
        summary: formData.get('summary'),
        content: formData.get('content') || formData.get('summary'),
        category: formData.get('category'),
        project: formData.get('project'),
        owner: formData.get('owner'),
        priority: formData.get('priority'),
        tags: selectedTags
      };

      try {
        const result = await fetchAPI('/knowledge', {
          method: 'POST',
          body: JSON.stringify(data)
        });

        if (result.success) {
          showMessage('ナレッジを登録しました！', 'success');
          e.target.reset();
          selectedTags = [];
          renderTags();
          loadKnowledge();
        } else {
          showMessage('登録に失敗しました: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('エラーが発生しました: ' + error.message, 'error');
      }
    });

    // ============================================================
    // データ読み込み
    // ============================================================

    // XSS対策: DOM API使用によるナレッジ一覧レンダリング
    async function loadKnowledge() {
      try {
        const result = await fetchAPI('/knowledge');

        if (result.success) {
          const tbody = document.getElementById('knowledgeList');
          tbody.textContent = ''; // 既存の内容をクリア

          if (result.data.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 6;
            td.style.textAlign = 'center';
            td.style.color = 'var(--muted)';
            td.textContent = 'データがありません';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }

          result.data.forEach(k => {
            const tr = document.createElement('tr');

            // ID
            const tdId = document.createElement('td');
            tdId.textContent = k.id;
            tr.appendChild(tdId);

            // タイトル
            const tdTitle = document.createElement('td');
            tdTitle.textContent = k.title;
            tr.appendChild(tdTitle);

            // カテゴリ
            const tdCategory = document.createElement('td');
            tdCategory.textContent = k.category;
            tr.appendChild(tdCategory);

            // ステータス
            const tdStatus = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge ${k.status}`;
            statusBadge.textContent = k.status === 'approved' ? '承認済み' : '下書き';
            tdStatus.appendChild(statusBadge);
            tr.appendChild(tdStatus);

            // 更新日
            const tdDate = document.createElement('td');
            tdDate.textContent = formatDate(k.updated_at);
            tr.appendChild(tdDate);

            // アクション
            const tdActions = document.createElement('td');
            const viewBtn = document.createElement('button');
            viewBtn.className = 'action-btn';
            viewBtn.textContent = '詳細';
            viewBtn.addEventListener('click', () => viewKnowledge(k.id));

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn danger';
            deleteBtn.textContent = '削除';
            deleteBtn.addEventListener('click', () => deleteKnowledge(k.id));

            tdActions.appendChild(viewBtn);
            tdActions.appendChild(deleteBtn);
            tr.appendChild(tdActions);

            tbody.appendChild(tr);
          });
        }
      } catch (error) {
        logger.error('Failed to load knowledge:', error);
      }
    }

    // XSS対策: DOM API使用による承認一覧レンダリング
    async function loadApprovals() {
      try {
        const result = await fetchAPI('/approvals');

        if (result.success) {
          const tbody = document.getElementById('approvalList');
          tbody.textContent = ''; // 既存の内容をクリア

          if (result.data.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 6;
            td.style.textAlign = 'center';
            td.style.color = 'var(--muted)';
            td.textContent = 'データがありません';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }

          result.data.forEach(a => {
            const tr = document.createElement('tr');

            // ID
            const tdId = document.createElement('td');
            tdId.textContent = a.id;
            tr.appendChild(tdId);

            // タイトル
            const tdTitle = document.createElement('td');
            tdTitle.textContent = a.title;
            tr.appendChild(tdTitle);

            // タイプ
            const tdType = document.createElement('td');
            tdType.textContent = a.type;
            tr.appendChild(tdType);

            // 申請者
            const tdRequester = document.createElement('td');
            tdRequester.textContent = a.requester;
            tr.appendChild(tdRequester);

            // ステータス
            const tdStatus = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge ${a.status}`;
            statusBadge.textContent = a.status === 'pending' ? '承認待ち' : a.status === 'reviewing' ? '確認中' : a.status;
            tdStatus.appendChild(statusBadge);
            tr.appendChild(tdStatus);

            // アクション
            const tdActions = document.createElement('td');
            if (a.status === 'pending' || a.status === 'reviewing') {
              const approveBtn = document.createElement('button');
              approveBtn.className = 'action-btn';
              approveBtn.textContent = '承認';
              approveBtn.addEventListener('click', () => approveItem(a.id));

              const rejectBtn = document.createElement('button');
              rejectBtn.className = 'action-btn danger';
              rejectBtn.textContent = '却下';
              rejectBtn.addEventListener('click', () => rejectItem(a.id));

              tdActions.appendChild(approveBtn);
              tdActions.appendChild(rejectBtn);
            } else {
              tdActions.textContent = '完了';
            }
            tr.appendChild(tdActions);

            tbody.appendChild(tr);
          });
        }
      } catch (error) {
        logger.error('Failed to load approvals:', error);
      }
    }

    // ============================================================
    // アクション関数
    // ============================================================

    function viewKnowledge(id) {
      // 詳細画面への遷移（実装は省略）
      alert(`ナレッジID ${id} の詳細を表示（未実装）`);
    }

    async function deleteKnowledge(id) {
      if (!confirm('このナレッジを削除しますか？')) {
        return;
      }

      showMessage('削除機能は未実装です', 'error');
    }

    async function approveItem(id) {
      if (!confirm('このアイテムを承認しますか？')) {
        return;
      }

      // 現在のユーザー情報を取得
      const user = getCurrentUser();
      const approver = user ? (user.full_name || user.username) : '管理者';

      try {
        const result = await fetchAPI(`/approvals/${id}/approve`, {
          method: 'POST',
          body: JSON.stringify({
            approver: approver,
            comment: 'Web管理画面から承認'
          })
        });

        if (result.success) {
          showMessage('承認しました', 'success');
          loadApprovals();
        } else {
          showMessage('承認に失敗しました', 'error');
        }
      } catch (error) {
        showMessage('エラーが発生しました: ' + error.message, 'error');
      }
    }

    async function rejectItem(id) {
      const reason = prompt('却下理由を入力してください:');
      if (!reason) {
        return;
      }

      // 現在のユーザー情報を取得
      const user = getCurrentUser();
      const approver = user ? (user.full_name || user.username) : '管理者';

      try {
        const result = await fetchAPI(`/approvals/${id}/reject`, {
          method: 'POST',
          body: JSON.stringify({
            approver: approver,
            reason: reason
          })
        });

        if (result.success) {
          showMessage('却下しました', 'success');
          loadApprovals();
        } else {
          showMessage('却下に失敗しました', 'error');
        }
      } catch (error) {
        showMessage('エラーが発生しました: ' + error.message, 'error');
      }
    }

    // ============================================================
    // 監査ログ機能
    // ============================================================

    let currentAuditPage = 1;

    async function loadAuditLogs(page = 1) {
      currentAuditPage = page;
      const token = localStorage.getItem('access_token');
      if (!token) return;

      const userFilter = document.getElementById('auditUserFilter').value;
      const actionFilter = document.getElementById('auditActionFilter').value;
      const statusFilter = document.getElementById('auditStatusFilter').value;

      let url = `${API_BASE}/logs/access?page=${page}&per_page=20`;
      if (userFilter) url += `&user_id=${userFilter}`;
      if (actionFilter) url += `&action=${actionFilter}`;
      if (statusFilter) url += `&status=${statusFilter}`;

      try {
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 403) {
            logger.log('[AUDIT] 管理者権限が必要です');
            const tbody = document.getElementById('auditLogList');
            tbody.innerHTML = '';
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 6;
            td.style.textAlign = 'center';
            td.style.color = 'var(--muted)';
            td.textContent = '管理者権限が必要です';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }
          throw new Error('ログの取得に失敗しました');
        }

        const data = await response.json();
        renderAuditLogs(data.logs);
        renderAuditPagination(data.pagination);
        logger.log('[AUDIT] ログを取得しました:', data.logs.length, '件');

      } catch (error) {
        logger.error('[AUDIT] エラー:', error);
        const tbody = document.getElementById('auditLogList');
        tbody.innerHTML = '';
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.style.textAlign = 'center';
        td.style.color = 'var(--error)';
        td.textContent = 'エラー: ' + error.message;
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    function renderAuditLogs(logs) {
      const tbody = document.getElementById('auditLogList');
      tbody.innerHTML = '';

      if (logs.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.style.textAlign = 'center';
        td.style.color = 'var(--muted)';
        td.textContent = 'ログがありません';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      logs.forEach(log => {
        const tr = document.createElement('tr');

        // 日時
        const tdTime = document.createElement('td');
        const timestamp = new Date(log.timestamp);
        tdTime.textContent = timestamp.toLocaleString('ja-JP');
        tdTime.style.fontSize = '12px';
        tr.appendChild(tdTime);

        // ユーザー
        const tdUser = document.createElement('td');
        tdUser.textContent = log.username || 'Unknown';
        tr.appendChild(tdUser);

        // アクション
        const tdAction = document.createElement('td');
        tdAction.textContent = log.action || '-';
        tr.appendChild(tdAction);

        // リソース
        const tdResource = document.createElement('td');
        tdResource.textContent = log.resource ? `${log.resource}${log.resource_id ? '/' + log.resource_id : ''}` : '-';
        tr.appendChild(tdResource);

        // ステータス
        const tdStatus = document.createElement('td');
        const statusBadge = document.createElement('span');
        statusBadge.style.padding = '2px 8px';
        statusBadge.style.borderRadius = '4px';
        statusBadge.style.fontSize = '11px';
        if (log.status === 'success') {
          statusBadge.style.background = 'var(--moss)';
          statusBadge.style.color = '#fff';
          statusBadge.textContent = '成功';
        } else if (log.status === 'failure') {
          statusBadge.style.background = 'var(--error)';
          statusBadge.style.color = '#fff';
          statusBadge.textContent = '失敗';
        } else {
          statusBadge.textContent = log.status || '-';
        }
        tdStatus.appendChild(statusBadge);
        tr.appendChild(tdStatus);

        // IPアドレス
        const tdIp = document.createElement('td');
        tdIp.textContent = log.ip_address || '-';
        tdIp.style.fontSize = '12px';
        tr.appendChild(tdIp);

        tbody.appendChild(tr);
      });
    }

    function renderAuditPagination(pagination) {
      const container = document.getElementById('auditLogPagination');
      container.innerHTML = '';

      if (pagination.total_pages <= 1) return;

      // 前へボタン
      if (pagination.page > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'cta ghost';
        prevBtn.style.padding = '4px 12px';
        prevBtn.textContent = '前へ';
        prevBtn.addEventListener('click', () => loadAuditLogs(pagination.page - 1));
        container.appendChild(prevBtn);
      }

      // ページ番号
      const pageInfo = document.createElement('span');
      pageInfo.style.padding = '4px 12px';
      pageInfo.textContent = `${pagination.page} / ${pagination.total_pages}`;
      container.appendChild(pageInfo);

      // 次へボタン
      if (pagination.page < pagination.total_pages) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'cta ghost';
        nextBtn.style.padding = '4px 12px';
        nextBtn.textContent = '次へ';
        nextBtn.addEventListener('click', () => loadAuditLogs(pagination.page + 1));
        container.appendChild(nextBtn);
      }
    }

    async function loadAuditLogStats() {
      const token = localStorage.getItem('access_token');
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/logs/access/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('統計の取得に失敗しました');
        }

        const data = await response.json();
        renderAuditStats(data);

      } catch (error) {
        logger.error('[AUDIT] 統計エラー:', error);
      }
    }

    function renderAuditStats(stats) {
      const container = document.getElementById('auditLogStats');
      container.style.display = 'block';
      container.innerHTML = '';

      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(150px, 1fr))';
      grid.style.gap = '16px';

      const items = [
        { label: '総ログ数', value: stats.total_logs },
        { label: '今日のログ', value: stats.today_logs },
        { label: '今週のログ', value: stats.week_logs },
        { label: '成功', value: stats.by_status?.success || 0 },
        { label: '失敗', value: stats.by_status?.failure || 0 }
      ];

      items.forEach(item => {
        const card = document.createElement('div');
        card.style.textAlign = 'center';
        card.style.padding = '12px';
        card.style.background = '#fff';
        card.style.borderRadius = '8px';

        const valueEl = document.createElement('div');
        valueEl.style.fontSize = '24px';
        valueEl.style.fontWeight = 'bold';
        valueEl.style.color = 'var(--accent)';
        valueEl.textContent = item.value.toLocaleString();
        card.appendChild(valueEl);

        const labelEl = document.createElement('div');
        labelEl.style.fontSize = '12px';
        labelEl.style.color = 'var(--muted)';
        labelEl.textContent = item.label;
        card.appendChild(labelEl);

        grid.appendChild(card);
      });

      container.appendChild(grid);

      // アクティブユーザー
      if (stats.top_active_users && stats.top_active_users.length > 0) {
        const userSection = document.createElement('div');
        userSection.style.marginTop = '16px';

        const userTitle = document.createElement('h4');
        userTitle.style.margin = '0 0 8px';
        userTitle.textContent = 'アクティブユーザー（上位5名）';
        userSection.appendChild(userTitle);

        const userList = document.createElement('ul');
        userList.style.margin = '0';
        userList.style.paddingLeft = '20px';

        stats.top_active_users.forEach(user => {
          const li = document.createElement('li');
          li.textContent = `${user.username}: ${user.action_count}件`;
          userList.appendChild(li);
        });

        userSection.appendChild(userList);
        container.appendChild(userSection);
      }
    }

    async function loadUserList() {
      const token = localStorage.getItem('access_token');
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const users = await response.json();
          const select = document.getElementById('auditUserFilter');
          users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.username;
            select.appendChild(option);
          });
        }
      } catch (error) {
        logger.error('[AUDIT] ユーザーリスト取得エラー:', error);
      }
    }

    // ============================================================
    // 初期化
    // ============================================================

    document.addEventListener('DOMContentLoaded', () => {
      logger.log('管理画面 - 初期化中...');

      // 認証チェック
      if (!checkAuth()) {
        return; // 認証失敗時は処理を中断
      }

      // ユーザー情報表示
      displayUserInfo();

      // データのロード
      loadKnowledge();
      loadApprovals();

      // 監査ログのロード（管理者のみ）
      loadUserList();
      loadAuditLogs();

      logger.log('管理画面 - 初期化完了！');

      // URLハッシュをチェックして該当セクションにスクロール
      handleHashNavigation();
    });

    // ハッシュ変更時も対応
    window.addEventListener('hashchange', handleHashNavigation);

    /**
     * URLハッシュに基づいてセクションにスクロール
     */
    function handleHashNavigation() {
      const hash = window.location.hash.substring(1); // '#approvals' -> 'approvals'
      if (hash) {
        const targetElement = document.getElementById(hash);
        if (targetElement) {
          setTimeout(() => {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            logger.log(`セクション「${hash}」にスクロールしました`);
          }, 1500); // データロード完了を待つ（1.5秒）
        }
      }
    }
  </script>
  <script src="actions.js"></script>
</body>

</html>