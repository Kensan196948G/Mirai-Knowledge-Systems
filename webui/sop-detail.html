<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SOP詳細 - 建設土木ナレッジシステム</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="header">
      <div class="brand reveal">
        <div class="brand-mark">MK</div>
        <div>
          <h1>Mirai Construction Knowledge</h1>
          <span>○○○○建設工業株式会社 技術本部 / 全支店・管轄施工現場</span>
        </div>
      </div>
      <nav class="top-nav reveal delay-1">
        <a href="index.html">現場ダッシュボード</a>
        <a href="#" onclick="openSearchModal(); return false;">ナレッジ検索</a>
        <a href="admin.html" data-required-role="admin">管理画面</a>
      </nav>
      <div class="header-actions reveal delay-2">
        <button class="icon-button" onclick="window.history.back()" title="戻る">
          ←
        </button>
        <button class="icon-button" onclick="openSearchModal()" title="高度な検索">
          🔍
        </button>
        <button class="icon-button notification-bell" onclick="openNotificationPanel()" title="通知">
          🔔
          <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
        </button>
        <button class="icon-button" onclick="openSettingsPanel()" title="設定">
          ⚙️
        </button>
        <span class="chip" id="sopNumber">SOP番号 --</span>
        <span class="chip" id="sopVersion">バージョン --</span>
        <button class="cta" onclick="downloadSOP()">ダウンロード</button>
        <button class="cta secondary" onclick="printChecklist()">チェックリスト印刷</button>
      </div>
    </header>

    <main class="page">
      <!-- パンくずリスト -->
      <nav class="breadcrumb-nav-enhanced reveal" aria-label="パンくずリスト">
        <ol class="breadcrumb-enhanced" id="breadcrumbList">
          <li>
            <span class="breadcrumb-icon">🏠</span>
            <a href="index.html">ホーム</a>
          </li>
          <li>
            <span class="breadcrumb-icon">📋</span>
            <a href="index.html#sop">SOP一覧</a>
          </li>
          <li class="breadcrumb-current" aria-current="page">
            <span class="breadcrumb-icon">📄</span>
            <span>詳細</span>
          </li>
        </ol>
      </nav>

      <aside class="sidebar reveal delay-1">
        <div class="nav-section">
          <div class="nav-title">ナビゲーション</div>
          <div class="nav-item">
            <a href="#overview"><strong>概要</strong></a>
          </div>
          <div class="nav-item">
            <a href="#procedure"><strong>手順</strong></a>
          </div>
          <div class="nav-item">
            <a href="#checklist"><strong>チェックリスト</strong></a>
          </div>
          <div class="nav-item">
            <a href="#warnings"><strong>注意事項</strong></a>
          </div>
          <div class="nav-item">
            <a href="#versions"><strong>改訂履歴</strong></a>
          </div>
          <div class="nav-item">
            <a href="#related-sop"><strong>関連SOP</strong></a>
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">アクション</div>
          <button class="cta ghost" onclick="startInspectionRecord()">
            📋 実施記録開始
          </button>
          <button class="cta ghost" onclick="downloadPDF('sop')">
            📥 PDF保存
          </button>
          <button class="cta ghost" onclick="shareSOP()">
            🔗 共有
          </button>
        </div>
      </aside>

      <section class="main">
        <!-- ローディング表示 -->
        <div id="loadingIndicator" class="loading-overlay">
          <div class="loading-spinner"></div>
          <p>読み込み中...</p>
        </div>

        <!-- エラー表示 -->
        <div id="errorMessage" class="error-message" style="display: none;">
          <strong>エラー:</strong> <span id="errorText"></span>
          <button onclick="retryLoadSOP()">再試行</button>
        </div>

        <!-- 詳細ヒーロー -->
        <section class="detail-hero reveal" id="overview">
          <h2 class="detail-title" id="sopTitle">SOP タイトル</h2>
          <div class="meta-row" id="sopMeta">
            <!-- 動的に挿入 -->
          </div>
          <div class="knowledge-tags" id="sopTags">
            <!-- 動的に挿入 -->
          </div>
          <div class="cta-group">
            <button class="cta ghost" onclick="window.history.back()">← 戻る</button>
            <button class="cta secondary" onclick="editSOP()" data-required-role="quality_assurance">改訂提案</button>
            <button class="cta" onclick="submitDistribution('sop')">配信申請</button>
          </div>
        </section>

        <!-- 詳細グリッド -->
        <section class="detail-grid reveal delay-1">
          <!-- 概要 -->
          <div class="detail-card">
            <h4>目的</h4>
            <div id="sopPurpose">
              <!-- 動的に挿入 -->
            </div>
          </div>

          <!-- 適用範囲 -->
          <div class="detail-card">
            <h4>適用範囲</h4>
            <div id="sopScope">
              <!-- 動的に挿入 -->
            </div>
          </div>

          <!-- バージョン情報 -->
          <div class="detail-card">
            <h4>バージョン情報</h4>
            <table class="table">
              <tbody id="versionInfo">
                <!-- 動的に挿入 -->
              </tbody>
            </table>
          </div>

          <!-- 手順 -->
          <div class="detail-card" id="procedure" style="grid-column: 1 / -1;">
            <h4>作業手順</h4>
            <div id="sopProcedure" class="step-list">
              <!-- 動的に挿入 -->
            </div>
          </div>

          <!-- チェックリスト -->
          <div class="detail-card" id="checklist" style="grid-column: 1 / -1;">
            <h4>チェックリスト</h4>
            <div id="sopChecklist" class="checklist">
              <!-- 動的に挿入 -->
            </div>
            <button class="cta secondary" onclick="printChecklist()" style="margin-top: 15px;">
              チェックリストを印刷
            </button>
          </div>

          <!-- 注意事項 -->
          <div class="detail-card" id="warnings" style="grid-column: 1 / -1;">
            <h4>注意事項・安全対策</h4>
            <div id="sopWarnings" class="list-dense">
              <!-- 動的に挿入 -->
            </div>
          </div>

          <!-- 必要資材・工具 -->
          <div class="detail-card">
            <h4>必要資材・工具</h4>
            <div id="sopEquipment" class="info-grid">
              <!-- 動的に挿入 -->
            </div>
          </div>

          <!-- 所要時間 -->
          <div class="detail-card">
            <h4>標準所要時間</h4>
            <div class="stat-grid">
              <div class="stat-card">
                <div>準備時間</div>
                <strong id="prepTime">--</strong>
                <small>分</small>
              </div>
              <div class="stat-card">
                <div>作業時間</div>
                <strong id="workTime">--</strong>
                <small>分</small>
              </div>
              <div class="stat-card">
                <div>合計</div>
                <strong id="totalTime">--</strong>
                <small>分</small>
              </div>
            </div>
          </div>

          <!-- 実施記録フォーム -->
          <div class="detail-card" id="record-form" style="grid-column: 1 / -1; display: none;">
            <h4>実施記録入力</h4>
            <form id="inspectionForm">
              <div class="field">
                <label>実施日時 <span class="required">*</span></label>
                <input type="datetime-local" id="recordDate" required>
              </div>
              <div class="field">
                <label>実施者 <span class="required">*</span></label>
                <input type="text" id="recordWorker" required>
              </div>
              <div class="field">
                <label>所属・現場</label>
                <input type="text" id="recordProject">
              </div>
              <div class="field">
                <label>実施内容</label>
                <textarea id="recordContent" rows="4"></textarea>
              </div>
              <div class="field">
                <label>チェック項目</label>
                <div id="recordChecklist">
                  <!-- 動的に挿入 -->
                </div>
              </div>
              <div class="field">
                <label>備考・特記事項</label>
                <textarea id="recordNotes" rows="3"></textarea>
              </div>
              <div class="modal-actions">
                <button type="button" class="cta ghost" onclick="cancelRecord()">キャンセル</button>
                <button type="submit" class="cta">記録を保存</button>
              </div>
            </form>
          </div>

          <!-- 改訂履歴 -->
          <div class="detail-card" id="versions" style="grid-column: 1 / -1;">
            <h4>改訂履歴</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>バージョン</th>
                  <th>改訂日</th>
                  <th>改訂内容</th>
                  <th>担当者</th>
                  <th>アクション</th>
                </tr>
              </thead>
              <tbody id="revisionHistory">
                <!-- 動的に挿入 -->
              </tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- 右サイドバー -->
      <aside class="rail reveal delay-1">
        <div>
          <h3 id="related-sop">関連SOP</h3>
          <div id="relatedSOPList">
            <!-- 動的に挿入 -->
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h3>適用現場</h3>
          <div id="applicableSites" class="status-list">
            <!-- 動的に挿入 -->
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h3>承認状況</h3>
          <div class="flow" id="approvalFlow">
            <!-- 動的に挿入 -->
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h3>実施統計</h3>
          <div class="stat-grid">
            <div class="stat-card">
              <div>実施回数</div>
              <strong id="executionCount">0</strong>
              <small>回</small>
            </div>
            <div class="stat-card">
              <div>適合率</div>
              <strong id="complianceRate">0</strong>
              <small>%</small>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <button class="floating" onclick="scrollToTop()">↑ トップへ</button>

    <!-- Socket.IO Client Library (jsDelivr経由 - CSP対応) -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js"></script>

    <!-- 共有モーダル -->
    <div id="shareModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>SOP共有</h2>
          <button class="modal-close" onclick="closeShareModal()">&times;</button>
        </div>
        <div class="field">
          <label>共有URL</label>
          <input type="text" id="shareUrl" readonly style="background: #f5f5f5;">
        </div>
        <div class="modal-actions" style="display: grid; gap: 10px; margin-top: 20px;">
          <button class="cta" onclick="copyShareUrl()">📋 URLをコピー</button>
          <button class="cta secondary" onclick="shareViaEmail()">✉️ メールで共有</button>
          <button class="cta ghost" onclick="shareViaSlack()">💬 Slackで共有</button>
          <button class="cta ghost" onclick="shareViaTeams()">👥 Teamsで共有</button>
        </div>
      </div>
    </div>

    <!-- SOP編集モーダル -->
    <div id="editSOPModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>SOP改訂提案</h2>
          <button class="modal-close" onclick="closeEditSOPModal()">&times;</button>
        </div>
        <form id="editSOPForm" onsubmit="submitEditSOP(event)">
          <div class="field">
            <label>タイトル <span class="required">*</span></label>
            <input type="text" id="editSOPTitle" required>
          </div>
          <div class="field">
            <label>目的 <span class="required">*</span></label>
            <textarea id="editSOPPurpose" required rows="3"></textarea>
          </div>
          <div class="field">
            <label>適用範囲</label>
            <input type="text" id="editSOPScope">
          </div>
          <div class="field">
            <label>改訂内容 <span class="required">*</span></label>
            <textarea id="editSOPChanges" required rows="4" placeholder="どのような改訂を提案しますか？"></textarea>
          </div>
          <div class="field">
            <label>改訂理由</label>
            <textarea id="editSOPReason" rows="3" placeholder="改訂の理由を記述してください"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="cta ghost" onclick="closeEditSOPModal()">キャンセル</button>
            <button type="submit" class="cta">提案を送信</button>
          </div>
        </form>
      </div>
    </div>

    <script src="app.js"></script>
    <script src="dom-helpers.js"></script>
    <script src="detail-pages.js"></script>
    <script src="actions.js"></script>
    <script src="sop-detail-functions.js"></script>
  </body>
</html>
