# Alertmanager Configuration for Mirai Knowledge Systems
# Version: 1.0.0
# Last Updated: 2026-01-09

global:
  # ã‚¢ãƒ©ãƒ¼ãƒˆè§£æ±ºã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãŒè‡ªå‹•çš„ã«è§£æ±ºã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“ï¼‰
  resolve_timeout: 5m

  # SMTPè¨­å®šï¼ˆãƒ¡ãƒ¼ãƒ«é€šçŸ¥ç”¨ï¼‰
  smtp_smarthost: 'localhost:25'
  smtp_from: 'alerts@company.local'
  smtp_require_tls: false

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
route:
  # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ã‚­ãƒ¼
  group_by: ['alertname', 'cluster', 'service', 'component']

  # æœ€åˆã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¦ã‹ã‚‰ã€ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“
  group_wait: 10s

  # åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã«æ–°ã—ã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚ŒãŸéš›ã®é€ä¿¡é–“éš”
  group_interval: 10s

  # åŒã˜ã‚¢ãƒ©ãƒ¼ãƒˆã®å†é€ä¿¡é–“éš”
  repeat_interval: 12h

  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  receiver: 'default'

  # ã‚µãƒ–ãƒ«ãƒ¼ãƒˆï¼ˆæ¡ä»¶ã«å¿œã˜ãŸæŒ¯ã‚Šåˆ†ã‘ï¼‰
  routes:
    # Critical ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        severity: critical
      receiver: 'critical'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 4h
      continue: true  # ä»–ã®ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã«ã‚‚é€ä¿¡

    # Warning ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        severity: warning
      receiver: 'warning'
      group_wait: 30s
      group_interval: 30s
      repeat_interval: 24h

    # Info ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        severity: info
      receiver: 'info'
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 48h

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£
    - match:
        category: security
      receiver: 'security'
      group_wait: 5s
      repeat_interval: 6h
      continue: true

    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
    - match:
        component: database
      receiver: 'database'
      group_wait: 15s
      repeat_interval: 8h

    # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–¢é€£
    - match:
        component: backup
      receiver: 'backup'
      group_wait: 1m
      repeat_interval: 24h

# ãƒ¬ã‚·ãƒ¼ãƒãƒ¼è¨­å®š
receivers:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚·ãƒ¼ãƒãƒ¼ï¼ˆå…¨ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:5100/api/v1/webhook/alerts'
        send_resolved: true
        http_config:
          bearer_token: 'WEBHOOK_TOKEN_PLACEHOLDER'

  # Critical ã‚¢ãƒ©ãƒ¼ãƒˆç”¨
  - name: 'critical'
    email_configs:
      - to: 'admin@company.local'
        from: 'alerts@company.local'
        smarthost: 'localhost:25'
        headers:
          Subject: '[CRITICAL] Mirai Knowledge Systems - {{ .GroupLabels.alertname }}'
        html: |
          <h2>âš ï¸ CRITICAL Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Summary:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Action Required:</strong> {{ range .Alerts }}{{ .Annotations.action }}{{ end }}</p>
          <p><strong>Time:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>
          <p><a href="{{ range .Alerts }}{{ .Annotations.dashboard }}{{ end }}">View Dashboard</a></p>

    webhook_configs:
      - url: 'http://localhost:5100/api/v1/webhook/alerts/critical'
        send_resolved: true

    # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    #     channel: '#alerts-critical'
    #     title: 'âš ï¸ CRITICAL: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # Warning ã‚¢ãƒ©ãƒ¼ãƒˆç”¨
  - name: 'warning'
    email_configs:
      - to: 'admin@company.local'
        from: 'alerts@company.local'
        smarthost: 'localhost:25'
        headers:
          Subject: '[WARNING] Mirai Knowledge Systems - {{ .GroupLabels.alertname }}'
        html: |
          <h2>âš¡ Warning Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Summary:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Time:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>

    webhook_configs:
      - url: 'http://localhost:5100/api/v1/webhook/alerts/warning'
        send_resolved: true

  # Info ã‚¢ãƒ©ãƒ¼ãƒˆç”¨
  - name: 'info'
    webhook_configs:
      - url: 'http://localhost:5100/api/v1/webhook/alerts/info'
        send_resolved: true

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆç”¨
  - name: 'security'
    email_configs:
      - to: 'security@company.local,admin@company.local'
        from: 'security-alerts@company.local'
        smarthost: 'localhost:25'
        headers:
          Subject: '[SECURITY] Mirai Knowledge Systems - {{ .GroupLabels.alertname }}'
          Priority: 'urgent'
        html: |
          <h2>ğŸ”’ Security Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Summary:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Action Required:</strong> {{ range .Alerts }}{{ .Annotations.action }}{{ end }}</p>
          <p><strong>Time:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>
          <p style="color: red;"><strong>Security alerts require immediate attention!</strong></p>

    webhook_configs:
      - url: 'http://localhost:5100/api/v1/webhook/alerts/security'
        send_resolved: true

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆç”¨
  - name: 'database'
    email_configs:
      - to: 'dba@company.local,admin@company.local'
        from: 'alerts@company.local'
        smarthost: 'localhost:25'
        headers:
          Subject: '[DATABASE] Mirai Knowledge Systems - {{ .GroupLabels.alertname }}'
        html: |
          <h2>ğŸ’¾ Database Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Summary:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Time:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>

    webhook_configs:
      - url: 'http://localhost:5100/api/v1/webhook/alerts/database'
        send_resolved: true

  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ãƒ©ãƒ¼ãƒˆç”¨
  - name: 'backup'
    email_configs:
      - to: 'admin@company.local'
        from: 'alerts@company.local'
        smarthost: 'localhost:25'
        headers:
          Subject: '[BACKUP] Mirai Knowledge Systems - {{ .GroupLabels.alertname }}'
        html: |
          <h2>ğŸ’¿ Backup Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Summary:</strong> {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Action Required:</strong> {{ range .Alerts }}{{ .Annotations.action }}{{ end }}</p>
          <p><strong>Time:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>

# æŠ‘åˆ¶ãƒ«ãƒ¼ãƒ«ï¼ˆç‰¹å®šã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç«ã—ã¦ã„ã‚‹æ™‚ã«ã€ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶ï¼‰
inhibit_rules:
  # Critical ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«æ™‚ã¯ Warning ã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service', 'component']

  # ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢æ™‚ã¯ã€ä»–ã®å…¨ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['cluster', 'service']

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«æ¯æ¸‡æ™‚ã¯ã€ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'DatabaseConnectionPoolExhausted'
    target_match:
      alertname: 'DatabaseQuerySlow'
    equal: ['cluster', 'service']

  # ãƒ¡ãƒ¢ãƒª/CPU Criticalã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«æ™‚ã¯ã€Warningã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'CriticalMemoryUsage'
    target_match:
      alertname: 'HighMemoryUsage'
    equal: ['cluster', 'service']

  - source_match:
      alertname: 'CriticalCPUUsage'
    target_match:
      alertname: 'HighCPUUsage'
    equal: ['cluster', 'service']

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šï¼ˆã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
templates:
  - '/etc/alertmanager/templates/*.tmpl'
