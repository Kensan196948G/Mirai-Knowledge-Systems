# WebUI 脆弱性レポート

## 1. エグゼクティブサマリー
- 監査日: 2026-02-10
- 監査者: sec-auditor
- 総合評価: **PASS_WITH_WARNINGS**
- セキュリティスコア: 88/100

## 2. 脆弱性サマリー
| 深刻度 | 件数 | ステータス |
|--------|------|-----------|
| Critical | 0 | ✅ なし |
| High | 1 | 🟡 要確認 |
| Medium | 5 | 🟡 要確認 |
| Low | 2 | 🟢 情報提供 |

## 3. High脆弱性（P2）

### 1. document.write使用（印刷機能）
- **CVSS Score**: 5.8（Medium-High）
- **CWE**: CWE-79（クロスサイトスクリプティング）
- **影響**: 印刷専用ウィンドウでのXSS攻撃リスク（限定的）
- **ファイル**: webui/detail-pages.js:1135
- **コードスニペット**:
  ```javascript
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    ...
  `);
  ```
- **修正案**:
  ```javascript
  // DOM APIによる安全な印刷HTML生成
  const printDoc = printWindow.document;
  const html = printDoc.createElement('html');
  const head = printDoc.createElement('head');
  const body = printDoc.createElement('body');

  // タイトル設定
  const title = printDoc.createElement('title');
  title.textContent = documentTitle;
  head.appendChild(title);

  // スタイル設定
  const style = printDoc.createElement('style');
  style.textContent = printCSS;
  head.appendChild(style);

  // コンテンツ設定
  body.innerHTML = sanitizedContent; // DOMPurify使用

  html.appendChild(head);
  html.appendChild(body);
  printDoc.documentElement.replaceWith(html);
  ```
- **期限**: 30日以内

## 4. Medium脆弱性（P1）

### 1. ファイル名表示でのinnerHTML使用（files.js）
- **CVSS Score**: 6.1（Medium）
- **CWE**: CWE-79（XSS）
- **影響**: ユーザーアップロードファイル名にスクリプトタグが含まれる場合、XSS攻撃が可能
- **ファイル**: webui/static/js/files.js:35, 55, 69, 73
- **コードスニペット**:
  ```javascript
  this.fileListDiv.innerHTML = '<div class="no-files">アップロードされたファイルはありません</div>';
  this.fileListDiv.innerHTML = html; // html変数にファイル名が含まれる
  return div.innerHTML; // ファイル名を含むHTML返却
  ```
- **修正案**:
  ```javascript
  // DOM API使用による安全な実装
  const noFilesDiv = document.createElement('div');
  noFilesDiv.className = 'no-files';
  noFilesDiv.textContent = 'アップロードされたファイルはありません';
  this.fileListDiv.replaceChildren(noFilesDiv);

  // ファイル名のエスケープ
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  const fileName = escapeHtml(file.name);
  ```
- **期限**: 14日以内

### 2. MS365ファイル名表示でのinnerHTML使用（microsoft365-files.js）
- **CVSS Score**: 6.1（Medium）
- **CWE**: CWE-79（XSS）
- **影響**: MS365から取得したファイル名にスクリプトタグが含まれる場合、XSS攻撃が可能
- **ファイル**: webui/static/js/microsoft365-files.js:57, 80, 111, 115, 119
- **修正案**: files.js と同様にDOM API使用 + ファイル名エスケープ
- **期限**: 14日以内

### 3. MS365サービス名表示でのinnerHTML使用（microsoft365.js）
- **CVSS Score**: 5.5（Medium）
- **CWE**: CWE-79（XSS）
- **影響**: MS365サービス名に悪意あるスクリプトが含まれる場合（可能性は低い）、XSS攻撃が可能
- **ファイル**: webui/static/js/microsoft365.js:25, 33, 37, 41, 45
- **修正案**: DOM API使用に置き換え
- **期限**: 14日以内

### 4. app.js の innerHTML使用（静的コンテンツ）
- **CVSS Score**: 5.3（Medium）
- **CWE**: CWE-79（XSS）
- **影響**: 現在は静的コンテンツのみだが、将来的にユーザー入力が混入するリスク
- **ファイル**: webui/app.js:549, 3257, 3343, 3472, 3519
- **コードスニペット**:
  ```javascript
  monitoringSection.innerHTML = ''; // 要素クリア
  progressMeta.innerHTML = `<div class="progress-text">...</div>`; // 静的HTML
  doc.innerHTML = ''; // 要素クリア
  banner.innerHTML = `<div>...</div>`; // PWAインストールバナー
  indicator.innerHTML = '📡 オフラインモード - キャッシュされたコンテンツのみ利用可能';
  ```
- **修正案**:
  ```javascript
  // 要素クリアは replaceChildren() 使用
  monitoringSection.replaceChildren();

  // テキストのみは textContent 使用
  indicator.textContent = '📡 オフラインモード - キャッシュされたコンテンツのみ利用可能';

  // HTML構造が必要な場合はDOM API
  const banner = document.createElement('div');
  banner.className = 'pwa-banner';
  const text = document.createElement('span');
  text.textContent = 'アプリとしてインストール';
  banner.appendChild(text);
  ```
- **期限**: 30日以内

### 5. mfa.js の innerHTML使用（要素クリア）
- **CVSS Score**: 4.5（Medium-Low）
- **CWE**: CWE-79（XSS）
- **影響**: 要素クリア用途のため影響は限定的
- **ファイル**: webui/mfa.js:273
- **コードスニペット**:
  ```javascript
  element.innerHTML = '';
  ```
- **修正案**:
  ```javascript
  element.replaceChildren(); // より安全な方法
  ```
- **期限**: 30日以内

## 5. Low脆弱性（P3）

### 1. Service Worker の本番環境console.log残留
- **CVSS Score**: 3.1（Low）
- **CWE**: CWE-209（情報漏洩）
- **影響**: サムネイルキャッシュのURL情報が本番環境コンソールに出力される
- **ファイル**: webui/sw.js:318, 340, 346, 376, 390
- **コードスニペット**:
  ```javascript
  console.log('[SW] Thumbnail cache hit:', request.url);
  console.log('[SW] Thumbnail cached:', request.url);
  console.log('[SW] Thumbnail offline fallback:', request.url);
  console.log('[SW] Preview cached:', request.url);
  console.log('[SW] Preview offline fallback:', request.url);
  ```
- **修正案**:
  ```javascript
  // セキュアロガーの使用
  const logger = {
    log: (...args) => { if (!IS_PRODUCTION) console.log(...args); }
  };

  logger.log('[SW] Thumbnail cache hit:', request.url);
  ```
- **期限**: 60日以内

### 2. pwa/install-prompt.js の innerHTML使用（静的HTMLテンプレート）
- **CVSS Score**: 3.7（Low）
- **CWE**: CWE-79（XSS）
- **影響**: PWAインストールバナー用の静的HTMLのみのため影響は限定的
- **ファイル**: webui/pwa/install-prompt.js:102, 195
- **修正案**: DOM APIによるバナー生成
- **期限**: 60日以内

## 6. OWASP Top 10 準拠状況
| 項目 | ステータス | 備考 |
|------|-----------|------|
| A01: Broken Access Control | 🟢 PASS | RBAC実装済み、JWT認証 |
| A02: Cryptographic Failures | 🟢 PASS | PBKDF2 + AES-GCM 256-bit |
| A03: Injection | 🟡 WARNING | innerHTML使用箇所あり |
| A04: Insecure Design | 🟢 PASS | セキュアな設計 |
| A05: Security Misconfiguration | 🟡 WARNING | 一部console.log残留 |
| A06: Vulnerable Components | 🟢 PASS | 依存ライブラリなし |
| A07: Authentication Failures | 🟢 PASS | JWT + MFA実装済み |
| A08: Integrity Failures | 🟢 PASS | JWT署名検証 |
| A09: Logging Failures | 🟢 PASS | セキュアロガー実装済み |
| A10: SSRF | 🟢 PASS | 該当なし（フロントエンド） |

## 7. リスクアセスメント
### 総合リスク: **LOW**
- Critical: 0件
- High: 1件（30日以内対応）
- Medium: 5件（14日〜30日以内対応）
- Low: 2件（60日以内対応）

### リスクマトリクス
```
影響度 ↑
高  │ [低] │ [中] │ [高]
    ├─────┼─────┼─────────
中  │ [低] │ [中] │ [中]  ← files.js, microsoft365-*.js
    ├─────┼─────┼─────────
低  │ [無視]│ [低] │ [低]  ← sw.js, install-prompt.js
    └─────┴─────┴─────────→ 発生確率
      低    中    高
```

## 8. 是正計画
| 優先度 | 脆弱性 | 対策 | 期限 | 担当 | ファイル |
|--------|--------|------|------|------|---------|
| P1 | ファイル名表示innerHTML | DOM API + エスケープ | 14日 | code-implementer | files.js, microsoft365-files.js, microsoft365.js |
| P2 | document.write（印刷） | DOM API使用 | 30日 | code-implementer | detail-pages.js:1135 |
| P2 | app.js innerHTML（静的） | DOM API置き換え | 30日 | code-implementer | app.js |
| P3 | SW console.log | セキュアロガー導入 | 60日 | code-implementer | sw.js |

## 9. 推奨事項
- **DOMPurifyライブラリの導入**: innerHTML使用が避けられない場合のサニタイズ処理
- **Content Security Policy (CSP) 強化**: `script-src 'self'`, `object-src 'none'` の設定
- **定期的な脆弱性スキャン**: 月次でのセキュリティ監査
- **XSS自動テスト**: Playwright E2Eテストに<script>タグ注入テストを追加
- **セキュリティトレーニング**: 開発者向けOWASP Top 10研修

## 10. 優れたセキュリティ実装（Good Practices）

### ✅ 暗号化実装（Excellent）
- **PBKDF2**: 100,000 iterations（OWASP推奨値）
- **AES-GCM**: 256-bit暗号化
- **鍵導出**: UserEmail + BrowserFingerprint
- **実装**: webui/pwa/crypto-helper.js

### ✅ セキュアロガー（Excellent）
- 本番環境でのログ抑制
- IS_PRODUCTION判定による条件付きログ出力
- 実装: webui/app.js, pwa/*.js

### ✅ DOM API優先使用（Good）
- dom-helpers.js に明示的なXSS対策コメント
- 大部分のコードでDOM API使用
- innerHTML使用は限定的

### ✅ JWT認証（Excellent）
- トークンリフレッシュ機能
- 自動401リダイレクト
- 期限切れ検証
- IndexedDB暗号化保存（PWA対応）

### ✅ MFA（2FA）サポート（Excellent）
- TOTP認証（RFC 6238準拠）
- バックアップコード（bcrypt）
- Rate limiting（バックエンド）
- 実装: webui/mfa.js

## 11. テスト推奨項目

### XSS脆弱性テスト
```javascript
// ファイル名にスクリプトタグを含むファイルをアップロード
const maliciousFileName = '<script>alert("XSS")</script>.pdf';
// 期待結果: スクリプト実行されず、エスケープされた文字列として表示
```

### JWT期限切れテスト
```javascript
// トークン期限切れ後のAPIリクエスト
localStorage.setItem('access_token', 'expired_token');
await fetchAPI('/api/v1/knowledge');
// 期待結果: 401エラー → /login.html へ自動リダイレクト
```

### ブラウザフィンガープリント変更テスト
```javascript
// User-Agent変更後のIndexedDB復号化
// 期待結果: 復号化失敗 → ログアウト
```

## 12. 承認
**APPROVED_WITH_CONDITIONS**

### 条件
- P1脆弱性（ファイル名表示のinnerHTML）は14日以内に修正
- P2脆弱性は30日以内に修正
- P3脆弱性は60日以内に修正

### 次のステップ
1. code-implementer による P1脆弱性修正実装
2. DOMPurifyライブラリ導入検討
3. XSS自動テストの追加（Playwright）
4. 月次セキュリティスキャンの定期実行
5. 修正完了後の再監査

---

**監査担当**: sec-auditor
**監査日**: 2026-02-10
**次回監査予定**: 2026-03-10（P1/P2修正確認）
