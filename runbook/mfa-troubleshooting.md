# MFAトラブルシューティング

## 概要
MFA関連の一般的な問題と解決方法を記載します。問題が発生した場合は、まずこのガイドを参照してください。

## 一般的な問題と解決方法

### 問題1: 「無効な認証コードです」と表示される

#### 症状
- MFAコード入力時に「無効な認証コードです」というエラーが表示される
- 正しいコードを入力しているのに認証できない

#### 考えられる原因
1. デバイスの時刻設定がずれている
2. 認証アプリの設定が正しくない
3. QRコードの読み取りミス
4. サーバーの時刻同期エラー

#### 解決手順
1. **デバイスの時刻確認**
   - スマートフォンの設定 > 一般 > 日付と時刻
   - 「自動設定」をオンにする
   - または手動で正しい時刻に設定

2. **認証アプリの再設定**
   - プロフィール設定からMFAをリセット
   - QRコードを再スキャン
   - 新しいコードで設定完了

3. **バックアップコードの使用**
   - 保存しておいたバックアップコードを使用
   - ログイン後、すぐに新しいMFAを設定

#### 管理者対応（必要な場合）
```bash
# ユーザーMFA設定のリセット
UPDATE users SET mfa_secret = NULL, mfa_enabled = false WHERE username = '対象ユーザー';
```

### 問題2: QRコードが読み取れない

#### 症状
- QRコードが表示されるが、アプリで読み取れない
- カメラがQRコードを認識しない

#### 解決手順
1. **手動設定**
   - 「QRコードが読み取れない場合」をクリック
   - 表示される秘密鍵を手動で入力
   - アカウント名と鍵を入力

2. **カメラの確認**
   - カメラアプリでQRコードが読み取れるかテスト
   - カメラの権限設定を確認
   - カメラレンズが汚れていないか清掃

3. **別のデバイスを使用**
   - 別のスマートフォンでQRコードを読み取り
   - 設定完了後、元のデバイスに設定を移行

### 問題3: 認証アプリが起動しない

#### 症状
- 認証アプリがクラッシュする
- アプリがフリーズする
- コードが生成されない

#### 解決手順
1. **アプリの再起動**
   - アプリを完全に終了
   - デバイスを再起動
   - アプリを再度起動

2. **アプリのアップデート**
   - App Store/Google Playで最新版を確認
   - アプリをアップデート

3. **アプリの再インストール**
   - アプリをアンインストール
   - デバイスを再起動
   - アプリを再インストール
   - MFA設定をやり直し

### 問題4: バックアップコードが無効

#### 症状
- 保存したバックアップコードが使用できない
- 「無効なコードです」と表示される

#### 解決手順
1. **コードの確認**
   - コードの入力ミスがないか確認
   - 大文字小文字の区別を確認
   - スペースの有無を確認

2. **コードの有効性確認**
   - コードが既に使用されていないか確認
   - 有効期限が切れていないか確認

3. **新しいバックアップコードの発行**
   - 管理者またはサポートに連絡
   - 本人確認後、新しいコードを発行

#### 管理者対応
```bash
# 新しいバックアップコード生成
python scripts/generate_backup_codes.py --user 対象ユーザー
```

### 問題5: MFA設定画面が表示されない

#### 症状
- ログイン時にMFA設定を求められない
- プロフィール設定にMFA項目がない

#### 考えられる原因
1. システム設定でMFAが無効
2. ユーザー権限の問題
3. ブラウザのキャッシュ問題

#### 解決手順
1. **ブラウザの更新**
   - Ctrl+F5（Windows）またはCmd+Shift+R（Mac）で強制リロード
   - ブラウザのキャッシュをクリア

2. **別のブラウザの使用**
   - Chrome, Firefox, Safariなどの別のブラウザを試す
   - プライベートブラウズモードを試す

3. **管理者確認**
   - システム全体でMFAが有効になっているか確認
   - ユーザーアカウントの権限を確認

### 問題6: ログイン試行回数制限

#### 症状
- 複数回の失敗でアカウントがロックされる
- 「アカウントがロックされました」と表示

#### 解決手順
1. **待機時間**
   - 通常5-15分待つと自動解除
   - または管理者による解除を依頼

2. **パスワードリセット**
   - パスワードをリセットしてログイン
   - MFA設定をやり直す

#### 管理者対応
```bash
# アカウントロック解除
UPDATE users SET login_attempts = 0, locked_until = NULL WHERE username = '対象ユーザー';
```

### 問題7: 海外からのアクセス制限

#### 症状
- 海外からアクセスするとMFAが機能しない
- IP制限がかかっている

#### 解決手順
1. **VPNの使用**
   - 会社のVPNを使用してアクセス
   - 許可されたIPアドレスからのアクセス

2. **管理者への連絡**
   - 海外アクセスが必要な場合は事前に申請
   - IP許可リストへの追加を依頼

### 問題8: デバイス紛失・盗難

#### 症状
- 認証アプリを設定したデバイスを紛失
- 新しいデバイスでMFAを設定できない

#### 緊急対応
1. **バックアップコードの使用**
   - 保存しておいたバックアップコードを使用
   - すぐに新しいデバイスでMFAを設定

2. **管理者への緊急連絡**
   - デバイス紛失を報告
   - MFAの一時無効化を依頼

#### 管理者対応
```bash
# MFA緊急無効化
UPDATE users SET mfa_enabled = false WHERE username = '対象ユーザー';
# ログに記録
echo "$(date): MFA disabled for user 対象ユーザー - device lost" >> /var/log/mfa-emergency.log
```

## 高度なトラブルシューティング

### ログ分析
```bash
# MFA関連ログの確認
grep "MFA" /var/log/mks/auth.log | tail -20

# 特定のユーザーMFAログ
grep "ユーザー名" /var/log/mks/mfa.log | tail -10
```

### データベース確認
```sql
-- MFA設定状態確認
SELECT username, mfa_enabled, mfa_last_used FROM users WHERE username = '対象ユーザー';

-- MFAシークレット確認
SELECT * FROM mfa_secrets WHERE user_id = (SELECT id FROM users WHERE username = '対象ユーザー');
```

### ネットワーク診断
```bash
# NTP同期確認
ntpq -p

# インターネット接続確認
curl -I https://time.google.com

# DNS解決確認
nslookup time.nist.gov
```

## エスカレーション

### レベル1: ユーザー自身で解決可能
- 時刻設定の確認
- アプリの再起動
- ブラウザのキャッシュクリア

### レベル2: 管理者対応が必要
- MFA設定のリセット
- バックアップコードの発行
- アカウントロック解除

### レベル3: 開発チーム対応が必要
- システム全体のMFA障害
- コードのバグ修正
- 設定変更

## 予防策

### 定期的な確認
- デバイスの時刻同期
- 認証アプリのアップデート
- バックアップコードの更新

### バックアップの準備
- 複数の認証アプリの設定
- バックアップコードの定期的な更新
- 緊急連絡先の登録

### トレーニング
- MFAの重要性の理解
- トラブルシューティングの知識
- セキュリティ意識の向上