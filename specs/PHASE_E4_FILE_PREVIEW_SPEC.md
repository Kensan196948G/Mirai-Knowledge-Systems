# Phase E-4: MS365ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ - ä»•æ§˜æ›¸

**Version**: 1.0.0
**ä½œæˆæ—¥**: 2026-02-06
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Draft
**Phase**: Phase E-4ï¼ˆWeek 2-3ï¼‰
**ä¾å­˜Phase**: Phase D-4 Week 1ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤ï¼‰âœ…, Phase D-5ï¼ˆPWAåŸºç›¤ï¼‰âœ…

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼](#1-ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼)
2. [ãƒ“ã‚¸ãƒã‚¹è¦ä»¶](#2-ãƒ“ã‚¸ãƒã‚¹è¦ä»¶)
3. [æ©Ÿèƒ½è¦ä»¶](#3-æ©Ÿèƒ½è¦ä»¶)
4. [éæ©Ÿèƒ½è¦ä»¶](#4-éæ©Ÿèƒ½è¦ä»¶)
5. [æŠ€è¡“ä»•æ§˜](#5-æŠ€è¡“ä»•æ§˜)
6. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶](#6-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶)
7. [PWAçµ±åˆä»•æ§˜](#7-pwaçµ±åˆä»•æ§˜)
8. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#8-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
9. [ãƒ†ã‚¹ãƒˆè¦ä»¶](#9-ãƒ†ã‚¹ãƒˆè¦ä»¶)
10. [é‹ç”¨è¦ä»¶](#10-é‹ç”¨è¦ä»¶)
11. [å®Ÿè£…è¨ˆç”»](#11-å®Ÿè£…è¨ˆç”»)
12. [ç”¨èªé›†](#12-ç”¨èªé›†)

---

## 1. ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### 1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

**Phase D-4.2 Week 2-3**: Microsoft 365é€£æºãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚

**èƒŒæ™¯**:
- Phase D-4 Week 1ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤ï¼ˆAPI 3æœ¬ã€ãƒ†ã‚¹ãƒˆ10ä»¶ï¼‰ã‚’å®Œæˆ
- Microsoft Graph APIã‹ã‚‰å–å¾—ã—ãŸSharePoint/OneDriveãƒ•ã‚¡ã‚¤ãƒ«ã‚’WebUIä¸Šã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã™ã‚‹å¿…è¦æ€§
- å»ºè¨­åœŸæœ¨æ¥­ç•Œã«ãŠã‘ã‚‹å›³é¢ãƒ»è¦‹ç©æ›¸ãƒ»å¥‘ç´„æ›¸ç­‰ã®Officeæ–‡æ›¸ã®å³æ™‚ç¢ºèªè¦æ±‚

**ç›®çš„**:
- Officeæ–‡æ›¸ï¼ˆWord/Excel/PowerPointï¼‰ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤º
- PDFã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
- ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§è¡¨ç¤ºã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã®åŠ¹ç‡åŒ–
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆPWAçµ±åˆï¼‰

### 1.2 ã‚¹ã‚³ãƒ¼ãƒ—

**å®Ÿè£…å¯¾è±¡**:
- âœ… `file-preview.js`ï¼ˆ500è¡Œã€FilePreviewManagerã‚¯ãƒ©ã‚¹ï¼‰
- âœ… PWAçµ±åˆï¼ˆ`cache-manager.js`, `sw.js`ä¿®æ­£ï¼‰
- âœ… E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywright 8ä»¶ï¼‰
- âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰ã€æŠ€è¡“ä»•æ§˜ï¼‰

**å®Ÿè£…å¯¾è±¡å¤–**:
- âŒ ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†æ©Ÿèƒ½ï¼ˆPhase D-4.3ã§æ¤œè¨ï¼‰
- âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒç·¨é›†ï¼ˆPhase D-4.3ã§æ¤œè¨ï¼‰
- âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†UIï¼ˆPhase D-4.3ã§æ¤œè¨ï¼‰

### 1.3 æˆæœç‰©

| æˆæœç‰© | è¡Œæ•° | çŠ¶æ…‹ |
|--------|------|------|
| `webui/file-preview.js` | 500 | æœªç€æ‰‹ |
| `webui/pwa/cache-manager.js`ï¼ˆä¿®æ­£ï¼‰ | +50 | æœªç€æ‰‹ |
| `webui/sw.js`ï¼ˆä¿®æ­£ï¼‰ | +30 | æœªç€æ‰‹ |
| E2Eãƒ†ã‚¹ãƒˆï¼ˆ`file-preview.spec.js`ï¼‰ | 400 | æœªç€æ‰‹ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰ | 800 | æœªç€æ‰‹ |
| æŠ€è¡“ä»•æ§˜æ›¸ï¼ˆæœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ | 2,500 | âœ… ä½œæˆä¸­ |

---

## 2. ãƒ“ã‚¸ãƒã‚¹è¦ä»¶

### 2.1 ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼è¦ä»¶

#### 2.1.1 ç¾å ´ä½œæ¥­å“¡ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
- **è¦æ±‚**: ã‚¹ãƒãƒ›ã§å›³é¢ãƒ»è¦‹ç©æ›¸ã‚’ã™ãã«ç¢ºèªã—ãŸã„
- **åˆ¶ç´„**: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸è¦ã€ãƒ‡ãƒ¼ã‚¿é€šä¿¡é‡ã‚’æŠ‘ãˆãŸã„
- **æˆåŠŸæŒ‡æ¨™**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã¾ã§3ç§’ä»¥å†…

#### 2.1.2 äº‹å‹™ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆãƒ‘ãƒ¯ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
- **è¦æ±‚**: Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’PCç”»é¢ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã—ãŸã„
- **åˆ¶ç´„**: è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆè¡¨ç¤ºã—ãŸã„
- **æˆåŠŸæŒ‡æ¨™**: ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§ã‹ã‚‰ç›®çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’2ã‚¯ãƒªãƒƒã‚¯ä»¥å†…ã§é–‹ã

#### 2.1.3 ç®¡ç†è€…
- **è¦æ±‚**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã‚’ç›£æŸ»ãƒ­ã‚°ã§è¿½è·¡ã—ãŸã„
- **åˆ¶ç´„**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã«æº–æ‹ ï¼ˆCSP, XSSå¯¾ç­–ï¼‰
- **æˆåŠŸæŒ‡æ¨™**: å…¨ã‚¢ã‚¯ã‚»ã‚¹ãŒç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹

### 2.2 ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ã‚»ã‚¹

#### 2.2.1 ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹1: ç¾å ´ä½œæ¥­å“¡ãŒå›³é¢ã‚’ç¢ºèª

```
[å‰ææ¡ä»¶]
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
- SharePointã«å›³é¢ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.pdf, .jpgï¼‰ãŒä¿å­˜æ¸ˆã¿

[æ­£å¸¸ãƒ•ãƒ­ãƒ¼]
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒMS365åŒæœŸè¨­å®šç”»é¢ã‚’é–‹ã
2. ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã«ã‚µãƒ ãƒã‚¤ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ ãƒã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãï¼ˆ3ç§’ä»¥å†…ï¼‰
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå›³é¢ã‚’ç¢ºèª
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

[ä»£æ›¿ãƒ•ãƒ­ãƒ¼]
- 3a. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
- 4a. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå¤±æ•—
  - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º

[äº‹å¾Œæ¡ä»¶]
- ç›£æŸ»ãƒ­ã‚°ã«ã€Œms365_file.previewã€ãŒè¨˜éŒ²ã•ã‚Œã‚‹
```

#### 2.2.2 ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹2: äº‹å‹™ã‚¹ã‚¿ãƒƒãƒ•ãŒExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª

```
[å‰ææ¡ä»¶]
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
- SharePointã«è¦‹ç©æ›¸ï¼ˆ.xlsxï¼‰ãŒä¿å­˜æ¸ˆã¿

[æ­£å¸¸ãƒ•ãƒ­ãƒ¼]
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚¯ãƒªãƒƒã‚¯
2. Microsoft Office Online Embedãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚»ãƒ«å†…å®¹ã‚’ç¢ºèª
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦å…¨ã‚·ãƒ¼ãƒˆã‚’ç¢ºèª
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‰ã˜ã‚‹

[ä»£æ›¿ãƒ•ãƒ­ãƒ¼]
- 2a. Office Onlineã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸å¯
  - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º

[äº‹å¾Œæ¡ä»¶]
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLãŒãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œã‚‹ï¼ˆ1æ™‚é–“ï¼‰
```

### 2.3 KPIãƒ»æˆåŠŸæŒ‡æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | æ¸¬å®šæ–¹æ³• |
|------|--------|----------|
| ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºé€Ÿåº¦ | 3ç§’ä»¥å†… | Lighthouse Performance |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ | 60%ä»¥ä¸Š | Prometheus metrics |
| ã‚¨ãƒ©ãƒ¼ç‡ | 5%ä»¥ä¸‹ | `file_preview_errors_total` |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ | 4.0/5.0ä»¥ä¸Š | ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒ  |

---

## 3. æ©Ÿèƒ½è¦ä»¶

### 3.1 æ©Ÿèƒ½æ¦‚è¦

#### 3.1.1 ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æˆ¦ç•¥

| ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ— | æ‹¡å¼µå­ | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹å¼ | è¡¨ç¤ºæ–¹æ³• |
|---------------|--------|---------------|----------|
| Officeæ–‡æ›¸ | .docx, .xlsx, .pptx | Microsoft Office Online Embed | `<iframe>` |
| Officeæ—§å½¢å¼ | .doc, .xls, .ppt | ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ | ãƒªãƒ³ã‚¯è¡¨ç¤º |
| PDF | .pdf | Graph API Download URL | `<embed>` ã¾ãŸã¯ PDF.js |
| ç”»åƒ | .jpg, .png, .gif | Graph API Download URL | `<img>` |
| ãƒ†ã‚­ã‚¹ãƒˆ | .txt, .csv | Graph API Download URL | `<pre>` |
| ãã®ä»– | .zip, .exeç­‰ | ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã¿ | ãƒªãƒ³ã‚¯è¡¨ç¤º |

### 3.2 æ©Ÿèƒ½ä»•æ§˜

#### 3.2.1 FilePreviewManagerã‚¯ãƒ©ã‚¹

**è²¬å‹™**:
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

**å…¬é–‹ãƒ¡ã‚½ãƒƒãƒ‰**:

```javascript
class FilePreviewManager {
  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
   * @param {string} driveId - ãƒ‰ãƒ©ã‚¤ãƒ–ID
   * @param {string} fileId - ãƒ•ã‚¡ã‚¤ãƒ«ID
   * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @param {string} options.fileName - ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆè¡¨ç¤ºç”¨ï¼‰
   * @param {Function} options.onClose - é–‰ã˜ã‚‹æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   * @returns {Promise<void>}
   */
  async showPreview(driveId, fileId, options = {}) {}

  /**
   * ã‚µãƒ ãƒã‚¤ãƒ«URLã‚’å–å¾—
   * @param {string} driveId - ãƒ‰ãƒ©ã‚¤ãƒ–ID
   * @param {string} fileId - ãƒ•ã‚¡ã‚¤ãƒ«ID
   * @param {string} size - ã‚µãƒ ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆ"small" | "medium" | "large"ï¼‰
   * @returns {Promise<string>} - ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒURLï¼ˆData URLå½¢å¼ï¼‰
   */
  async getThumbnailUrl(driveId, fileId, size = 'medium') {}

  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   * @param {string} driveId - ãƒ‰ãƒ©ã‚¤ãƒ–ID
   * @param {string} fileId - ãƒ•ã‚¡ã‚¤ãƒ«ID
   * @param {string} fileName - ãƒ•ã‚¡ã‚¤ãƒ«å
   * @returns {Promise<void>}
   */
  async downloadFile(driveId, fileId, fileName) {}

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
   * @returns {void}
   */
  closePreview() {}
}
```

#### 3.2.2 APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµ±åˆ

**ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLå–å¾—**:
```http
GET /api/v1/integrations/microsoft365/files/{file_id}/preview?drive_id={drive_id}
Authorization: Bearer {jwt_token}

Response 200 OK:
{
  "success": true,
  "data": {
    "preview_url": "https://view.officeapps.live.com/op/embed.aspx?src=...",
    "preview_type": "office_embed",
    "mime_type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    "file_name": "estimate.xlsx",
    "file_size": 102400
  }
}
```

**ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—**:
```http
GET /api/v1/integrations/microsoft365/files/{file_id}/thumbnail?drive_id={drive_id}&size=medium
Authorization: Bearer {jwt_token}

Response 200 OK:
Content-Type: image/png
(Binary data)
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**:
```http
GET /api/v1/integrations/microsoft365/files/{file_id}/download?drive_id={drive_id}
Authorization: Bearer {jwt_token}

Response 200 OK:
Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
Content-Disposition: attachment; filename=contract.docx
(Binary data)
```

#### 3.2.3 ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«UIä»•æ§˜

**HTMLæ§‹é€ **:
```html
<div id="file-preview-modal" class="modal" role="dialog" aria-labelledby="preview-title">
  <div class="modal-content">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="modal-header">
      <h2 id="preview-title"><!-- ãƒ•ã‚¡ã‚¤ãƒ«å --></h2>
      <div class="modal-actions">
        <button id="preview-download-btn" class="btn-secondary">
          ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>
        <button id="preview-close-btn" class="btn-icon" aria-label="é–‰ã˜ã‚‹">
          Ã—
        </button>
      </div>
    </div>

    <!-- ãƒœãƒ‡ã‚£ -->
    <div class="modal-body">
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
      <div id="preview-loading" class="loading-spinner">
        èª­ã¿è¾¼ã¿ä¸­...
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div id="preview-container">
        <!-- ã‚¿ã‚¤ãƒ—åˆ¥ã«æŒ¿å…¥ -->
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
      <div id="preview-error" class="error-message" style="display: none;">
        <p class="error-text"></p>
        <button id="preview-retry-btn" class="btn-primary">å†è©¦è¡Œ</button>
      </div>
    </div>
  </div>
</div>
```

**ã‚¹ã‚¿ã‚¤ãƒ«ä»•æ§˜** (styles.cssè¿½åŠ ):
```css
/* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
#file-preview-modal .modal-content {
  max-width: 90vw;
  max-height: 90vh;
  width: 1200px;
}

#preview-container {
  min-height: 400px;
  max-height: calc(90vh - 120px);
  overflow: auto;
}

#preview-container iframe {
  width: 100%;
  height: 600px;
  border: none;
}

#preview-container img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
}

#preview-container embed {
  width: 100%;
  height: 600px;
}

#preview-container pre {
  background-color: #f5f5f5;
  padding: 16px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  white-space: pre-wrap;
  word-wrap: break-word;
}
```

#### 3.2.4 ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º

**çµ±åˆå…ˆ**: `webui/ms365-sync-settings.html` ã®åŒæœŸå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«

**å¤‰æ›´å†…å®¹**:
```html
<!-- æ—¢å­˜ã®åŒæœŸå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ  -->
<table id="sync-history-table">
  <thead>
    <tr>
      <th>ã‚µãƒ ãƒã‚¤ãƒ«</th> <!-- æ–°è¦è¿½åŠ  -->
      <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
      <th>åŒæœŸæ—¥æ™‚</th>
      <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    <!-- å‹•çš„ç”Ÿæˆ -->
  </tbody>
</table>
```

**ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯** (ms365-sync.jsä¿®æ­£):
```javascript
// åŒæœŸå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function renderSyncHistoryRow(history) {
  const row = document.createElement('tr');

  // ã‚µãƒ ãƒã‚¤ãƒ«ã‚»ãƒ«
  const thumbnailCell = document.createElement('td');
  const thumbnailImg = document.createElement('img');
  thumbnailImg.className = 'file-thumbnail';
  thumbnailImg.alt = history.file_name;
  thumbnailImg.style.width = '48px';
  thumbnailImg.style.height = '48px';
  thumbnailImg.style.objectFit = 'cover';
  thumbnailImg.style.cursor = 'pointer';

  // ã‚µãƒ ãƒã‚¤ãƒ«èª­ã¿è¾¼ã¿
  filePreviewManager.getThumbnailUrl(history.drive_id, history.file_id, 'small')
    .then(dataUrl => {
      thumbnailImg.src = dataUrl;
    })
    .catch(() => {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã‚¢ã‚¤ã‚³ãƒ³
      thumbnailImg.src = getFileTypeIcon(history.mime_type);
    });

  // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
  thumbnailImg.addEventListener('click', () => {
    filePreviewManager.showPreview(history.drive_id, history.file_id, {
      fileName: history.file_name
    });
  });

  thumbnailCell.appendChild(thumbnailImg);
  row.appendChild(thumbnailCell);

  // ... ä»–ã®ã‚»ãƒ«ã®å®Ÿè£…

  return row;
}
```

---

## 4. éæ©Ÿèƒ½è¦ä»¶

### 4.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

| é …ç›® | è¦ä»¶ | æ¸¬å®šæ–¹æ³• |
|------|------|----------|
| åˆå›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º | 3ç§’ä»¥å†… | Lighthouse Performance |
| ã‚µãƒ ãƒã‚¤ãƒ«èª­ã¿è¾¼ã¿ | 1ç§’ä»¥å†…ï¼ˆ10ä»¶ï¼‰ | Chrome DevTools Network |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ | 500msä»¥å†… | Performance API |
| æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º | 50MB | APIåˆ¶é™ |

**æœ€é©åŒ–æˆ¦ç•¥**:
- ã‚µãƒ ãƒã‚¤ãƒ«ä¸¦åˆ—å–å¾—ï¼ˆPromise.allã€æœ€å¤§5ä¸¦åˆ—ï¼‰
- Service Workerã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ï¼ˆç”»åƒ: 30æ—¥ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL: 1æ™‚é–“ï¼‰
- IntersectionObserveré…å»¶èª­ã¿è¾¼ã¿ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ï¼‰

### 4.2 äº’æ›æ€§è¦ä»¶

**ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆ**:
| ãƒ–ãƒ©ã‚¦ã‚¶ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¯¾å¿œçŠ¶æ³ |
|---------|-----------|---------|
| Chrome/Edge | 90+ | âœ… Full Support |
| Firefox | 88+ | âœ… Full Support |
| Safari | 14+ | âœ… Full Support (iframeåˆ¶é™ã‚ã‚Š) |
| Mobile Safari | iOS 14+ | âœ… Full Support |
| Android Chrome | 90+ | âœ… Full Support |

**éå¯¾å¿œæ©Ÿèƒ½ã®ä»£æ›¿**:
- Safari: `<iframe sandbox>` CSPåˆ¶é™ â†’ æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
- HTTPç’°å¢ƒ: Service Workerç„¡åŠ¹ â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿

### 4.3 ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¦ä»¶

**WCAG 2.1 AAæº–æ‹ **:
- âœ… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆTab, Enter, Escï¼‰
- âœ… ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œï¼ˆARIAå±æ€§ï¼‰
- âœ… ã‚«ãƒ©ãƒ¼ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ¯”4.5:1ä»¥ä¸Š
- âœ… ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯è¦–åŒ–

**å®Ÿè£…ä¾‹**:
```javascript
// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape' && previewModal.style.display !== 'none') {
    filePreviewManager.closePreview();
  }
});

// ARIAå±æ€§
previewModal.setAttribute('role', 'dialog');
previewModal.setAttribute('aria-modal', 'true');
previewModal.setAttribute('aria-labelledby', 'preview-title');
```

---

## 5. æŠ€è¡“ä»•æ§˜

### 5.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

#### 5.1.1 ã‚¯ãƒ©ã‚¹å›³

```mermaid
classDiagram
    class FilePreviewManager {
        -apiClient: APIClient
        -cacheManager: CacheManager
        -modal: HTMLElement
        +showPreview(driveId, fileId, options)
        +getThumbnailUrl(driveId, fileId, size)
        +downloadFile(driveId, fileId, fileName)
        +closePreview()
        -renderOfficeEmbed(previewUrl)
        -renderImagePreview(downloadUrl)
        -renderPDFPreview(downloadUrl)
        -renderTextPreview(content)
        -handleError(error)
    }

    class APIClient {
        +getPreviewUrl(driveId, fileId)
        +getThumbnail(driveId, fileId, size)
        +downloadFile(driveId, fileId)
    }

    class CacheManager {
        +getThumbnailFromCache(cacheKey)
        +cacheThumbnail(cacheKey, data)
        +getPreviewFromCache(cacheKey)
        +cachePreview(cacheKey, data)
    }

    FilePreviewManager --> APIClient
    FilePreviewManager --> CacheManager
```

#### 5.1.2 ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼‰

```mermaid
sequenceDiagram
    participant User
    participant FilePreviewManager
    participant APIClient
    participant ServiceWorker
    participant GraphAPI

    User->>FilePreviewManager: showPreview(driveId, fileId)
    FilePreviewManager->>FilePreviewManager: showModal()
    FilePreviewManager->>APIClient: getPreviewUrl(driveId, fileId)
    APIClient->>ServiceWorker: fetch('/api/.../preview')

    alt Cache Hit
        ServiceWorker-->>APIClient: cached response
    else Cache Miss
        ServiceWorker->>GraphAPI: Graph API Request
        GraphAPI-->>ServiceWorker: preview_url
        ServiceWorker->>ServiceWorker: cache response (1h)
        ServiceWorker-->>APIClient: response
    end

    APIClient-->>FilePreviewManager: { preview_url, preview_type }

    alt Office Document
        FilePreviewManager->>FilePreviewManager: renderOfficeEmbed(iframe)
    else PDF
        FilePreviewManager->>FilePreviewManager: renderPDFPreview(embed)
    else Image
        FilePreviewManager->>FilePreviewManager: renderImagePreview(img)
    end

    FilePreviewManager-->>User: Display Preview
```

### 5.2 å®Ÿè£…è©³ç´°

#### 5.2.1 file-preview.jsï¼ˆãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ï¼‰

```javascript
/**
 * File Preview Manager
 *
 * MS365ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’æä¾›
 * - Officeæ–‡æ›¸: Microsoft Office Online Embed
 * - PDF/ç”»åƒ: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLçµŒç”±è¡¨ç¤º
 * - ã‚µãƒ ãƒã‚¤ãƒ«: Graph API Thumbnail Endpoint
 *
 * Version: 1.0.0
 */

class FilePreviewManager {
  constructor() {
    this.apiBaseUrl = '/api/v1/integrations/microsoft365/files';
    this.modal = null;
    this.currentPreviewType = null;
    this.currentDriveId = null;
    this.currentFileId = null;
    this.onCloseCallback = null;

    // DOMè¦ç´ å‚ç…§ï¼ˆé…å»¶åˆæœŸåŒ–ï¼‰
    this.elements = {
      modal: null,
      title: null,
      container: null,
      loading: null,
      error: null,
      errorText: null,
      downloadBtn: null,
      closeBtn: null,
      retryBtn: null
    };
  }

  /**
   * åˆæœŸåŒ–ï¼ˆDOMæ§‹ç¯‰ï¼‰
   */
  init() {
    if (this.modal) return; // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿

    // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLç”Ÿæˆ
    const modalHtml = `
      <div id="file-preview-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="preview-title">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="preview-title" class="modal-title"></h2>
            <div class="modal-actions">
              <button id="preview-download-btn" class="btn-secondary">
                ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              </button>
              <button id="preview-close-btn" class="btn-icon" aria-label="é–‰ã˜ã‚‹">
                Ã—
              </button>
            </div>
          </div>
          <div class="modal-body">
            <div id="preview-loading" class="loading-spinner">
              <div class="spinner"></div>
              <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <div id="preview-container"></div>
            <div id="preview-error" class="error-message" style="display: none;">
              <p id="preview-error-text" class="error-text"></p>
              <button id="preview-retry-btn" class="btn-primary">å†è©¦è¡Œ</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // DOMã«è¿½åŠ 
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);

    // DOMè¦ç´ å‚ç…§å–å¾—
    this.modal = document.getElementById('file-preview-modal');
    this.elements = {
      modal: this.modal,
      title: document.getElementById('preview-title'),
      container: document.getElementById('preview-container'),
      loading: document.getElementById('preview-loading'),
      error: document.getElementById('preview-error'),
      errorText: document.getElementById('preview-error-text'),
      downloadBtn: document.getElementById('preview-download-btn'),
      closeBtn: document.getElementById('preview-close-btn'),
      retryBtn: document.getElementById('preview-retry-btn')
    };

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
    this.attachEventListeners();
  }

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
   */
  attachEventListeners() {
    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    this.elements.closeBtn.addEventListener('click', () => {
      this.closePreview();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯
    this.modal.addEventListener('click', (event) => {
      if (event.target === this.modal) {
        this.closePreview();
      }
    });

    // Escapeã‚­ãƒ¼
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && this.modal.style.display !== 'none') {
        this.closePreview();
      }
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    this.elements.downloadBtn.addEventListener('click', () => {
      if (this.currentDriveId && this.currentFileId) {
        const fileName = this.elements.title.textContent || 'download';
        this.downloadFile(this.currentDriveId, this.currentFileId, fileName);
      }
    });

    // å†è©¦è¡Œãƒœã‚¿ãƒ³
    this.elements.retryBtn.addEventListener('click', () => {
      if (this.currentDriveId && this.currentFileId) {
        this.showPreview(this.currentDriveId, this.currentFileId, {
          fileName: this.elements.title.textContent
        });
      }
    });
  }

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
   * @param {string} driveId - ãƒ‰ãƒ©ã‚¤ãƒ–ID
   * @param {string} fileId - ãƒ•ã‚¡ã‚¤ãƒ«ID
   * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @param {string} options.fileName - ãƒ•ã‚¡ã‚¤ãƒ«å
   * @param {Function} options.onClose - é–‰ã˜ã‚‹æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
   */
  async showPreview(driveId, fileId, options = {}) {
    // åˆæœŸåŒ–
    this.init();

    // ç¾åœ¨ã®çŠ¶æ…‹ä¿å­˜
    this.currentDriveId = driveId;
    this.currentFileId = fileId;
    this.onCloseCallback = options.onClose || null;

    // UIåˆæœŸåŒ–
    this.elements.title.textContent = options.fileName || 'ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
    this.elements.container.innerHTML = '';
    this.elements.loading.style.display = 'block';
    this.elements.error.style.display = 'none';
    this.modal.style.display = 'flex';

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—
    this.elements.closeBtn.focus();

    try {
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLå–å¾—
      const previewData = await this.fetchPreviewUrl(driveId, fileId);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      this.currentPreviewType = previewData.preview_type;

      switch (previewData.preview_type) {
        case 'office_embed':
          await this.renderOfficeEmbed(previewData.preview_url);
          break;
        case 'image':
          await this.renderImagePreview(previewData.preview_url);
          break;
        case 'download':
          await this.renderDownloadPreview(previewData);
          break;
        default:
          throw new Error(`Unsupported preview type: ${previewData.preview_type}`);
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
      this.elements.loading.style.display = 'none';

    } catch (error) {
      console.error('[FilePreviewManager] Preview failed:', error);
      this.handleError(error);
    }
  }

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLå–å¾—
   * @param {string} driveId - ãƒ‰ãƒ©ã‚¤ãƒ–ID
   * @param {string} fileId - ãƒ•ã‚¡ã‚¤ãƒ«ID
   * @returns {Promise<Object>}
   */
  async fetchPreviewUrl(driveId, fileId) {
    const url = `${this.apiBaseUrl}/${fileId}/preview?drive_id=${encodeURIComponent(driveId)}`;

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || 'Failed to fetch preview URL');
    }

    const data = await response.json();
    return data.data;
  }

  /**
   * Officeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆiframeåŸ‹ã‚è¾¼ã¿ï¼‰
   * @param {string} embedUrl - Office Online Embed URL
   */
  async renderOfficeEmbed(embedUrl) {
    const iframe = document.createElement('iframe');
    iframe.src = embedUrl;
    iframe.style.width = '100%';
    iframe.style.height = '600px';
    iframe.style.border = 'none';
    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms');
    iframe.setAttribute('allowfullscreen', 'true');

    // ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾…æ©Ÿ
    await new Promise((resolve, reject) => {
      iframe.addEventListener('load', resolve);
      iframe.addEventListener('error', reject);
      setTimeout(reject, 10000); // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    });

    this.elements.container.appendChild(iframe);
  }

  /**
   * ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
   * @param {string} downloadUrl - ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL
   */
  async renderImagePreview(downloadUrl) {
    const img = document.createElement('img');
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.alt = this.elements.title.textContent || 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ';

    // Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãã§ç”»åƒå–å¾—
    const response = await fetch(downloadUrl, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
      }
    });

    if (!response.ok) {
      throw new Error('Failed to load image');
    }

    const blob = await response.blob();
    const dataUrl = URL.createObjectURL(blob);
    img.src = dataUrl;

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    img.addEventListener('load', () => {
      URL.revokeObjectURL(dataUrl);
    });

    this.elements.container.appendChild(img);
  }

  /**
   * ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å°‚ç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
   * @param {Object} previewData - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿
   */
  async renderDownloadPreview(previewData) {
    const message = document.createElement('div');
    message.className = 'download-preview';
    message.style.textAlign = 'center';
    message.style.padding = '48px 24px';

    const icon = document.createElement('div');
    icon.className = 'file-icon';
    icon.style.fontSize = '64px';
    icon.textContent = 'ğŸ“„';

    const fileName = document.createElement('p');
    fileName.textContent = previewData.file_name || 'ãƒ•ã‚¡ã‚¤ãƒ«';
    fileName.style.fontSize = '18px';
    fileName.style.marginTop = '16px';

    const fileSize = document.createElement('p');
    fileSize.textContent = this.formatFileSize(previewData.file_size || 0);
    fileSize.style.color = '#666';
    fileSize.style.marginTop = '8px';

    const downloadMessage = document.createElement('p');
    downloadMessage.textContent = 'ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã”ç¢ºèªãã ã•ã„ã€‚';
    downloadMessage.style.marginTop = '24px';
    downloadMessage.style.color = '#666';

    message.appendChild(icon);
    message.appendChild(fileName);
    message.appendChild(fileSize);
    message.appendChild(downloadMessage);

    this.elements.container.appendChild(message);
  }

  /**
   * ã‚µãƒ ãƒã‚¤ãƒ«URLå–å¾—
   * @param {string} driveId - ãƒ‰ãƒ©ã‚¤ãƒ–ID
   * @param {string} fileId - ãƒ•ã‚¡ã‚¤ãƒ«ID
   * @param {string} size - ã‚µã‚¤ã‚ºï¼ˆsmall | medium | largeï¼‰
   * @returns {Promise<string>} - Data URL
   */
  async getThumbnailUrl(driveId, fileId, size = 'medium') {
    const cacheKey = `thumbnail_${driveId}_${fileId}_${size}`;

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    const cached = await this.getCachedThumbnail(cacheKey);
    if (cached) {
      return cached;
    }

    // APIå–å¾—
    const url = `${this.apiBaseUrl}/${fileId}/thumbnail?drive_id=${encodeURIComponent(driveId)}&size=${size}`;

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
      }
    });

    if (!response.ok) {
      // ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      return this.getFileTypeIcon('unknown');
    }

    const blob = await response.blob();
    const dataUrl = await this.blobToDataUrl(blob);

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
    await this.cacheThumbnail(cacheKey, dataUrl);

    return dataUrl;
  }

  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   * @param {string} driveId - ãƒ‰ãƒ©ã‚¤ãƒ–ID
   * @param {string} fileId - ãƒ•ã‚¡ã‚¤ãƒ«ID
   * @param {string} fileName - ãƒ•ã‚¡ã‚¤ãƒ«å
   */
  async downloadFile(driveId, fileId, fileName) {
    try {
      const url = `${this.apiBaseUrl}/${fileId}/download?drive_id=${encodeURIComponent(driveId)}`;

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        }
      });

      if (!response.ok) {
        throw new Error('Download failed');
      }

      const blob = await response.blob();

      // ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const downloadUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(downloadUrl);

    } catch (error) {
      console.error('[FilePreviewManager] Download failed:', error);
      alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
  }

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‰ã˜ã‚‹
   */
  closePreview() {
    if (this.modal) {
      this.modal.style.display = 'none';
      this.elements.container.innerHTML = '';

      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      if (this.onCloseCallback) {
        this.onCloseCallback();
      }
    }
  }

  /**
   * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  handleError(error) {
    this.elements.loading.style.display = 'none';
    this.elements.error.style.display = 'block';

    let errorMessage = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚';

    if (error.message.includes('NOT_CONFIGURED')) {
      errorMessage = 'Microsoft 365ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
    } else if (error.message.includes('PERMISSION_ERROR')) {
      errorMessage = 'ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
    } else if (error.message.includes('Network')) {
      errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    }

    this.elements.errorText.textContent = errorMessage;
  }

  // ============================================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // ============================================================

  /**
   * Blob to Data URL
   */
  async blobToDataUrl(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   */
  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã‚¢ã‚¤ã‚³ãƒ³å–å¾—
   */
  getFileTypeIcon(mimeType) {
    // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆData URLï¼‰
    const icons = {
      'application/pdf': 'data:image/svg+xml;base64,...', // PDF icon
      'image': 'data:image/svg+xml;base64,...',           // Image icon
      'office': 'data:image/svg+xml;base64,...',          // Office icon
      'unknown': 'data:image/svg+xml;base64,...'          // Generic file icon
    };

    if (mimeType.startsWith('image/')) return icons.image;
    if (mimeType.includes('pdf')) return icons.pdf;
    if (mimeType.includes('word') || mimeType.includes('excel') || mimeType.includes('powerpoint')) {
      return icons.office;
    }
    return icons.unknown;
  }

  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—
   */
  async getCachedThumbnail(cacheKey) {
    try {
      const cache = await caches.open('mks-thumbnails-v1');
      const response = await cache.match(cacheKey);
      if (response) {
        return await response.text();
      }
    } catch (error) {
      console.warn('[FilePreviewManager] Cache read failed:', error);
    }
    return null;
  }

  /**
   * ã‚µãƒ ãƒã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
   */
  async cacheThumbnail(cacheKey, dataUrl) {
    try {
      const cache = await caches.open('mks-thumbnails-v1');
      const response = new Response(dataUrl, {
        headers: { 'Content-Type': 'text/plain' }
      });
      await cache.put(cacheKey, response);
    } catch (error) {
      console.warn('[FilePreviewManager] Cache write failed:', error);
    }
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const filePreviewManager = new FilePreviewManager();

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆES Moduleå¯¾å¿œï¼‰
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { FilePreviewManager, filePreviewManager };
}
```

---

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

### 6.1 è„…å¨ãƒ¢ãƒ‡ãƒ«

#### 6.1.1 STRIDEåˆ†æ

| è„…å¨ | æ”»æ’ƒã‚·ãƒŠãƒªã‚ª | å¯¾ç­– |
|------|------------|------|
| **S**poofing | å½è£…ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«IDã«ã‚ˆã‚‹ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ | JWTèªè¨¼ã€ãƒ‰ãƒ©ã‚¤ãƒ–IDæ¤œè¨¼ |
| **T**ampering | iframeã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ | CSP `frame-src` åˆ¶é™ã€sandboxå±æ€§ |
| **R**epudiation | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®å¦èª | ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ï¼ˆ`log_access`ï¼‰ |
| **I**nformation Disclosure | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã®æ¼æ´© | çŸ­å‘½ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ1æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ |
| **D**enial of Service | å¤§é‡ã‚µãƒ ãƒã‚¤ãƒ«å–å¾— | Rate limitingï¼ˆ5req/sï¼‰ |
| **E**levation of Privilege | æ¨©é™å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ | RBAC `ms365_sync.file.preview` |

### 6.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…

#### 6.2.1 Content Security Policyï¼ˆCSPï¼‰

**æ—¢å­˜CSPä¿®æ­£** (app_v2.py):
```python
@app.after_request
def set_security_headers(response):
    response.headers['Content-Security-Policy'] = (
        "default-src 'self'; "
        "script-src 'self'; "
        "style-src 'self' 'unsafe-inline'; "
        # Office Online Embedè¨±å¯
        "frame-src 'self' https://view.officeapps.live.com; "
        # Graph APIç”»åƒå–å¾—è¨±å¯
        "img-src 'self' data: blob: https://graph.microsoft.com; "
        "connect-src 'self' https://graph.microsoft.com; "
        "worker-src 'self';"
    )
    return response
```

#### 6.2.2 XSSå¯¾ç­–

**DOM APIä½¿ç”¨ï¼ˆinnerHTMLç¦æ­¢ï¼‰**:
```javascript
// âŒ BAD: innerHTMLä½¿ç”¨
container.innerHTML = `<img src="${url}">`;

// âœ… GOOD: DOM APIä½¿ç”¨
const img = document.createElement('img');
img.src = url; // è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
container.appendChild(img);
```

#### 6.2.3 èªè¨¼ãƒ»èªå¯

**JWTæ¤œè¨¼**:
- ã™ã¹ã¦ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ `@jwt_required()` å¿…é ˆ
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ `localStorage.getItem('access_token')` ä½¿ç”¨

**RBACæ¨©é™**:
- å¿…è¦æ¨©é™: `ms365_sync.file.preview`
- ç®¡ç†è€…ã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»˜ä¸

### 6.3 ç›£æŸ»ãƒ­ã‚°

**è¨˜éŒ²å†…å®¹**:
```python
log_access(
    user_id=current_user_id,
    action="ms365_file.preview",
    resource_type="ms365_file",
    resource_id=file_id,
    status="success",
    details={
        "drive_id": drive_id,
        "file_name": file_name,
        "preview_type": preview_type,
        "ip_address": request.remote_addr,
        "user_agent": request.headers.get('User-Agent')
    }
)
```

---

## 7. PWAçµ±åˆä»•æ§˜

### 7.1 Service Workerã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

#### 7.1.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥åæ‹¡å¼µ

**sw.jsä¿®æ­£**:
```javascript
const CACHE_NAMES = {
  static: `${CACHE_PREFIX}static-${SW_VERSION}`,
  api: `${CACHE_PREFIX}api-${SW_VERSION}`,
  images: `${CACHE_PREFIX}images-${SW_VERSION}`,
  thumbnails: `${CACHE_PREFIX}thumbnails-${SW_VERSION}`,  // æ–°è¦è¿½åŠ 
  previews: `${CACHE_PREFIX}previews-${SW_VERSION}`       // æ–°è¦è¿½åŠ 
};

const CACHE_EXPIRATION = {
  static: 7 * 24 * 60 * 60 * 1000,
  apiSearch: 60 * 60 * 1000,
  apiDetail: 24 * 60 * 60 * 1000,
  images: 30 * 24 * 60 * 60 * 1000,
  thumbnails: 7 * 24 * 60 * 60 * 1000,     // 7æ—¥
  previews: 60 * 60 * 1000                 // 1æ™‚é–“
};
```

#### 7.1.2 Fetch Handlerãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**sw.jsä¿®æ­£**:
```javascript
self.addEventListener('fetch', (event) => {
  const url = new URL(event.request.url);

  // ã‚µãƒ ãƒã‚¤ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  if (url.pathname.includes('/thumbnail')) {
    event.respondWith(handleThumbnailRequest(event.request));
    return;
  }

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  if (url.pathname.includes('/preview')) {
    event.respondWith(handlePreviewRequest(event.request));
    return;
  }

  // ... æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
});

/**
 * ã‚µãƒ ãƒã‚¤ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆCache Firstï¼‰
 */
async function handleThumbnailRequest(request) {
  const cache = await caches.open(CACHE_NAMES.thumbnails);

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
  const cached = await cache.match(request);
  if (cached) {
    // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
    const cachedDate = new Date(cached.headers.get('date'));
    const now = new Date();
    if (now - cachedDate < CACHE_EXPIRATION.thumbnails) {
      return cached;
    }
  }

  // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å–å¾—
  try {
    const response = await fetch(request);
    if (response.ok) {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
      cache.put(request, response.clone());
    }
    return response;
  } catch (error) {
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿”ã™ï¼ˆæœŸé™åˆ‡ã‚Œã§ã‚‚ï¼‰
    if (cached) {
      return cached;
    }
    throw error;
  }
}

/**
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆNetwork Firstï¼‰
 */
async function handlePreviewRequest(request) {
  const cache = await caches.open(CACHE_NAMES.previews);

  try {
    const response = await fetch(request);
    if (response.ok) {
      cache.put(request, response.clone());
    }
    return response;
  } catch (error) {
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const cached = await cache.match(request);
    if (cached) {
      return cached;
    }
    throw error;
  }
}
```

### 7.2 CacheManagerçµ±åˆ

#### 7.2.1 LRUå‰Šé™¤å¯¾è±¡è¿½åŠ 

**cache-manager.jsä¿®æ­£**:
```javascript
class CacheManager {
  constructor() {
    this.maxCacheSize = 50 * 1024 * 1024;
    this.evictionThreshold = 45 * 1024 * 1024;
    this.dbName = 'mks-pwa';
    this.storeName = 'cache-metadata';

    // æ–°è¦è¿½åŠ 
    this.cacheNames = [
      'mks-static-v1.4.0',
      'mks-api-v1.4.0',
      'mks-images-v1.4.0',
      'mks-thumbnails-v1.4.0',
      'mks-previews-v1.4.0'
    ];
  }

  /**
   * ã‚µãƒ ãƒã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºå–å¾—
   */
  async getThumbnailCacheSize() {
    const cache = await caches.open('mks-thumbnails-v1.4.0');
    const requests = await cache.keys();

    let totalSize = 0;
    for (const request of requests) {
      const response = await cache.match(request);
      if (response) {
        const blob = await response.blob();
        totalSize += blob.size;
      }
    }
    return totalSize;
  }

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
   */
  async clearPreviewCache() {
    const cache = await caches.open('mks-previews-v1.4.0');
    const requests = await cache.keys();

    for (const request of requests) {
      await cache.delete(request);
    }

    console.log('[CacheManager] Preview cache cleared');
  }
}
```

### 7.3 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ

#### 7.3.1 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º

**file-preview.jsè¿½åŠ **:
```javascript
class FilePreviewManager {
  // ... æ—¢å­˜ã‚³ãƒ¼ãƒ‰

  /**
   * ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
   */
  isOffline() {
    return !navigator.onLine;
  }

  /**
   * ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å‡¦ç†
   */
  async showPreview(driveId, fileId, options = {}) {
    this.init();

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º
    if (this.isOffline()) {
      const cached = await this.getFromCache(driveId, fileId);
      if (cached) {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤º
        return this.renderCachedPreview(cached);
      } else {
        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è­¦å‘Š
        return this.showOfflineWarning();
      }
    }

    // ... é€šå¸¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
  }

  /**
   * ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è­¦å‘Šè¡¨ç¤º
   */
  showOfflineWarning() {
    this.elements.loading.style.display = 'none';
    this.elements.error.style.display = 'block';
    this.elements.errorText.textContent =
      'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã§ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
  }
}
```

---

## 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 8.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡

| ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º |
|-------------|----------------|---------------|------------|
| `NOT_CONFIGURED` | Microsoft 365 is not configured | 400 | Microsoft 365ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ |
| `MISSING_PARAMETER` | drive_id parameter is required | 400 | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ |
| `PERMISSION_ERROR` | Access denied | 403 | ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ |
| `FILE_NOT_FOUND` | File not found | 404 | ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ |
| `NETWORK_ERROR` | Network request failed | 0 | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ |
| `TIMEOUT_ERROR` | Request timeout | 0 | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ |
| `API_ERROR` | Internal server error | 500 | ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ |

### 8.2 ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

**è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡**:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼ˆ3å›ã¾ã§ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ1å›ã¾ã§ï¼‰

**ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡å¤–**:
- æ¨©é™ã‚¨ãƒ©ãƒ¼ï¼ˆ403ï¼‰
- Not Foundï¼ˆ404ï¼‰
- è¨­å®šã‚¨ãƒ©ãƒ¼ï¼ˆ400ï¼‰

**å®Ÿè£…ä¾‹**:
```javascript
async fetchWithRetry(url, options, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await fetch(url, options);
      if (response.ok) {
        return response;
      }

      // ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡å¤–ã‚¨ãƒ©ãƒ¼
      if ([400, 403, 404].includes(response.status)) {
        throw new Error(`HTTP ${response.status}`);
      }

    } catch (error) {
      if (i === maxRetries - 1) throw error;

      // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆ1s, 2s, 4sï¼‰
      const delay = Math.pow(2, i) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}
```

---

## 9. ãƒ†ã‚¹ãƒˆè¦ä»¶

### 9.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**å¯¾è±¡**: file-preview.jsï¼ˆJestï¼‰

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:
```javascript
describe('FilePreviewManager', () => {
  let manager;

  beforeEach(() => {
    manager = new FilePreviewManager();
    document.body.innerHTML = '';
  });

  test('åˆæœŸåŒ–ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹', () => {
    manager.init();
    expect(document.getElementById('file-preview-modal')).not.toBeNull();
  });

  test('showPreview()ã§APIãŒå‘¼ã°ã‚Œã‚‹', async () => {
    global.fetch = jest.fn(() =>
      Promise.resolve({
        ok: true,
        json: () => Promise.resolve({
          success: true,
          data: {
            preview_url: 'https://example.com',
            preview_type: 'office_embed'
          }
        })
      })
    );

    await manager.showPreview('drive-123', 'file-456');

    expect(global.fetch).toHaveBeenCalledWith(
      expect.stringContaining('/preview'),
      expect.any(Object)
    );
  });

  test('getThumbnailUrl()ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ã‚ã‚Œã‚‹', async () => {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¢ãƒƒã‚¯
    const cacheMock = {
      match: jest.fn(() => Promise.resolve(new Response('data:image/png;base64,...')))
    };
    global.caches = {
      open: jest.fn(() => Promise.resolve(cacheMock))
    };

    const dataUrl = await manager.getThumbnailUrl('drive-123', 'file-456');

    expect(dataUrl).toContain('data:image/png');
    expect(cacheMock.match).toHaveBeenCalled();
  });

  test('ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async () => {
    global.fetch = jest.fn(() => Promise.reject(new Error('Network error')));

    await manager.showPreview('drive-123', 'file-456');

    const errorElement = document.getElementById('preview-error');
    expect(errorElement.style.display).not.toBe('none');
  });

  test('Escapeã‚­ãƒ¼ã§é–‰ã˜ã‚‹', () => {
    manager.init();
    manager.modal.style.display = 'flex';

    const event = new KeyboardEvent('keydown', { key: 'Escape' });
    document.dispatchEvent(event);

    expect(manager.modal.style.display).toBe('none');
  });
});
```

### 9.2 çµ±åˆãƒ†ã‚¹ãƒˆ

**å¯¾è±¡**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆ

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:
1. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLå–å¾—â†’Office Embedè¡¨ç¤º
2. ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—â†’Data URLå¤‰æ›â†’imgè¡¨ç¤º
3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â†’ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
4. æ¨©é™ã‚¨ãƒ©ãƒ¼â†’403è¡¨ç¤º
5. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³â†’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

### 9.3 E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰

**file-preview.spec.js**:
```javascript
const { test, expect } = require('@playwright/test');

test.describe('MS365 File Preview', () => {
  test.beforeEach(async ({ page }) => {
    // ãƒ­ã‚°ã‚¤ãƒ³
    await page.goto('http://localhost:5200/login.html');
    await page.fill('#username', 'testuser');
    await page.fill('#password', 'TestPass123!');
    await page.click('#login-btn');
    await page.waitForURL('**/index.html');

    // MS365è¨­å®šç”»é¢ã¸
    await page.goto('http://localhost:5200/ms365-sync-settings.html');
  });

  test('ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    const thumbnails = await page.locator('.file-thumbnail');
    await expect(thumbnails.first()).toBeVisible({ timeout: 10000 });
  });

  test('ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã', async ({ page }) => {
    await page.locator('.file-thumbnail').first().click();

    const modal = page.locator('#file-preview-modal');
    await expect(modal).toBeVisible();

    const title = page.locator('#preview-title');
    await expect(title).not.toBeEmpty();
  });

  test('Officeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒiframeã§è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    await page.locator('.file-thumbnail').first().click();

    const iframe = page.frameLocator('#preview-container iframe');
    await expect(iframe).toBeVisible({ timeout: 10000 });
  });

  test('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒimgã‚¿ã‚°ã§è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯
    await page.locator('.file-thumbnail[data-mime-type^="image/"]').first().click();

    const img = page.locator('#preview-container img');
    await expect(img).toBeVisible();
  });

  test('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹', async ({ page }) => {
    await page.locator('.file-thumbnail').first().click();

    const [download] = await Promise.all([
      page.waitForEvent('download'),
      page.click('#preview-download-btn')
    ]);

    expect(download.suggestedFilename()).toBeTruthy();
  });

  test('é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‹', async ({ page }) => {
    await page.locator('.file-thumbnail').first().click();
    await page.click('#preview-close-btn');

    const modal = page.locator('#file-preview-modal');
    await expect(modal).not.toBeVisible();
  });

  test('Escapeã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‹', async ({ page }) => {
    await page.locator('.file-thumbnail').first().click();
    await page.keyboard.press('Escape');

    const modal = page.locator('#file-preview-modal');
    await expect(modal).not.toBeVisible();
  });

  test('ã‚¨ãƒ©ãƒ¼æ™‚ã«å†è©¦è¡Œãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    await page.route('**/api/v1/integrations/microsoft365/files/*/preview', route => {
      route.abort('failed');
    });

    await page.locator('.file-thumbnail').first().click();

    const errorMessage = page.locator('#preview-error');
    await expect(errorMessage).toBeVisible();

    const retryBtn = page.locator('#preview-retry-btn');
    await expect(retryBtn).toBeVisible();
  });
});
```

---

## 10. é‹ç”¨è¦ä»¶

### 10.1 ç›£è¦–é …ç›®

**Prometheusãƒ¡ãƒˆãƒªã‚¯ã‚¹è¿½åŠ **:
```python
# app_v2.pyè¿½åŠ 
from prometheus_client import Counter, Histogram

# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºå›æ•°
file_preview_requests_total = Counter(
    'file_preview_requests_total',
    'Total file preview requests',
    ['preview_type', 'status']
)

# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚é–“
file_preview_duration_seconds = Histogram(
    'file_preview_duration_seconds',
    'File preview display duration',
    ['preview_type']
)

# ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—å›æ•°
thumbnail_requests_total = Counter(
    'thumbnail_requests_total',
    'Total thumbnail requests',
    ['size', 'status']
)

# ã‚¨ãƒ©ãƒ¼å›æ•°
file_preview_errors_total = Counter(
    'file_preview_errors_total',
    'Total file preview errors',
    ['error_type']
)
```

**Grafanaãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¿½åŠ ãƒ‘ãƒãƒ«**:
```json
{
  "title": "File Preview Metrics",
  "panels": [
    {
      "title": "Preview Requests (Rate)",
      "targets": [
        {
          "expr": "rate(file_preview_requests_total[5m])"
        }
      ]
    },
    {
      "title": "Preview Duration (p95)",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, file_preview_duration_seconds)"
        }
      ]
    },
    {
      "title": "Error Rate",
      "targets": [
        {
          "expr": "rate(file_preview_errors_total[5m])"
        }
      ]
    }
  ]
}
```

### 10.2 ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«

**Prometheus Alertmanagerè¨­å®š**:
```yaml
groups:
  - name: file_preview
    rules:
      - alert: HighPreviewErrorRate
        expr: rate(file_preview_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "File preview error rate is high"
          description: "Error rate: {{ $value }}"

      - alert: SlowPreviewResponse
        expr: histogram_quantile(0.95, file_preview_duration_seconds) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "File preview is slow (p95 > 5s)"
```

### 10.3 ãƒ­ã‚°å‡ºåŠ›

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°** (app_v2.py):
```python
logger.info(
    f"File preview requested: user={current_user_id}, "
    f"drive_id={drive_id}, file_id={file_id}, "
    f"preview_type={preview_type}"
)
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚°** (file-preview.js):
```javascript
console.log('[FilePreviewManager] Preview displayed:', {
  driveId,
  fileId,
  previewType: this.currentPreviewType,
  loadTime: Date.now() - startTime
});
```

---

## 11. å®Ÿè£…è¨ˆç”»

### 11.1 å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| Week | ã‚¿ã‚¹ã‚¯ | æ‹…å½“Agent | æˆæœç‰© | å·¥æ•° |
|------|--------|-----------|--------|------|
| Week 2 | file-preview.jså®Ÿè£… | code-implementer | file-preview.js (500è¡Œ) | 4h |
| Week 2 | PWAçµ±åˆ | code-implementer | sw.jsä¿®æ­£ã€cache-manager.jsä¿®æ­£ | 2h |
| Week 3 | E2Eãƒ†ã‚¹ãƒˆå®Ÿè£… | test-designer | file-preview.spec.js (400è¡Œ) | 3h |
| Week 3 | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ | ops-runbook | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰ (800è¡Œ) | 2h |
| Week 3 | çµ±åˆãƒ†ã‚¹ãƒˆ | test-reviewer | ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ | 1h |

**åˆè¨ˆå·¥æ•°**: 12æ™‚é–“

### 11.2 ä¾å­˜é–¢ä¿‚

```mermaid
graph LR
    A[Phase D-4 Week 1å®Œäº†] --> B[file-preview.jså®Ÿè£…]
    A --> C[PWAçµ±åˆ]
    B --> D[E2Eãƒ†ã‚¹ãƒˆ]
    C --> D
    D --> E[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ]
    E --> F[Phase E-4å®Œäº†]
```

### 11.3 å®Œäº†å®šç¾©ï¼ˆDefinition of Doneï¼‰

- âœ… file-preview.jså®Ÿè£…å®Œäº†ï¼ˆ500è¡Œï¼‰
- âœ… PWAçµ±åˆå®Œäº†ï¼ˆsw.js, cache-manager.jsä¿®æ­£ï¼‰
- âœ… E2Eãƒ†ã‚¹ãƒˆ8ä»¶PASS
- âœ… ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼PASS
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰ä½œæˆå®Œäº†
- âœ… ç›£æŸ»ãƒ­ã‚°å‹•ä½œç¢ºèª
- âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œç¢ºèª

---

## 12. ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|------|------|
| **Office Online Embed** | Microsoft Officeãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’Webãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã™ã‚‹ãŸã‚ã®iframeåŸ‹ã‚è¾¼ã¿URL |
| **Graph API** | Microsoft 365ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®RESTful API |
| **Data URL** | Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥è¡¨ç¤ºã™ã‚‹ãŸã‚ã®URLå½¢å¼ |
| **Service Worker** | ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ä½œã™ã‚‹JavaScriptãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆPWAã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ã«ä½¿ç”¨ï¼‰ |
| **LRU (Least Recently Used)** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€‚æœ€ã‚‚å¤ã„ã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤ |
| **CSP (Content Security Policy)** | XSSæ”»æ’ƒã‚’é˜²ããŸã‚ã®HTTPãƒ˜ãƒƒãƒ€ãƒ¼ |
| **RBAC (Role-Based Access Control)** | ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ |
| **WCAG (Web Content Accessibility Guidelines)** | Webã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ |

---

## ä»˜éŒ²A: APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### A.1 ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLå–å¾—API

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
GET /api/v1/integrations/microsoft365/files/{file_id}/preview
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
| åå‰ | å‹ | å¿…é ˆ | èª¬æ˜ |
|------|-----|------|------|
| file_id | string | âœ… | ãƒ•ã‚¡ã‚¤ãƒ«IDï¼ˆãƒ‘ã‚¹ï¼‰ |
| drive_id | string | âœ… | ãƒ‰ãƒ©ã‚¤ãƒ–IDï¼ˆã‚¯ã‚¨ãƒªï¼‰ |

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "preview_url": "https://view.officeapps.live.com/op/embed.aspx?src=...",
    "preview_type": "office_embed",
    "mime_type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    "file_name": "estimate.xlsx",
    "file_size": 102400
  }
}
```

### A.2 ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—API

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
GET /api/v1/integrations/microsoft365/files/{file_id}/thumbnail
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
| åå‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|------|-----|------|-----------|------|
| file_id | string | âœ… | - | ãƒ•ã‚¡ã‚¤ãƒ«IDï¼ˆãƒ‘ã‚¹ï¼‰ |
| drive_id | string | âœ… | - | ãƒ‰ãƒ©ã‚¤ãƒ–IDï¼ˆã‚¯ã‚¨ãƒªï¼‰ |
| size | string | âŒ | "large" | ã‚µãƒ ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆ"small" \| "medium" \| "large"ï¼‰ |

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```
Content-Type: image/png
(Binary data)
```

### A.3 ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰API

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
GET /api/v1/integrations/microsoft365/files/{file_id}/download
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
| åå‰ | å‹ | å¿…é ˆ | èª¬æ˜ |
|------|-----|------|------|
| file_id | string | âœ… | ãƒ•ã‚¡ã‚¤ãƒ«IDï¼ˆãƒ‘ã‚¹ï¼‰ |
| drive_id | string | âœ… | ãƒ‰ãƒ©ã‚¤ãƒ–IDï¼ˆã‚¯ã‚¨ãƒªï¼‰ |

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```
Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
Content-Disposition: attachment; filename=contract.docx
(Binary data)
```

---

## ä»˜éŒ²B: ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

### B.1 ms365-sync.jsçµ±åˆä¾‹

**ms365-sync-settings.htmlä¿®æ­£ç®‡æ‰€**:
```javascript
// ãƒ•ã‚¡ã‚¤ãƒ«: webui/ms365-sync.js

/**
 * åŒæœŸå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’ç”Ÿæˆ
 */
function renderSyncHistoryRow(history) {
  const row = document.createElement('tr');

  // 1. ã‚µãƒ ãƒã‚¤ãƒ«ã‚»ãƒ«
  const thumbnailCell = document.createElement('td');
  const thumbnailImg = document.createElement('img');
  thumbnailImg.className = 'file-thumbnail';
  thumbnailImg.alt = history.file_name;
  thumbnailImg.style.width = '48px';
  thumbnailImg.style.height = '48px';
  thumbnailImg.style.objectFit = 'cover';
  thumbnailImg.style.cursor = 'pointer';
  thumbnailImg.style.borderRadius = '4px';

  // ã‚µãƒ ãƒã‚¤ãƒ«èª­ã¿è¾¼ã¿
  filePreviewManager.getThumbnailUrl(history.drive_id, history.file_id, 'small')
    .then(dataUrl => {
      thumbnailImg.src = dataUrl;
    })
    .catch(() => {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      thumbnailImg.src = filePreviewManager.getFileTypeIcon(history.mime_type);
    });

  // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
  thumbnailImg.addEventListener('click', () => {
    filePreviewManager.showPreview(history.drive_id, history.file_id, {
      fileName: history.file_name,
      onClose: () => {
        console.log('Preview closed');
      }
    });
  });

  thumbnailCell.appendChild(thumbnailImg);
  row.appendChild(thumbnailCell);

  // 2. ãƒ•ã‚¡ã‚¤ãƒ«åã‚»ãƒ«
  const nameCell = document.createElement('td');
  const nameLink = document.createElement('a');
  nameLink.href = '#';
  nameLink.textContent = history.file_name;
  nameLink.addEventListener('click', (e) => {
    e.preventDefault();
    filePreviewManager.showPreview(history.drive_id, history.file_id, {
      fileName: history.file_name
    });
  });
  nameCell.appendChild(nameLink);
  row.appendChild(nameCell);

  // 3. åŒæœŸæ—¥æ™‚ã‚»ãƒ«
  const dateCell = document.createElement('td');
  dateCell.textContent = formatDateTime(history.synced_at);
  row.appendChild(dateCell);

  // 4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ«
  const statusCell = document.createElement('td');
  const statusBadge = document.createElement('span');
  statusBadge.className = `badge badge-${history.status}`;
  statusBadge.textContent = history.status;
  statusCell.appendChild(statusBadge);
  row.appendChild(statusCell);

  // 5. æ“ä½œã‚»ãƒ«
  const actionCell = document.createElement('td');
  const downloadBtn = document.createElement('button');
  downloadBtn.className = 'btn-icon';
  downloadBtn.textContent = 'â†“';
  downloadBtn.title = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
  downloadBtn.addEventListener('click', () => {
    filePreviewManager.downloadFile(history.drive_id, history.file_id, history.file_name);
  });
  actionCell.appendChild(downloadBtn);
  row.appendChild(actionCell);

  return row;
}
```

---

## ä»˜éŒ²C: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### C.1 ã‚ˆãã‚ã‚‹å•é¡Œ

#### å•é¡Œ1: Office EmbedãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç—‡çŠ¶**: iframeãŒç©ºç™½ã®ã¾ã¾

**åŸå› **:
- CSP `frame-src` åˆ¶é™
- Office Onlineã‚µãƒ¼ãƒ“ã‚¹éšœå®³

**è§£æ±ºç­–**:
1. CSPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèª: `frame-src https://view.officeapps.live.com`
2. ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§CSPã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
3. [Office Online Service Health](https://status.office.com/)ã‚’ç¢ºèª

#### å•é¡Œ2: ã‚µãƒ ãƒã‚¤ãƒ«ãŒ404ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **:
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒ ãƒã‚¤ãƒ«éå¯¾å¿œï¼ˆ.zipç­‰ï¼‰
- Graph APIæ¨©é™ä¸è¶³

**è§£æ±ºç­–**:
1. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚’ç¢ºèª
2. Azure ADã‚¢ãƒ—ãƒªã®æ¨©é™ç¢ºèª: `Files.Read.All`

#### å•é¡Œ3: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã‹ãªã„

**ç—‡çŠ¶**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› **:
- Service Workeræœªç™»éŒ²
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé™åˆ‡ã‚Œ

**è§£æ±ºç­–**:
1. Chrome DevTools â†’ Application â†’ Service Workers ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèª: Application â†’ Cache Storage
3. `sw.js` ã® `CACHE_EXPIRATION` è¨­å®šã‚’ç¢ºèª

---

## æ‰¿èª

| å½¹å‰² | æ°å | æ‰¿èªæ—¥ | ç½²å |
|------|------|--------|------|
| **ä½œæˆè€…** | spec-planner (Claude AI) | 2026-02-06 | - |
| **ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼** | arch-reviewer | æœªå®Ÿæ–½ | - |
| **æ‰¿èªè€…** | team-lead | æœªå®Ÿæ–½ | - |

---

**å¤‰æ›´å±¥æ­´**:

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|-----------|------|---------|--------|
| 1.0.0 | 2026-02-06 | åˆç‰ˆä½œæˆ | spec-planner |

---

**End of Document**
