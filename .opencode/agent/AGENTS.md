# OpenCode SubAgent 運用ガイド

このドキュメントは、Mirai-Knowledge-Systems プロジェクトで使用する7体のサブエージェントの運用ルールを定義します。

## サブエージェント一覧

| エージェント | 役割 | 主な作業 |
|-------------|------|----------|
| `spec-planner` | 要件整理・タスク分解 | チケット設計、機能要件整理 |
| `arch-reviewer` | アーキテクチャ・設計レビュー | 設計レビュー、技術選定 |
| `code-implementer` | 実装担当 | コード実装、設定ファイル編集 |
| `test-designer` | テスト設計担当 | テストケース設計、テストコード実装 |
| `ci-specialist` | GitHub Actions 専任 | CI/CD ワークフロー設計・最適化 |
| `sec-auditor` | セキュリティ・Lint・権限レビュー | セキュリティ監査、コード品質チェック |
| `ops-runbook` | 運用・SRE/Runbook 担当 | 運用手順、障害対応ドキュメント作成 |

## 運用フロー

### 新機能開発

```
1. 要件整理（spec-planner）
   ├─ 機能要件の整理
   ├─ タスク分解
   └─ Issue 作成

2. 設計レビュー（arch-reviewer）
   ├─ アーキテクチャ影響評価
   ├─ 技術的課題の提示
   └─ 推奨事項の提案

3. 実装（code-implementer）
   ├─ コード実装
   ├─ テストコード追加（test-designer に依頼）
   └─ 動作確認

4. テスト（test-designer）
   ├─ テストケース設計
   ├─ テストコード実装
   └─ カバレッジ測定

5. CI/CD（ci-specialist）
   ├─ ワークフロー最適化
   ├─ 自動テスト設定
   └─ デプロイ設定

6. セキュリティ監査（sec-auditor）
   ├─ セキュリティチェック
   ├─ コード品質確認
   └─ 権限設定レビュー

7. 運用手順（ops-runbook）
   ├─ アラート設定
   ├─ 障害対応フロー
   └─ 切り戻し手順
```

### バグ修正

```
1. バグ分析（spec-planner）
   ├─ 再現手順の整理
   ├─ 原因分析の方向性
   └─ 修正範囲の特定

2. 実装（code-implementer）
   ├─ 修正実装
   └─ 回帰テスト

3. テスト（test-designer）
   ├─ バグ再現テスト追加
   └─ 回帰テスト追加

4. CI/CD（ci-specialist）
   └─ 自動テスト設定

5. セキュリティ監査（sec-auditor）
   └─ 修正のセキュリティ影響確認
```

### リファクタリング

```
1. 設計レビュー（arch-reviewer）
   ├─ 影響範囲の特定
   └─ 推奨事項の提示

2. 実装（code-implementer）
   ├─ リファクタリング実装
   └─ 動作確認

3. テスト（test-designer）
   ├─ 既存テストの変更確認
   └─ 新規テスト追加

4. セキュリティ監査（sec-auditor）
   └─ セキュリティ影響確認
```

## 各エージェントの責任範囲

### spec-planner
- **責任**: 要件整理、タスク分解、チケット設計
- **許可**: ドキュメント・メモの編集（毎回確認）
- **禁止**: bash 実行
- **使用タイミング**: 新機能開発、バグ修正、ドキュメント更新

### arch-reviewer
- **責任**: アーキテクチャ・設計レビュー
- **許可**: 設計ドキュメントの読み取り・編集（毎回確認）
- **禁止**: bash 実行、コード実装
- **使用タイミング**: コード変更前の設計レビュー

### code-implementer
- **責任**: コード・設定ファイルの実装
- **許可**: コード編集（自動許可）、bash（毎回確認）
- **禁止**: アーキテクチャの重大な変更、セキュリティ設定変更
- **使用タイミング**: 設計レビュー後の実装

### test-designer
- **責任**: テスト観点抽出、テストコード実装
- **許可**: テストコード編集（自動許可）、bash（毎回確認）
- **禁止**: 製品コードの実装、CI 設定
- **使用タイミング**: 実装後のテスト設計・実装

### ci-specialist
- **責任**: GitHub Actions CI/CD の設計・最適化
- **許可**: ワークフロー編集（自動許可）、bash（毎回確認）
- **禁止**: アプリケーションコード実装、テスト実装
- **使用タイミング**: CI/CD ワークフローの設計・最適化

### sec-auditor
- **責任**: セキュリティ・Lint・権限レビュー
- **許可**: 設定ファイルの読み取り・編集（毎回確認）
- **禁止**: bash 実行、コード実装、CI 設定
- **使用タイミング**: コード変更前のセキュリティ監査

### ops-runbook
- **責任**: 運用手順、障害対応ドキュメント作成
- **許可**: ドキュメント編集（自動許可）
- **禁止**: bash 実行、コード実装
- **使用タイミング**: 運用手順の作成・更新

## メンション運用

各フェーズで必ず対応するサブエージェントを使用することを推奨します。

### 新機能開発時
1. `@spec-planner` - 要件整理
2. `@arch-reviewer` - 設計レビュー（必須）
3. `@code-implementer` - 実装
4. `@test-designer` - テスト設計
5. `@ci-specialist` - CI/CD 設定
6. `@sec-auditor` - セキュリティ監査（必須）
7. `@ops-runbook` - 運用手順

### バグ修正時
1. `@spec-planner` - バグ分析
2. `@code-implementer` - 修正実装
3. `@test-designer` - テスト追加
4. `@sec-auditor` - セキュリティ監査

### CI/CD 設定変更時
1. `@ci-specialist` - ワークフロー設計
2. `@sec-auditor` - 権限設定レビュー（必須）

## 重要ルール

### 必須レビュー
- **設計レビュー**: コード変更前に `@arch-reviewer` に依頼
- **セキュリティ監査**: 本番デプロイ前に `@sec-auditor` に依頼
- **CI 設定レビュー**: GitHub Actions 変更時に `@sec-auditor` に依頼

### 禁止事項
- **code-implementer** はアーキテクチャの重大な変更をしない
- **code-implementer** はセキュリティ設定を変更しない
- **sec-auditor** はコード実装をしない
- **arch-reviewer** はテスト実装をしない

### 協力関係
- **code-implementer** と **test-designer** は密に連携（実装とテスト）
- **arch-reviewer** と **sec-auditor** は協力（設計とセキュリティ）
- **ci-specialist** と **sec-auditor** は連携（CI 権限設定）

## プロジェクト特有の考慮事項

### 技術スタック
- **バックエンド**: Python 3.8+ / Flask
- **フロントエンド**: HTML/CSS/JavaScript（静的WebUI）
- **データベース**: SQLite（開発）/ PostgreSQL（本番）
- **認証**: JWT + RBAC
- **CI/CD**: GitHub Actions（Docker 不使用）

### 環境
- **開発環境**: http://localhost:5100
- **本番環境**: systemd + Gunicorn + HTTPS

### 運用要件
- 現場でのオフライン環境対応
- 複数の協力会社からのアクセス管理
- 監査ログの長期保存

## 参考資料

- OpenCode ドキュメント: https://opencode.ai
- 各エージェントの詳細: `.opencode/agent/<エージェント名>.md`
- プロジェクト README: `README.md`
- 運用スクリプト: `docs/11_運用保守(Operations)/11_運用スクリプト一覧.md`

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|----------|----------|
| 2026-01-09 | 1.0 | 初版作成、7体サブエージェント有効化 |
