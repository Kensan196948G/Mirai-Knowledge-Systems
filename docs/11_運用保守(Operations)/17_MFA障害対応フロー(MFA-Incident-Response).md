# 17_MFA障害対応フロー(MFA-Incident-Response)

## 概要
MFA関連の障害発生時の対応手順を記載します。MFA障害はユーザーのログインを阻害するため、迅速な対応が重要です。

## 障害レベル定義

| レベル | 定義 | 対応時間 | 例 |
|--------|------|----------|-----|
| P0 | 全ユーザーのMFA認証が失敗 | 15分以内 | MFAサービス完全停止 |
| P1 | 多数ユーザーのMFA認証失敗 | 1時間以内 | MFA設定データ破損 |
| P2 | 特定ユーザーのMFA問題 | 4時間以内 | 個別MFA設定異常 |
| P3 | MFA関連の軽微な問題 | 1営業日以内 | 表示エラー |

## 障害対応フロー

### 1. 障害検知
- **アラート受信**: MFA失敗率アラート
- **ユーザー報告**: ログインできないという報告
- **監視ダッシュボード**: MFA関連メトリクス異常

### 2. 影響評価
- **影響範囲**: 全ユーザー / 特定ユーザーグループ / 個別ユーザー
- **影響ユーザー数**: 障害影響を受けるユーザー数
- **ビジネス影響**: 高(全ユーザー影響) / 中(多数ユーザー影響) / 低(少数ユーザー影響)

### 3. 即時対応

#### P0/P1レベル障害
1. **オンコール起動**
   - SREチームと開発チームに通知
   - ステークホルダーへの状況報告

2. **サービス一時無効化**
   ```bash
   # MFAを一時的にバイパス（緊急時のみ）
   UPDATE system_settings SET mfa_required = false WHERE setting_key = 'global_mfa';
   sudo systemctl restart mks-backend
   ```

3. **バックアップからのリストア**
   ```bash
   # MFA設定データのバックアップからリストア
   pg_restore -U mks_user -d mks_db /backup/mfa_settings.dump
   ```

#### P2レベル障害
1. **個別ユーザー対応**
   - MFA設定のリセット
   - バックアップコードの発行

2. **ログ分析**
   - 該当ユーザーのMFAログを確認
   - エラーパターンの特定

### 4. 根本原因分析

#### ログ確認
```bash
# MFA関連ログの確認
grep "MFA" /var/log/mks/mfa.log | tail -50

# 認証失敗ログ
grep "MFA_FAILED" /var/log/mks/auth.log | tail -20
```

#### データベース確認
```sql
-- MFA設定の整合性チェック
SELECT COUNT(*) FROM users WHERE mfa_enabled = true;
SELECT COUNT(*) FROM mfa_secrets WHERE secret IS NULL;
```

#### 外部サービス確認
- TOTPプロバイダーのステータス確認
- NTPサーバーの同期状態確認

### 5. 恒久対策

#### コード修正
- MFAライブラリのアップデート
- エラーハンドリングの改善

#### 設定変更
- MFAタイムアウトの調整
- バックアップコード数の増加

#### テスト追加
- MFA障害シナリオのテストケース追加
- 自動化テストの実装

### 6. 事後レビュー

#### 障害レポート作成
```markdown
## MFA障害レポート

### 発生日時
[日時]

### 影響範囲
- 影響ユーザー数: [数]
- 影響期間: [時間]

### 根本原因
[原因の詳細]

### 対応内容
[対応手順の詳細]

### 改善策
1. [改善策1]
2. [改善策2]
```

#### チーム共有
- 障害原因と対応の共有
- 改善策の実施計画
- 再発防止策の検討

## 特定の障害パターン

### パターン1: TOTPコード無効
**症状**: 常に「無効なコード」エラー
**原因**: デバイス時刻のずれ
**対応**:
1. NTP同期の確認
2. ユーザーへの時刻同期指示
3. MFA設定のリセット

### パターン2: MFA設定データ消失
**症状**: ログイン時にMFA設定画面が表示されない
**原因**: データベース破損または同期エラー
**対応**:
1. バックアップからのリストア
2. データ整合性チェック
3. 冗長化設定の見直し

### パターン3: バックアップコード使用不能
**症状**: バックアップコードが無効
**原因**: コードの誤用またはデータ破損
**対応**:
1. 新規バックアップコードの発行
2. 使用履歴の確認
3. コード生成ロジックの検証

### パターン4: MFAサービス高負荷
**症状**: MFA認証の遅延
**原因**: 同時アクセス集中
**対応**:
1. レートリミットの調整
2. キャッシュの導入
3. 負荷分散設定の見直し

## 復旧後の確認

### 機能確認
- [ ] MFA認証の正常動作
- [ ] バックアップコードの発行
- [ ] MFA設定のリセット
- [ ] ログの正常記録

### 監視確認
- [ ] アラート設定の正常動作
- [ ] メトリクスの正常収集
- [ ] ダッシュボードの更新

### ユーザー通知
- 障害復旧の通知
- 影響を受けたユーザーのフォローアップ
- 再発防止策の説明