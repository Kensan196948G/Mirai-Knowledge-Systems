# 自動エラー検知・修復システム（5分間隔・無限ループ）仕様書

**ドキュメントバージョン**: 1.0.0  
**最終更新日**: 2026-01-31  
**管理者**: Mirai Knowledge Systems 運用チーム

---

## 目次

1. [システム概要](#システム概要)
2. [アーキテクチャ](#アーキテクチャ)
3. [コンポーネント構成](#コンポーネント構成)
4. [動作フロー](#動作フロー)
5. [エラー検知機能](#エラー検知機能)
6. [自動修復アクション](#自動修復アクション)
7. [ヘルスチェック機能](#ヘルスチェック機能)
8. [GitHub Actions連携](#github-actions連携)
9. [設定ファイル詳細](#設定ファイル詳細)
10. [運用ガイド](#運用ガイド)
11. [セキュリティ考慮事項](#セキュリティ考慮事項)
12. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

### 目的

「自動エラー検知・修復システム」は、Mirai Knowledge Systemsの安定稼働を維持するための**永続的な監視・自動修復デーモン**です。システムは24時間365日稼働し、エラーを自動検知して可能な場合は自動的に修復を行います。

### 基本仕様

| 項目 | 仕様 |
|------|------|
| **検知ループ回数** | 15回/イテレーション |
| **待機時間** | 5分（イテレーション間） |
| **動作モード** | 無限ループ（永続実行） |
| **実行間隔** | 約2秒（ループ間）、5分（イテレーション間） |
| **最大リトライ** | 3回（同一エラー） |
| **クールダウン** | 300秒（5分）（同一エラー再修復禁止） |

### システム構成図

```
┌──────────────────────────────────────────────────────────────────────┐
│                 自動エラー検知・修復システム                           │
│                  (5分間隔・無限ループ)                                │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  GitHub Actions Workflow                                         │ │
│  │  (.github/workflows/auto-error-fix-continuous.yml)              │ │
│  │  ┌─────────────────────────────────────────────────────────┐    │ │
│  │  │  schedule: */5 * * * * (毎5分)                          │    │ │
│  │  │  → 15回ループ実行 → 結果レポート → Issue作成           │    │ │
│  │  └─────────────────────────────────────────────────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  systemdサービス (auto-fix-daemon.service)                      │ │
│  │  ┌─────────────────────────────────────────────────────────┐    │ │
│  │  │  auto_fix_daemon.py --continuous                        │    │ │
│  │  │  ・15回ループ → 5分待機 → 15回ループ → 5分待機...      │    │ │
│  │  │  ・永続実行（Restart=always）                           │    │ │
│  │  └─────────────────────────────────────────────────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │  コアコンポーネント                                        │     │
│  │  ┌───────────────┐  ┌────────────────┐  ┌──────────────┐  │     │
│  │  │auto_fix_      │  │health_         │  │error_        │  │     │
│  │  │daemon.py      │  │monitor.py      │  │patterns.json │  │     │
│  │  │               │  │                │  │              │  │     │
│  │  │・エラー検知   │  │・ヘルスチェック│  │・エラー定義  │  │     │
│  │  │・自動修復     │  │・メトリクス収集│  │・修復設定    │  │     │
│  │  │・ログ管理     │  │・アラート送信  │  │              │  │     │
│  │  └───────────────┘  └────────────────┘  └──────────────┘  │     │
│  └────────────────────────────────────────────────────────────┘     │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  監視対象                                                        │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │ │
│  │  │Flask API │ │PostgreSQL│ │  Redis   │ │  ファイルシステム │   │ │
│  │  │:5100     │ │:5432     │ │:6379     │ │  /data, /logs     │   │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## アーキテクチャ

### 実行モデル

システムは2つの実行モデルをサポートします：

#### 1. ローカル実行（systemdサービス）

```
┌────────────────────────────────────────────────────────────┐
│                     systemdサービス                         │
├────────────────────────────────────────────────────────────┤
│  [開始]                                                     │
│     │                                                       │
│     ▼                                                       │
│  ┌─────────────────────────┐                               │
│  │ イテレーション N 開始    │ ◄──────────────────────────┐ │
│  └──────────┬──────────────┘                              │ │
│             │                                              │ │
│             ▼                                              │ │
│  ┌─────────────────────────┐                              │ │
│  │   検知サイクル (1-15)    │ ◄─────────────────────┐    │ │
│  │   ・ヘルスチェック       │                        │    │ │
│  │   ・ログスキャン         │                        │    │ │
│  │   ・エラー検知           │                        │    │ │
│  │   ・自動修復             │                        │    │ │
│  └──────────┬──────────────┘                        │    │ │
│             │                                        │    │ │
│             ▼                                        │    │ │
│        [2秒待機]                                     │    │ │
│             │                                        │    │ │
│             ▼                                        │    │ │
│     サイクル < 15?  ──Yes──────────────────────────┘    │ │
│             │                                              │ │
│            No                                              │ │
│             │                                              │ │
│             ▼                                              │ │
│  ┌─────────────────────────┐                              │ │
│  │    5分間待機             │                              │ │
│  └──────────┬──────────────┘                              │ │
│             │                                              │ │
│             └──────────────────────────────────────────────┘ │
│                                                             │
│  [無限ループ - SIGTERMで停止]                               │
└────────────────────────────────────────────────────────────┘
```

#### 2. クラウド実行（GitHub Actions）

```
┌────────────────────────────────────────────────────────────┐
│                  GitHub Actions Workflow                    │
├────────────────────────────────────────────────────────────┤
│  [schedule: */5 * * * *]  (毎5分トリガー)                   │
│          │                                                  │
│          ▼                                                  │
│  ┌─────────────────────────┐                               │
│  │ ワークフロー起動         │                               │
│  │ ・チェックアウト         │                               │
│  │ ・Python環境セットアップ │                               │
│  │ ・PostgreSQL起動         │                               │
│  │ ・Redis起動              │                               │
│  └──────────┬──────────────┘                               │
│             │                                               │
│             ▼                                               │
│  ┌─────────────────────────┐                               │
│  │  15回ループ実行          │ ◄────────┐                   │
│  │  ・ヘルスチェック        │          │                   │
│  │  ・テスト実行            │          │                   │
│  │  ・ログ確認              │          │                   │
│  │  ・自動修復              │          │                   │
│  └──────────┬──────────────┘          │                   │
│             │                          │                   │
│             ▼                          │                   │
│        ループ < 15?  ──Yes──────────────┘                   │
│             │                                               │
│            No                                               │
│             │                                               │
│             ▼                                               │
│  ┌─────────────────────────┐                               │
│  │  結果レポート生成        │                               │
│  │  ・GitHubIssue作成       │                               │
│  │  ・Artifact保存          │                               │
│  └──────────┬──────────────┘                               │
│             │                                               │
│             ▼                                               │
│         [終了]                                              │
│                                                             │
│  ※5分後にcronで再実行                                       │
└────────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成

### ファイル配置

```
Mirai-Knowledge-Systems/
├── .github/
│   └── workflows/
│       └── auto-error-fix-continuous.yml   # GitHub Actions定義
│
├── backend/
│   ├── scripts/
│   │   ├── auto_fix_daemon.py              # メイン修復デーモン
│   │   ├── health_monitor.py               # ヘルスチェック
│   │   ├── error_patterns.json             # エラーパターン設定
│   │   ├── auto-fix-daemon.service         # systemdサービス定義
│   │   ├── test_auto_fix.py                # テストコード
│   │   └── README.md                       # スクリプトドキュメント
│   └── logs/
│       ├── auto_fix.log                    # 修復ログ
│       ├── alerts.log                      # アラートログ
│       └── app.log                         # アプリケーションログ
│
├── scripts/
│   ├── health-monitor.sh                   # シェルベースモニター
│   ├── health-check.sh                     # 基本ヘルスチェック
│   └── production-health-check.sh          # 本番環境チェック
│
├── monitoring/
│   ├── prometheus.yml                      # Prometheus設定
│   ├── alert_rules.yml                     # アラートルール
│   └── grafana-dashboard.json              # Grafanaダッシュボード
│
└── docs/
    └── 11_運用保守(Operations)/
        └── 19_自動エラー検知修復システム仕様書.md  # この文書
```

### コンポーネント詳細

#### 1. auto_fix_daemon.py

**役割**: エラー自動検知・修復のメインデーモン

**クラス構成**:
```python
class AutoFixDaemon:
    """エラー自動検知・自動修復デーモン"""
    
    def __init__(self, config_path, log_file):
        # 設定読み込み、ロギング設定、ヘルスモニター初期化
        
    def scan_logs(self, log_paths: List[str]) -> List[Dict]:
        # ログファイルスキャン（最新1000行）
        
    def execute_action(self, action: Dict) -> bool:
        # 修復アクション実行
        
    def auto_fix_error(self, error: Dict) -> bool:
        # エラー修復のオーケストレーション
        
    def run_detection_cycle(self, cycle_num: int):
        # 1回の検知サイクル
        
    def run_continuous(self, loop_count=15, wait_minutes=5):
        # 継続的監視（無限ループ）
```

#### 2. health_monitor.py

**役割**: システムヘルスチェックとメトリクス収集

**機能一覧**:
- PostgreSQL接続チェック
- Redis接続チェック
- ディスク容量チェック
- メモリ使用量チェック
- HTTPエンドポイントチェック
- ポート使用状況チェック
- システムメトリクス収集

#### 3. error_patterns.json

**役割**: エラーパターンと修復アクションの定義

**構造**:
```json
{
  "error_patterns": [...],     // エラーパターン定義
  "health_checks": [...],      // ヘルスチェック設定
  "auto_fix_config": {...}     // 自動修復設定
}
```

---

## 動作フロー

### 1回の検知サイクルの処理フロー

```
┌─────────────────────────────────────────────────────────────┐
│               検知サイクル処理フロー                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [サイクル開始]                                              │
│        │                                                     │
│        ▼                                                     │
│  ┌────────────────────┐                                     │
│  │ 1. ヘルスチェック   │                                     │
│  │    実行             │                                     │
│  │    ・DB接続         │                                     │
│  │    ・Redis接続      │                                     │
│  │    ・ディスク容量   │                                     │
│  │    ・メモリ使用率   │                                     │
│  │    ・HTTP応答       │                                     │
│  └─────────┬──────────┘                                     │
│            │                                                 │
│            ▼                                                 │
│  ┌────────────────────┐                                     │
│  │ 2. ログファイル     │                                     │
│  │    スキャン         │                                     │
│  │    ・app.log        │                                     │
│  │    ・auto_fix.log   │                                     │
│  │    ・syslog         │                                     │
│  │    ・postgresql.log │                                     │
│  └─────────┬──────────┘                                     │
│            │                                                 │
│            ▼                                                 │
│  ┌────────────────────┐                                     │
│  │ 3. パターン         │                                     │
│  │    マッチング       │                                     │
│  │    (正規表現)       │                                     │
│  └─────────┬──────────┘                                     │
│            │                                                 │
│            ▼                                                 │
│       エラー検出?                                            │
│       /        \                                             │
│     Yes         No                                           │
│      │           │                                           │
│      ▼           │                                           │
│  ┌────────────┐  │                                          │
│  │4. 自動修復 │  │                                          │
│  │  ・クール  │  │                                          │
│  │   ダウン   │  │                                          │
│  │   チェック │  │                                          │
│  │  ・バック  │  │                                          │
│  │   アップ   │  │                                          │
│  │  ・アク    │  │                                          │
│  │   ション   │  │                                          │
│  │   実行     │  │                                          │
│  └─────┬──────┘  │                                          │
│        │         │                                           │
│        ▼         ▼                                           │
│  ┌────────────────────┐                                     │
│  │ 5. 結果ログ出力     │                                     │
│  └─────────┬──────────┘                                     │
│            │                                                 │
│            ▼                                                 │
│       [サイクル完了]                                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## エラー検知機能

### 検知可能なエラーパターン

| ID | エラー名 | パターン（正規表現） | 重要度 | 自動修復 |
|----|---------|---------------------|--------|----------|
| `http_4xx` | HTTP 4xxエラー | `HTTP/[0-9.]+ 4[0-9]{2}` | warning | ✓ |
| `http_5xx` | HTTP 5xxエラー | `HTTP/[0-9.]+ 5[0-9]{2}` | critical | ✓ |
| `database_connection_error` | DB接続エラー | `(database connection\|connection refused\|...)` | critical | ✓ |
| `python_exception` | Python例外 | `(Traceback\|Exception\|Error): ` | error | ✓ |
| `file_not_found` | ファイル不存在 | `(FileNotFoundError\|No such file...)` | error | ✓ |
| `permission_denied` | 権限エラー | `(PermissionError\|Permission denied...)` | error | ✓ |
| `memory_error` | メモリ不足 | `(MemoryError\|Out of memory\|OOM...)` | critical | ✓ |
| `disk_full` | ディスク容量不足 | `(No space left\|disk.*full...)` | critical | ✓ |
| `port_in_use` | ポート使用中 | `(Address already in use...)` | error | ✓ |
| `json_decode_error` | JSON解析エラー | `(JSONDecodeError\|Invalid JSON...)` | warning | ✓ |
| `redis_connection_error` | Redis接続エラー | `(redis.*connection...)` | warning | ✓ |
| `ssl_certificate_error` | SSL証明書エラー | `(SSL.*certificate...)` | error | ✗ (手動) |

### 検知ロジック

```python
def scan_logs(self, log_paths: List[str]) -> List[Dict]:
    """
    ログファイルをスキャンしてエラーを検出
    
    処理:
    1. 各ログファイルの最後1000行を読み込み
    2. 設定されたすべてのパターンに対してマッチング
    3. マッチしたエラーを検出結果リストに追加
    
    パフォーマンス考慮:
    - 最大1000行に制限してメモリ使用を抑制
    - 正規表現は事前コンパイル
    - 大文字小文字を無視
    """
```

---

## 自動修復アクション

### 利用可能なアクション

| アクションタイプ | 説明 | 必要な権限 |
|-----------------|------|-----------|
| `service_restart` | サービス再起動 | sudo |
| `log_rotate` | ログローテーション（10MB超） | 書き込み |
| `cache_clear` | キャッシュクリア | 書き込み |
| `temp_file_cleanup` | 一時ファイル削除 | 書き込み |
| `create_missing_dirs` | ディレクトリ作成 | 書き込み |
| `fix_permissions` | 権限修正 | sudo |
| `check_port` | ポート確認 | なし |
| `kill_process_on_port` | プロセス終了 | sudo |
| `database_vacuum` | DB VACUUM実行 | DB権限 |
| `backup_and_fix_json` | JSON修復 | 書き込み |
| `old_file_cleanup` | 古いファイル削除 | 書き込み |
| `alert` | アラート送信のみ | なし |
| `log_analysis` | ログ分析 | 読み取り |

### アクション実行フロー

```
┌─────────────────────────────────────────────────────────────┐
│                  自動修復実行フロー                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [エラー検出]                                                │
│        │                                                     │
│        ▼                                                     │
│  ┌────────────────────┐                                     │
│  │ クールダウン確認    │                                     │
│  │ (同一エラー300秒以内│                                     │
│  │  の再修復禁止)      │                                     │
│  └─────────┬──────────┘                                     │
│            │                                                 │
│            ▼                                                 │
│      クールダウン中?                                         │
│       /        \                                             │
│     Yes         No                                           │
│      │           │                                           │
│      ▼           ▼                                           │
│  [スキップ]  ┌────────────────────┐                         │
│              │ 自動修復有効確認    │                         │
│              │ (auto_fix: true)    │                         │
│              └─────────┬──────────┘                         │
│                        │                                     │
│                        ▼                                     │
│                   自動修復有効?                              │
│                   /        \                                 │
│                 Yes         No                               │
│                  │           │                               │
│                  │           ▼                               │
│                  │       [スキップ]                          │
│                  │                                           │
│                  ▼                                           │
│  ┌────────────────────┐                                     │
│  │ バックアップ作成    │                                     │
│  │ (backup_before_fix  │                                     │
│  │  がtrueの場合)      │                                     │
│  └─────────┬──────────┘                                     │
│            │                                                 │
│            ▼                                                 │
│  ┌────────────────────┐                                     │
│  │ アクション実行      │ ◄────────────┐                     │
│  │ (actions配列順)     │              │                     │
│  └─────────┬──────────┘              │                     │
│            │                          │                     │
│            ▼                          │                     │
│       次のアクション? ──Yes───────────┘                     │
│            │                                                 │
│           No                                                 │
│            │                                                 │
│            ▼                                                 │
│  ┌────────────────────┐                                     │
│  │ 修復履歴記録        │                                     │
│  │ (クールダウン用)    │                                     │
│  └─────────┬──────────┘                                     │
│            │                                                 │
│            ▼                                                 │
│       [完了ログ出力]                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## ヘルスチェック機能

### チェック項目

| チェック名 | タイプ | 間隔 | 閾値 | クリティカル |
|-----------|--------|------|------|-------------|
| database_connection | postgresql | 60秒 | 5秒タイムアウト | ✓ |
| redis_connection | redis | 60秒 | 5秒タイムアウト | ✗ |
| disk_space | disk | 300秒 | 90% | ✓ |
| memory_usage | memory | 300秒 | 85% | ✗ |
| http_endpoint | http | 30秒 | 10秒タイムアウト | ✓ |

### ヘルスチェック結果の構造

```json
{
  "timestamp": "2026-01-31T14:30:00",
  "checks": {
    "database_connection": {
      "status": "healthy",
      "message": "accepting connections",
      "critical": true
    },
    "disk_space": {
      "status": "healthy",
      "usage_percent": 45.2,
      "free_gb": 250.5,
      "critical": true
    },
    "memory_usage": {
      "status": "healthy",
      "usage_percent": 60.5,
      "available_gb": 8.5,
      "critical": false
    }
  },
  "overall_status": "healthy",
  "metrics": {
    "cpu": {"usage_percent": 25.3, "count": 4},
    "memory": {"total_gb": 16.0, "used_gb": 9.6},
    "disk": {"total_gb": 500.0, "used_gb": 226.0},
    "network": {"bytes_sent_mb": 1234.5, "bytes_recv_mb": 5678.9},
    "processes": {"count": 234}
  }
}
```

### ステータス判定ロジック

```
overall_status の決定:
  if (クリティカルなチェックが失敗)
    → "critical"
  else if (いずれかのチェックが unhealthy)
    → "degraded"
  else
    → "healthy"
```

---

## GitHub Actions連携

### ワークフロー概要

**ファイル**: `.github/workflows/auto-error-fix-continuous.yml`

```yaml
name: 🤖 自動エラー検知・修復システム（5分間隔・無限ループ）

on:
  schedule:
    - cron: '*/5 * * * *'  # 毎5分実行
  workflow_dispatch:        # 手動トリガー

env:
  MAX_LOOPS: 15
  PYTHON_VERSION: '3.12'
```

### 実行フロー

1. **環境セットアップ**
   - Python 3.12環境構築
   - 依存関係インストール
   - PostgreSQL/Redis起動（Docker）

2. **検知・修復ループ（15回）**
   - ヘルスチェック実行
   - テスト実行
   - ログファイル確認
   - 自動修復試行

3. **結果レポート**
   - マークダウンレポート生成
   - GitHub Issue作成
   - Artifact保存（30日間）

### 手動トリガーオプション

| 入力パラメータ | 説明 | デフォルト |
|---------------|------|-----------|
| `max_loops` | 最大ループ回数 | 15 |
| `create_issue` | Issue作成有無 | yes |

---

## 設定ファイル詳細

### error_patterns.json 完全構造

```json
{
  "error_patterns": [
    {
      "id": "エラーID（一意）",
      "name": "エラー名（日本語）",
      "pattern": "正規表現パターン",
      "severity": "warning|error|critical",
      "auto_fix": true,
      "actions": [
        {
          "type": "アクションタイプ",
          "description": "説明",
          "service": "サービス名（service_restart用）",
          "port": 5100,
          "directories": ["dir1", "dir2"],
          "paths": ["path1", "path2"],
          "owner": "ユーザー",
          "mode": "755",
          "days": 30
        }
      ]
    }
  ],
  "health_checks": [
    {
      "name": "チェック名",
      "type": "postgresql|redis|disk|memory|http",
      "interval": 60,
      "timeout": 5,
      "threshold": 90,
      "url": "http://localhost:5100/api/health",
      "critical": true
    }
  ],
  "auto_fix_config": {
    "max_retries": 3,
    "retry_delay": 60,
    "cooldown_period": 300,
    "enable_notifications": true,
    "notification_channels": ["log", "email"],
    "backup_before_fix": true
  }
}
```

---

## 運用ガイド

### 起動方法

#### 1. 手動実行（1回のみ）

```bash
cd /path/to/Mirai-Knowledge-Systems/backend/scripts
python3 auto_fix_daemon.py
```

#### 2. 継続的監視モード

```bash
python3 auto_fix_daemon.py --continuous
```

#### 3. カスタム設定

```bash
python3 auto_fix_daemon.py --continuous \
  --loop-count 20 \
  --wait-minutes 10 \
  --config /path/to/custom_config.json \
  --log-file /path/to/custom.log
```

#### 4. systemdサービス

```bash
# インストール
sudo cp auto-fix-daemon.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable auto-fix-daemon
sudo systemctl start auto-fix-daemon

# 管理
sudo systemctl status auto-fix-daemon
sudo journalctl -u auto-fix-daemon -f
sudo systemctl restart auto-fix-daemon
```

### コマンドラインオプション

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `--continuous` | 継続的監視モード | False |
| `--config PATH` | 設定ファイルパス | `./error_patterns.json` |
| `--log-file PATH` | ログファイルパス | `../logs/auto_fix.log` |
| `--loop-count N` | ループ回数 | 15 |
| `--wait-minutes N` | 待機時間（分） | 5 |
| `--once` | 1回のみ実行 | - |

### ログファイル

| ファイル | 説明 | ローテーション |
|---------|------|---------------|
| `auto_fix.log` | 修復処理の詳細ログ | 10MB超で自動 |
| `alerts.log` | 重要アラート（JSON） | - |
| `app.log` | アプリケーションログ | 10MB超で自動 |

**ログフォーマット**:
```
2026-01-31 14:30:15 - AutoFixDaemon - [INFO] - === 検知サイクル 1 開始 ===
2026-01-31 14:30:16 - AutoFixDaemon - [WARNING] - エラー検出: HTTP 5xxエラー
2026-01-31 14:30:17 - AutoFixDaemon - [INFO] - 修復アクション実行: service_restart
```

---

## セキュリティ考慮事項

### 1. 実行権限

- **推奨ユーザー**: `www-data`
- **必要な sudo 権限**: サービス再起動、権限修正
- **sudoers 設定例**:
  ```
  www-data ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart flask_app
  www-data ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart postgresql
  www-data ALL=(ALL) NOPASSWD: /bin/chown
  ```

### 2. リソース制限（systemd）

```ini
MemoryLimit=512M
CPUQuota=50%
NoNewPrivileges=true
PrivateTmp=true
```

### 3. アクセス制御

- ログファイルへのアクセスは制限されたユーザーのみ
- 設定ファイルの書き込み権限は管理者のみ
- バックアップファイルは暗号化推奨

### 4. クールダウンによるDoS防止

- 同一エラーの連続修復を防止（300秒）
- 無限ループによるリソース消費を防止

---

## トラブルシューティング

### よくある問題

#### 1. デーモンが起動しない

```bash
# ログ確認
sudo journalctl -u auto-fix-daemon -n 50

# 権限確認
ls -la /path/to/backend/scripts/

# 手動実行でエラー確認
python3 auto_fix_daemon.py
```

#### 2. 自動修復が動作しない

1. `error_patterns.json` の `auto_fix` が `true` か確認
2. クールダウン期間（300秒）内でないか確認
3. ログファイルのパスが正しいか確認
4. 必要な権限があるか確認

#### 3. ヘルスチェックが失敗する

```bash
# PostgreSQL確認
pg_isready

# Redis確認
redis-cli ping

# ポート確認
netstat -tlnp | grep -E '(5100|5432|6379)'

# HTTPエンドポイント確認
curl -s http://localhost:5100/api/health
```

#### 4. メモリ使用量が高い

- ログファイルサイズを確認（自動ローテーション: 10MB）
- キャッシュクリアを手動実行
- 古いバックアップファイルを削除

---

## パフォーマンス指標

| 項目 | 通常時 | 最大値 |
|------|--------|--------|
| メモリ使用量 | 50-100MB | 512MB |
| CPU使用率 | 1-5% | 50% |
| ディスクI/O | 低い | 中程度（スキャン時） |
| ログファイルサイズ | 可変 | 10MB（自動ローテーション） |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|-----------|---------|------|
| 2026-01-31 | 1.0.0 | 初版作成 | Copilot |

---

## 関連ドキュメント

- [運用スクリプト一覧](./11_運用スクリプト一覧(Operations-Scripts).md)
- [アラート設定](./12_アラート設定(Alert-Configuration).md)
- [障害対応フロー](./13_障害対応フロー(Incident-Response).md)
- [定期メンテナンス](./14_定期メンテナンス(Regular-Maintenance).md)
- [監視運用ガイド](./18_Monitoring-Operations-Guide.md)
- [バックエンドスクリプトREADME](../../backend/scripts/README.md)
