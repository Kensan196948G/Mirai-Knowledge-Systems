# 運用監視体制ガイド

## Phase C-3: 運用監視体制構築

---

## 1. 監視体制概要

### 1.1 監視システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    監視システム構成図                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   MKS App   │    │  PostgreSQL │    │    Nginx    │     │
│  │  (Backend)  │    │  Database   │    │   Proxy     │     │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘     │
│         │                  │                  │             │
│         ▼                  ▼                  ▼             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                   Prometheus                          │  │
│  │              メトリクス収集・保存                      │  │
│  └────────────────────┬─────────────────────────────────┘  │
│                       │                                     │
│         ┌─────────────┼─────────────┐                      │
│         ▼             ▼             ▼                      │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐               │
│  │  Grafana  │ │Alertmanager│ │   Logs    │               │
│  │ ダッシュ  │ │ アラート   │ │  (ELK)   │               │
│  │  ボード   │ │   通知    │ │           │               │
│  └───────────┘ └─────┬─────┘ └───────────┘               │
│                      │                                     │
│                      ▼                                     │
│         ┌────────────────────────┐                        │
│         │   通知チャネル          │                        │
│         │ ・Email ・Slack ・SMS  │                        │
│         └────────────────────────┘                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 監視対象一覧

| カテゴリ | 監視対象 | メトリクス | 収集間隔 |
|---------|---------|-----------|---------|
| インフラ | CPU | 使用率、ロードアベレージ | 15秒 |
| インフラ | メモリ | 使用率、空き容量 | 15秒 |
| インフラ | ディスク | 使用率、I/O | 15秒 |
| インフラ | ネットワーク | トラフィック、接続数 | 15秒 |
| アプリ | レスポンスタイム | P50/P95/P99 | 30秒 |
| アプリ | リクエスト数 | RPS、エンドポイント別 | 30秒 |
| アプリ | エラー率 | 4xx/5xx比率 | 30秒 |
| DB | 接続数 | アクティブ接続 | 30秒 |
| DB | クエリ性能 | 実行時間、スロークエリ | 30秒 |
| 証明書 | SSL有効期限 | 残り日数 | 1日 |

---

## 2. 組織体制

### 2.1 監視担当者役割

| 役割 | 担当 | 責務 |
|------|------|------|
| 一次対応者 | SREチーム | アラート受信、初動対応、エスカレーション判断 |
| 二次対応者 | 開発チーム | アプリケーション障害の詳細調査・修正 |
| 三次対応者 | インフラチーム | インフラ障害の詳細調査・復旧 |
| 責任者 | システム管理者 | 重大障害時の意思決定、顧客対応 |

### 2.2 連絡体制

```
【平日 9:00-18:00】
  アラート発報
       ↓
  一次対応者（SREチーム）
       ↓ (15分以内に対応開始)
  エスカレーション判断
       ↓
  二次/三次対応者
       ↓ (重大障害時)
  責任者報告

【夜間・休日】
  アラート発報
       ↓
  オンコール担当
       ↓ (重大障害時)
  責任者連絡
       ↓ (必要に応じて)
  緊急招集
```

### 2.3 オンコールローテーション

| 週 | 担当者 | バックアップ |
|----|--------|-------------|
| 第1週 | 担当者A | 担当者B |
| 第2週 | 担当者B | 担当者C |
| 第3週 | 担当者C | 担当者A |
| 第4週 | 担当者A | 担当者B |

---

## 3. アラート対応フロー

### 3.1 アラート重要度定義

| 重要度 | 説明 | 対応時間目標 | 通知方法 |
|--------|------|-------------|---------|
| Critical | サービス停止、データ損失リスク | 15分以内 | Slack + Email + SMS |
| Warning | パフォーマンス低下、容量警告 | 1時間以内 | Slack + Email |
| Info | 情報提供、定期通知 | 4時間以内 | Email |

### 3.2 Critical アラート対応手順

```
1. アラート受信（0分）
   └─ Slack/SMS通知を確認

2. 状況確認（5分以内）
   ├─ Grafanaダッシュボードでメトリクス確認
   ├─ サービス稼働状態確認
   └─ 影響範囲の把握

3. 初動対応（15分以内）
   ├─ 一時対処（サービス再起動等）
   ├─ 影響顧客への通知判断
   └─ エスカレーション実施

4. 根本対応（状況による）
   ├─ 原因特定
   ├─ 恒久対策実施
   └─ 再発防止策検討

5. 事後対応
   ├─ インシデントレポート作成
   ├─ ポストモーテム実施
   └─ ドキュメント更新
```

### 3.3 よくあるアラートと対処法

#### MKSBackendDown

**原因候補:**
- アプリケーションクラッシュ
- メモリ不足
- ディスク容量不足

**対処手順:**
```bash
# 1. サービス状態確認
sudo systemctl status mirai-knowledge-app

# 2. ログ確認
sudo journalctl -u mirai-knowledge-app -n 100

# 3. リソース確認
free -h
df -h

# 4. サービス再起動
sudo systemctl restart mirai-knowledge-app

# 5. 動作確認
curl http://localhost:8100/api/v1/health
```

#### HighCPUUsage

**原因候補:**
- 大量リクエスト
- 重いクエリ実行中
- バッチ処理実行中

**対処手順:**
```bash
# 1. プロセス確認
top -b -n 1 | head -20

# 2. 重いプロセス特定
ps aux --sort=-%cpu | head -10

# 3. DB接続確認
psql -U postgres -d mirai_knowledge_db -c "SELECT * FROM pg_stat_activity WHERE state = 'active';"

# 4. 必要に応じてワーカー数調整
# gunicorn.conf.pyを編集
```

#### HighDiskUsage

**対処手順:**
```bash
# 1. ディスク使用状況確認
df -h

# 2. 大きなファイル特定
du -sh /var/log/* | sort -hr | head -10

# 3. 古いログ削除
sudo logrotate -f /etc/logrotate.d/mirai-knowledge-system

# 4. 古いバックアップ削除
find /var/backups/mirai-knowledge -name "*.gz" -mtime +30 -delete
```

---

## 4. ダッシュボード活用

### 4.1 Grafanaアクセス情報

| 項目 | 値 |
|------|-----|
| URL | http://localhost:3000 |
| ユーザー | admin |
| 初期パスワード | admin（要変更） |

### 4.2 主要ダッシュボード

| ダッシュボード | 用途 | 確認頻度 |
|--------------|------|---------|
| MKS System Overview | システム全体の状態 | 常時 |
| Application Metrics | アプリケーション性能 | 随時 |
| Database Metrics | DB性能・接続状態 | 随時 |
| Infrastructure | サーバーリソース | 随時 |

### 4.3 よく使うPrometheusクエリ

```promql
# CPU使用率
100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# メモリ使用率
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

# リクエスト数/秒
rate(http_requests_total[5m])

# エラー率
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100

# レスポンスタイム P95
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# アクティブDB接続数
pg_stat_activity_count
```

---

## 5. 定期メンテナンス

### 5.1 日次タスク

| 時刻 | タスク | 担当 |
|------|--------|------|
| 09:00 | 夜間アラート確認 | 一次対応者 |
| 09:00 | ダッシュボード確認 | 一次対応者 |
| 17:00 | 日次レポート作成 | 一次対応者 |

### 5.2 週次タスク

| 曜日 | タスク | 担当 |
|------|--------|------|
| 月曜 | SSL証明書期限確認 | SREチーム |
| 水曜 | バックアップ検証 | SREチーム |
| 金曜 | 週次レポート作成 | SREチーム |

### 5.3 月次タスク

| タスク | 担当 |
|--------|------|
| アラート閾値見直し | SREチーム |
| キャパシティプランニング | インフラチーム |
| ダッシュボード更新 | SREチーム |
| 監視システムアップデート | インフラチーム |

---

## 6. セットアップ手順

### 6.1 監視スタック起動（Docker）

```bash
cd /mnt/LinuxHDD/Mirai-Knowledge-Systems/monitoring

# クイックスタート
./quick-start.sh

# 手動起動
docker-compose -f docker-compose.monitoring.yml up -d
```

### 6.2 監視スタック起動（ネイティブ）

```bash
cd /mnt/LinuxHDD/Mirai-Knowledge-Systems/monitoring

# セットアップスクリプト実行
sudo ./setup_monitoring.sh

# サービス状態確認
sudo systemctl status prometheus
sudo systemctl status grafana-server
sudo systemctl status alertmanager
```

### 6.3 初期設定チェックリスト

- [ ] Grafana管理者パスワード変更
- [ ] Alertmanager通知設定（Email/Slack）
- [ ] アラート閾値の調整
- [ ] ダッシュボードのインポート
- [ ] データソースの接続確認

---

## 7. 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [監視設定ガイド](./07_Monitoring-Setup-Guide.md) | 詳細な監視設定 |
| [アラート設定](./12_アラート設定(Alert-Configuration).md) | アラートルール詳細 |
| [障害対応フロー](./13_障害対応フロー(Incident-Response).md) | インシデント対応手順 |
| [monitoring/README.md](../../monitoring/README.md) | 監視システム全体ガイド |

---

**作成日**: 2026-01-25
**バージョン**: 1.0.0
**Phase**: C-3 運用監視体制構築
