# パスワード管理ガイド (Password Management Guide)

## 目次
1. [概要](#1-概要)
2. [本番ユーザーアカウント](#2-本番ユーザーアカウント)
3. [パスワードポリシー](#3-パスワードポリシー)
4. [パスワード変更手順](#4-パスワード変更手順)
5. [パスワードリセット手順](#5-パスワードリセット手順)
6. [セキュリティベストプラクティス](#6-セキュリティベストプラクティス)
7. [緊急時対応](#7-緊急時対応)

---

## 1. 概要

このドキュメントは、Mirai Knowledge Systemsの本番環境におけるパスワード管理の方針と手順を定めます。

### 1.1 対象読者
- システム管理者
- IT部門担当者
- セキュリティ担当者

### 1.2 関連ドキュメント
- [管理者ガイド](04_Administrator-Guide.md)
- [セキュリティ実装](../05_セキュリティ(Security)/01_Security-Implementation.md)

---

## 2. 本番ユーザーアカウント

### 2.1 システムアカウント一覧

| ユーザー名 | ロール | 部門 | 用途 |
|-----------|--------|------|------|
| `system_admin` | admin | IT部門 | システム全体の管理 |
| `project_manager` | manager | 建設部門 | プロジェクト管理 |
| `engineer01` | engineer | 技術部門 | 技術業務 |

### 2.2 デモアカウント（開発環境のみ）

⚠️ **注意**: 以下のアカウントは開発・テスト目的のみで使用してください。本番環境では無効化されています。

| ユーザー名 | ロール | 備考 |
|-----------|--------|------|
| `admin` | admin | 開発用管理者 |
| `yamada` | construction_manager | テストユーザー |
| `partner` | partner_company | 協力会社テスト |

---

## 3. パスワードポリシー

### 3.1 パスワード要件

本システムでは以下のパスワード要件が適用されます：

| 項目 | 要件 |
|------|------|
| 最小文字数 | 12文字以上 |
| 最大文字数 | 128文字 |
| 大文字 | 1文字以上必須 |
| 小文字 | 1文字以上必須 |
| 数字 | 1文字以上必須 |
| 特殊文字 | 1文字以上必須（`!@#$%^&*()_+-=[]{}|;:,.<>?`） |
| 過去パスワード再利用 | 直近5回分は使用不可 |

### 3.2 パスワード有効期限

| アカウント種別 | 有効期限 | 事前通知 |
|---------------|---------|---------|
| 管理者アカウント | 60日 | 14日前 |
| 一般ユーザー | 90日 | 7日前 |
| サービスアカウント | 180日 | 30日前 |

### 3.3 ロックアウトポリシー

| 条件 | 設定値 |
|------|-------|
| 連続失敗回数 | 5回 |
| ロックアウト時間 | 30分 |
| 自動解除 | 30分後に自動解除 |

---

## 4. パスワード変更手順

### 4.1 ユーザー自身による変更

1. システムにログイン
2. 右上のユーザーアイコンをクリック
3. **「アカウント設定」** を選択
4. **「パスワード変更」** セクションで以下を入力：
   - 現在のパスワード
   - 新しいパスワード
   - 新しいパスワード（確認）
5. **「変更を保存」** をクリック

### 4.2 API経由での変更

```bash
curl -X POST https://<your-domain>/api/v1/auth/change-password \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "current_password": "現在のパスワード",
    "new_password": "新しいパスワード"
  }'
```

### 4.3 CLI経由での変更（管理者向け）

```bash
cd /path/to/Mirai-Knowledge-Systems/backend
python3 scripts/change_password.py --username <ユーザー名>
```

---

## 5. パスワードリセット手順

### 5.1 管理者によるリセット

1. 管理画面にログイン（`system_admin`アカウント）
2. **「ユーザー管理」** メニューを選択
3. 対象ユーザーを検索
4. **「パスワードリセット」** ボタンをクリック
5. 一時パスワードが生成される
6. 一時パスワードをユーザーに安全に通知
7. ユーザーは初回ログイン時にパスワード変更を強制される

### 5.2 スクリプトによるリセット

```bash
cd /path/to/Mirai-Knowledge-Systems/backend

# パスワードをリセット（ランダムパスワード生成）
python3 scripts/reset_password.py --username <ユーザー名>

# 特定のパスワードを設定
python3 scripts/reset_password.py --username <ユーザー名> --password <新パスワード>
```

### 5.3 緊急リセット（データベース直接操作）

⚠️ **注意**: この方法は緊急時のみ使用してください。

```bash
# bcryptハッシュを生成
python3 -c "import bcrypt; print(bcrypt.hashpw('新パスワード'.encode(), bcrypt.gensalt()).decode())"

# PostgreSQLでパスワードを更新
psql -U mks_user -d mirai_knowledge_system -c "
  UPDATE users
  SET password_hash = '<生成されたハッシュ>'
  WHERE username = '<ユーザー名>';
"
```

---

## 6. セキュリティベストプラクティス

### 6.1 パスワード保管

| 方法 | 推奨度 | 説明 |
|------|--------|------|
| パスワードマネージャー | ✅ 推奨 | 1Password, Bitwarden等 |
| 暗号化ファイル | ⚠️ 条件付き | GPG暗号化した場合のみ |
| 平文ファイル | ❌ 禁止 | 絶対に使用しない |
| メモ帳 | ❌ 禁止 | 紙・電子メモは不可 |

### 6.2 パスワード共有

| シナリオ | 推奨方法 |
|---------|---------|
| 初期パスワード通知 | 1Password/Bitwarden共有、または対面 |
| 緊急時の共有 | 電話で読み上げ（記録しない） |
| チーム共有パスワード | パスワードマネージャーの共有機能 |

### 6.3 禁止事項

- ❌ パスワードをメールで送信
- ❌ パスワードをSlack/Teams等で送信
- ❌ パスワードをソースコードにハードコード
- ❌ 同じパスワードを複数システムで使用
- ❌ パスワードを他人と口頭で共有

---

## 7. 緊急時対応

### 7.1 パスワード漏洩が疑われる場合

1. **即座に対象アカウントを無効化**
   ```bash
   python3 scripts/disable_user.py --username <ユーザー名>
   ```

2. **監査ログを確認**
   ```bash
   curl https://<your-domain>/api/v1/logs/access?user=<ユーザー名>&hours=24 \
     -H "Authorization: Bearer <ADMIN_TOKEN>"
   ```

3. **セキュリティチームに報告**
   - 発見日時
   - 対象アカウント
   - 漏洩の可能性がある経路
   - 実施した対応

4. **影響範囲の調査**
   - 不正アクセスの有無
   - データ漏洩の有無

5. **パスワードリセットと再有効化**
   ```bash
   python3 scripts/reset_password.py --username <ユーザー名>
   python3 scripts/enable_user.py --username <ユーザー名>
   ```

### 7.2 全管理者アカウントがロックされた場合

1. サーバーにSSHでアクセス
2. PostgreSQLに直接接続
3. 緊急リセットを実行（セクション5.3参照）

### 7.3 連絡先

| 担当 | 連絡先 |
|------|--------|
| システム管理者 | sysadmin@company.local |
| セキュリティチーム | security@company.local |
| 緊急連絡先（24h） | 内線: 9999 |

---

## 更新履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2026-01-07 | 1.0.0 | 初版作成 | Claude Code |

---

**このドキュメントは機密情報を含みます。適切に管理してください。**
