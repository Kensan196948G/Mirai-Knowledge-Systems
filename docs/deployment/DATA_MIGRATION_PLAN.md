# データ移行計画書 - Phase C-2

## 📋 概要

本ドキュメントは、Mirai Knowledge Systemsの開発環境（JSON）から本番環境（PostgreSQL）へのデータ移行計画を定義します。

---

## 🎯 移行目的

1. 開発環境で作成・検証済みのサンプルデータを本番環境に移行
2. システムの動作確認用データとして活用
3. ユーザートレーニング用のリアルなデータ環境を構築

---

## 📊 移行対象データ

### データ一覧

| データ種別 | 開発環境ファイル | 本番テーブル | 件数目安 |
|-----------|-----------------|-------------|---------|
| ナレッジ | knowledge.json | knowledge | 10-50件 |
| SOP | sop.json | sop | 5-20件 |
| インシデント | incidents.json | incidents | 10-30件 |
| プロジェクト | projects.json | projects | 5-10件 |
| 専門家 | experts.json | experts | 5-15件 |
| ユーザー | users.json | users | 5-10件 |
| 通知 | notifications.json | notifications | 0件（新規作成） |
| タグ | tags.json | tags | 10-20件 |

### 移行しないデータ

- アクセスログ（access_logs.json）→ 本番で新規蓄積
- セッションデータ → 本番で新規作成
- デモユーザー → 本番では作成しない

---

## 🔄 移行手順

### Phase 1: 事前準備（T-1日）

```
1. 本番環境PostgreSQLバックアップ取得
2. 開発環境JSONデータのエクスポート
3. データ整合性チェック
4. 移行スクリプトの最終テスト
```

### Phase 2: 移行実行（T日）

```
1. 本番サービス停止
2. データベーステーブルのトランケート（または新規作成）
3. JSONデータをPostgreSQLに投入
4. データ件数・整合性検証
5. サービス再起動
6. 動作確認
```

### Phase 3: 検証（T+1日）

```
1. 全機能の動作確認
2. データ表示確認
3. 検索機能テスト
4. パフォーマンス確認
```

---

## 📝 移行スクリプト構成

### メインスクリプト

| スクリプト | 用途 | 場所 |
|-----------|------|------|
| migrate_json_to_postgres.py | JSON→PostgreSQL一括移行 | backend/ |
| validate_migration.py | 移行後データ検証 | backend/scripts/ |
| rollback_migration.py | ロールバック処理 | backend/scripts/ |

### 実行順序

```bash
# 1. バックアップ
./scripts/backup-postgresql.sh

# 2. 移行実行
cd backend
python migrate_json_to_postgres.py --env production

# 3. 検証
python scripts/validate_migration.py

# 4. （問題発生時）ロールバック
python scripts/rollback_migration.py
```

---

## ⚠️ リスクと対策

### リスク一覧

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| データ破損 | 高 | 低 | 事前バックアップ、トランザクション管理 |
| 移行時間超過 | 中 | 低 | バッチ処理、並列実行 |
| 整合性エラー | 中 | 中 | 事前検証、外部キー一時無効化 |
| サービス停止延長 | 中 | 低 | ロールバック手順の準備 |

### ロールバック条件

以下の場合、即座にロールバックを実行：

1. 移行後のデータ件数が期待値の90%未満
2. 主要API（/api/v1/knowledge, /api/v1/sop）がエラーを返す
3. ログインが不可能
4. データ整合性チェックで重大エラー

---

## 📅 スケジュール

| 日時 | 作業内容 | 担当 | 所要時間 |
|------|---------|------|---------|
| T-1日 18:00 | 事前準備・最終確認 | 開発 | 1時間 |
| T日 02:00 | サービス停止 | 運用 | 5分 |
| T日 02:05 | バックアップ取得 | 運用 | 15分 |
| T日 02:20 | 移行実行 | 開発 | 30分 |
| T日 02:50 | 検証 | 開発・運用 | 20分 |
| T日 03:10 | サービス再開 | 運用 | 5分 |
| T日 03:15 | 動作確認 | 全員 | 15分 |

**計画停止時間: 約75分**

---

## ✅ チェックリスト

### 移行前

- [ ] PostgreSQLバックアップ完了
- [ ] 開発環境JSONデータの整合性確認
- [ ] 移行スクリプトのドライラン成功
- [ ] ロールバック手順の確認
- [ ] 関係者への事前通知

### 移行中

- [ ] サービス停止確認
- [ ] 移行スクリプト実行
- [ ] エラーログ監視
- [ ] 進捗記録

### 移行後

- [ ] データ件数確認
- [ ] サンプルデータ目視確認
- [ ] API動作確認
- [ ] フロントエンド動作確認
- [ ] パフォーマンステスト
- [ ] サービス再開

---

## 📚 関連ドキュメント

- [データ移行ガイド](./DATA_MIGRATION_GUIDE.md)
- [PostgreSQL移行手順](../PostgreSQL移行手順.md)
- [バックアップ・リストア手順](../11_運用保守(Operations)/08_Backup-Restore-Procedures.md)
- [Go-Liveチェックリスト](../11_運用保守(Operations)/10_Production-Go-Live-Checklist.md)

---

**作成日**: 2026-01-25
**バージョン**: 1.0.0
**Phase**: C-2-1 開発→本番データ移行計画策定
