# Microsoft 365同期 ユーザーガイド

## 目次

1. [Microsoft 365同期とは](#1-microsoft-365同期とは)
2. [前提条件](#2-前提条件)
3. [設定手順](#3-設定手順)
4. [同期スケジュールの設定](#4-同期スケジュールの設定)
5. [トラブルシューティング](#5-トラブルシューティング)
6. [FAQ](#6-faq)

---

## 1. Microsoft 365同期とは

Microsoft 365同期機能は、SharePointやOneDrive上のドキュメントを自動的にMirai Knowledge Systemsに取り込む機能です。

### 1.1 主な機能

- **自動同期**: SharePointフォルダを定期的にスキャンし、新規・更新ファイルを自動取り込み
- **増分同期**: 変更されたファイルのみを効率的に処理
- **ファイル形式対応**: PDF, Word, Excel, PowerPointなどのOfficeドキュメント
- **メタデータ保持**: ファイル名、作成者、更新日時などを保持
- **全文検索**: 取り込んだファイルはMirai Knowledge Systemsの全文検索に対応
- **ファイルプレビュー**: ブラウザ上で直接ファイル内容を確認（Phase E-4）

### 1.2 ファイルプレビュー機能（Phase E-4）

Microsoft 365から取り込んだファイルをブラウザ上で直接プレビューできます。

#### 対応ファイル形式

| 形式 | プレビュー方法 | 機能 |
|------|--------------|------|
| **Office文書** | Office Online埋め込み | Word/Excel/PowerPointをブラウザで閲覧 |
| ・Word（.docx, .doc） | iframeプレビュー | 編集不可、閲覧専用 |
| ・Excel（.xlsx, .xls） | iframeプレビュー | シート切り替え可能 |
| ・PowerPoint（.pptx, .ppt） | iframeプレビュー | スライド送り可能 |
| **PDF** | ブラウザ内蔵ビューア | ページ送り、拡大縮小 |
| **画像** | 直接表示 | JPG, PNG, GIF, BMP, SVG |
| **その他** | サムネイル + ダウンロード | 対応形式外はダウンロードで確認 |

#### サムネイル表示

ファイル一覧画面では、各ファイルのサムネイル画像が自動生成されます。

- **サイズ**: small（48x48）、medium（96x96）、large（800x800）
- **キャッシュ**: 7日間ブラウザキャッシュ（オフライン対応）
- **フォールバック**: サムネイル取得失敗時はファイルタイプアイコン表示

#### プレビューの開き方

1. **MS365同期設定画面**から:
   - 同期済みファイル一覧で「プレビュー」ボタンをクリック

2. **検索結果画面**から:
   - MS365から取り込んだナレッジの詳細画面で「元ファイルを表示」をクリック

#### プレビューモーダルの操作

- **拡大/縮小**: ブラウザの標準機能（Ctrl + マウスホイール）
- **ダウンロード**: モーダル右下の「ダウンロード」ボタン
- **閉じる**: モーダル右上の「×」ボタン、またはEscキー

#### オフライン対応（PWA）

- プレビューしたファイルは自動的にキャッシュされます
- オフライン時でも、一度表示したファイルは再表示可能
- キャッシュ保持期間: 7日間

#### セキュリティ

- **認証**: 全プレビュー/ダウンロードリクエストにJWT認証必須
- **権限チェック**: ユーザーのアクセス権限を確認してから表示
- **XSS対策**: DOM API使用、innerHTML禁止
- **CSP準拠**: Content Security Policy準拠のセキュアなiframe埋め込み

#### パフォーマンス最適化

- **遅延ロード**: サムネイルは表示領域に入ってから読み込み
- **キャッシュ戦略**:
  - サムネイル: Cache First（7日間）
  - プレビューURL: Network First with Fallback（7日間）
- **Performance API**: プレビュー表示時間をコンソールに記録

### 1.3 利用シーン

- SharePointで管理している技術資料をナレッジベースに統合
- OneDriveの個人ドキュメントを組織ナレッジとして共有
- 既存のOffice 365資産を活用したナレッジマネジメント

---

## 2. 前提条件

### 2.1 必要な権限

**Azure AD側**:
- Azure ADアプリを登録できる権限（グローバル管理者またはアプリケーション管理者）
- SharePointサイトへのアクセス権限

**Mirai Knowledge Systems側**:
- `admin`ロール（MS365同期設定の作成・編集）

### 2.2 必要な情報

以下の情報を事前に準備してください:

1. **Azure ADテナント情報**:
   - テナントID
   - テナント名（例: `contoso.onmicrosoft.com`）

2. **SharePoint情報**:
   - サイトURL（例: `https://contoso.sharepoint.com/sites/engineering`）
   - ドライブID（後述の手順で取得）
   - 同期対象フォルダパス

3. **認証情報**:
   - クライアントID
   - クライアントシークレット（または証明書）

---

## 3. 設定手順

### 3.1 Azure ADアプリ登録

#### ステップ1: アプリ登録

1. [Azure Portal](https://portal.azure.com)にログイン
2. **Azure Active Directory** → **App registrations** → **New registration**

3. アプリ情報を入力:
   ```
   名前: Mirai Knowledge System MS365 Sync
   サポートされているアカウントの種類: この組織ディレクトリのみのアカウント
   リダイレクトURI: (空欄)
   ```

4. **Register**をクリック

#### ステップ2: API権限の設定

1. 登録したアプリを選択 → **API permissions**
2. **Add a permission** → **Microsoft Graph** → **Application permissions**

3. 以下の権限を追加:
   - `Sites.Read.All`
   - `Files.Read.All`
   - `User.Read.All`（オプション）

4. **Grant admin consent for [テナント名]** をクリック
   - 管理者の承認が必要です

#### ステップ3: クライアントシークレットの作成

1. **Certificates & secrets** → **Client secrets** → **New client secret**

2. 説明を入力（例: `Mirai Knowledge Sync Secret`）

3. 有効期限を選択:
   - 開発環境: 6ヶ月または1年
   - **本番環境: 証明書認証を推奨**

4. **Add**をクリック → **シークレット値をコピー**
   - ⚠️ この値は後で確認できないため、必ずメモしてください

#### ステップ4: アプリケーション情報の取得

**Overview**画面から以下をコピー:
- **Application (client) ID**: `12345678-1234-1234-1234-123456789abc`
- **Directory (tenant) ID**: `87654321-4321-4321-4321-cba987654321`

---

### 3.2 SharePoint情報の取得

#### サイトIDとドライブIDの取得

**方法1: Microsoft Graph Explorerを使用**

1. [Graph Explorer](https://developer.microsoft.com/en-us/graph/graph-explorer)にアクセス

2. サイトIDを取得:
   ```
   GET https://graph.microsoft.com/v1.0/sites/{hostname}:{site-path}
   例: GET https://graph.microsoft.com/v1.0/sites/contoso.sharepoint.com:/sites/engineering
   ```

3. レスポンスから`id`をコピー（これがサイトID）

4. ドライブIDを取得:
   ```
   GET https://graph.microsoft.com/v1.0/sites/{site-id}/drives
   ```

5. レスポンスから対象ドライブの`id`をコピー

**方法2: PowerShellを使用**

```powershell
# Microsoft.Graph モジュールのインストール
Install-Module Microsoft.Graph -Scope CurrentUser

# 認証
Connect-MgGraph -TenantId "your-tenant-id" -ClientId "your-client-id" -ClientSecret "your-secret"

# サイトID取得
$site = Get-MgSite -SiteId "contoso.sharepoint.com:/sites/engineering"
$site.Id

# ドライブID取得
Get-MgSiteDrive -SiteId $site.Id
```

---

### 3.3 Mirai Knowledge Systemsでの設定

#### ステップ1: システム管理者としてログイン

1. Mirai Knowledge Systemsにログイン
2. **管理画面** → **MS365同期設定**に移動

#### ステップ2: 新しい同期設定を作成

**基本設定**:

| 項目 | 設定値 | 説明 |
|------|--------|------|
| 設定名 | `SharePoint技術資料同期` | 識別しやすい名前 |
| 説明 | `engineering サイトの技術資料を自動同期` | 用途の説明 |
| 有効化 | ✅ | 同期を有効化 |

**SharePoint設定**:

| 項目 | 設定値 | 例 |
|------|--------|-----|
| サイトID | `contoso.sharepoint.com,abc...` | Azure ADから取得 |
| ドライブID | `b!xyz...` | Azure ADから取得 |
| フォルダパス | `/技術資料/建設` | 同期対象フォルダ |
| ファイル拡張子 | `pdf,docx,xlsx,pptx` | カンマ区切り |

**同期設定**:

| 項目 | 設定値 | 説明 |
|------|--------|------|
| 同期方式 | `incremental`（増分） | 変更分のみ同期 |
| スケジュール | `0 */4 * * *` | 4時間ごと |
| カテゴリ | `技術資料` | 自動分類カテゴリ |
| タグ | `SharePoint,自動取込` | 自動付与タグ |

**認証設定**（環境変数で事前設定）:

```bash
# /etc/mirai-knowledge-system/ms365-sync.env
AZURE_TENANT_ID=87654321-4321-4321-4321-cba987654321
AZURE_CLIENT_ID=12345678-1234-1234-1234-123456789abc
AZURE_CLIENT_SECRET=your-secret-value
```

#### ステップ3: テスト同期の実行

1. 作成した同期設定を選択
2. **手動同期を実行**ボタンをクリック
3. 同期ステータスを確認:
   - ✅ `成功`: ファイルが正常に取り込まれました
   - ❌ `失敗`: エラーメッセージを確認してください

#### ステップ4: 同期結果の確認

**ダッシュボード**:
- **ナレッジ一覧**に新しいエントリが追加されていることを確認
- ソースフィールドに`MS365 Sync`と表示

**同期履歴**:
```
同期ID: 123
ステータス: 成功
処理ファイル数: 20
作成: 15
更新: 3
スキップ: 2
失敗: 0
実行時間: 12秒
```

---

## 4. 同期スケジュールの設定

### 4.1 Cronフォーマット

同期スケジュールはCron形式で指定します:

```
分 時 日 月 曜日
*  *  *  *  *
```

### 4.2 スケジュール例

| スケジュール | Cron式 | 説明 |
|------------|--------|------|
| 1時間ごと | `0 * * * *` | 毎時0分に実行 |
| 4時間ごと | `0 */4 * * *` | 0時、4時、8時、12時、16時、20時 |
| 毎日午前2時 | `0 2 * * *` | 夜間バッチ処理 |
| 営業日の9時 | `0 9 * * 1-5` | 月～金の9時 |
| 毎週月曜0時 | `0 0 * * 1` | 週次同期 |

### 4.3 推奨スケジュール

**ファイル更新頻度別**:

| ファイル更新頻度 | 推奨スケジュール | Cron式 |
|---------------|---------------|--------|
| 高頻度（1日複数回） | 2時間ごと | `0 */2 * * *` |
| 中頻度（1日1回程度） | 4時間ごと | `0 */4 * * *` |
| 低頻度（週数回） | 1日1回（夜間） | `0 2 * * *` |
| アーカイブ | 週1回 | `0 0 * * 0` |

---

## 5. トラブルシューティング

### 5.1 認証エラー

**エラーメッセージ**:
```
[ERROR] Authentication failed: invalid_client
```

**原因と対処**:

1. **クライアントシークレットの有効期限切れ**:
   - Azure Portal → App registrations → Certificates & secrets
   - 有効期限を確認し、必要に応じて新しいシークレットを作成

2. **テナントIDまたはクライアントIDの誤り**:
   - 環境変数の設定値を確認
   - Azure Portalの**Overview**画面と照合

3. **API権限の未承認**:
   - Azure Portal → API permissions
   - 各権限の`Status`が**Granted**になっているか確認
   - **Grant admin consent**を再実行

### 5.2 ファイルが同期されない

**原因と対処**:

1. **フォルダパスの誤り**:
   - SharePointでフォルダパスを確認
   - 大文字小文字を正確に入力
   - 先頭の`/`を忘れずに（例: `/Documents/Tech`）

2. **ファイル拡張子フィルタ**:
   - 設定で指定した拡張子のみが同期対象
   - 空欄にすると全ファイルが対象

3. **増分同期でスキップされている**:
   - ファイルのタイムスタンプが前回同期時と同じ場合、スキップ
   - `全件同期`モードで再実行して確認

### 5.3 同期が遅い

**原因と対処**:

1. **ファイル数が多い**:
   - 1回の同期で処理するファイル数を確認
   - フォルダを分割して複数の同期設定を作成

2. **ネットワーク遅延**:
   - Microsoft Graph APIへの接続速度を確認
   - プロキシ設定を見直し

3. **ファイルサイズが大きい**:
   - 大容量ファイル（100MB以上）は処理に時間がかかる
   - 必要に応じてファイルサイズ上限を設定

### 5.4 重複したナレッジエントリ

**原因**:
- ファイルマッピングの不整合
- 同期設定の重複

**対処**:
```sql
-- 管理者がPostgreSQLで実行
SELECT sharepoint_file_id, COUNT(*)
FROM ms365_file_mapping
GROUP BY sharepoint_file_id
HAVING COUNT(*) > 1;
```

重複がある場合、システム管理者に連絡してください。

---

## 6. FAQ

### Q1: どのようなファイル形式に対応していますか？

**A**: 以下のファイル形式に対応しています:

- **Officeドキュメント**: Word (.docx), Excel (.xlsx), PowerPoint (.pptx)
- **PDF**: .pdf
- **テキスト**: .txt, .md
- **その他**: 設定でカスタマイズ可能

### Q2: SharePointの権限設定は必要ですか？

**A**: はい、Azure ADアプリに以下の権限が必要です:

- `Sites.Read.All`: SharePointサイトの読み取り
- `Files.Read.All`: ファイルの読み取り

管理者の承認が必要です。

### Q3: ファイルが削除された場合、ナレッジも削除されますか？

**A**: いいえ、自動削除はされません。

- SharePointから削除されたファイルは次回同期時にスキップ
- ナレッジエントリは手動でアーカイブまたは削除してください
- これにより誤削除によるデータ損失を防ぎます

### Q4: 同期頻度を変更できますか？

**A**: はい、`admin`ロールのユーザーは同期スケジュールを変更できます。

1. MS365同期設定画面
2. 対象の設定を編集
3. スケジュール欄にCron式を入力

### Q5: 手動で同期を実行できますか？

**A**: はい、`editor`以上のロールで手動同期が可能です。

1. MS365同期設定画面
2. 対象の設定を選択
3. **手動同期を実行**ボタンをクリック

### Q6: OneDrive個人フォルダも同期できますか？

**A**: はい、可能です。

OneDriveの個人ドライブIDを取得し、同期設定に指定してください。ただし、API権限として`Files.Read.All`が必要です。

### Q7: 本番環境でクライアントシークレットの代わりに証明書認証を使えますか？

**A**: はい、証明書認証が推奨されます。

詳細は[セキュリティガイド](../security/MS365_SYNC_SECURITY.md#2-証明書認証の推奨本番環境)を参照してください。

### Q8: 同期エラーが発生した場合、通知されますか？

**A**: はい、以下の方法で通知されます:

- システムログ（`/var/log/mirai-knowledge-system/ms365-sync.log`）
- Grafanaダッシュボードのアラート
- （設定により）Microsoft Teams Webhook

### Q9: 複数のSharePointサイトを同期できますか？

**A**: はい、複数の同期設定を作成できます。

各SharePointサイトごとに別々の同期設定を作成してください。

### Q10: 同期したファイルのメタデータは保持されますか？

**A**: はい、以下のメタデータが保持されます:

- ファイル名
- 作成者（SharePointユーザー）
- 作成日時
- 最終更新日時
- ファイルサイズ
- SharePointファイルID

### Q11: ファイル内容の全文検索は可能ですか？

**A**: はい、可能です。

取り込まれたファイルはテキスト抽出され、Mirai Knowledge Systemsの全文検索インデックスに登録されます。

### Q12: 同期設定を一時的に無効化できますか？

**A**: はい、同期設定の編集画面で**有効化**チェックボックスを外すと無効化されます。

再度チェックを入れると有効化されます。

### Q13: 増分同期と全件同期の違いは何ですか？

**A**:

| 同期方式 | 説明 | 処理時間 | 推奨シーン |
|---------|------|---------|----------|
| 増分同期 | 変更されたファイルのみ処理 | 短い | 定期的な自動同期 |
| 全件同期 | すべてのファイルを再処理 | 長い | 初回同期、整合性確認 |

### Q14: Graph APIのレート制限に引っかかった場合はどうなりますか？

**A**: 自動的にリトライされます。

- エラーログに`Rate limit exceeded (429)`と記録
- 指数バックオフで自動リトライ（最大5回）
- それでも失敗した場合、次回スケジュール実行時に再試行

### Q15: ファイルが大きすぎてアップロードできない場合は？

**A**: 現在のファイルサイズ上限は50MBです。

これを超えるファイルはスキップされます。上限変更が必要な場合、システム管理者に連絡してください。

---

## 7. サポート

### 技術サポート

問題が解決しない場合は、以下の情報を添えてシステム管理者に連絡してください:

- エラーメッセージ
- 同期設定ID
- 同期履歴ID
- 再現手順

### ドキュメント

- [デプロイガイド](../deployment/MS365_SYNC_DEPLOYMENT.md)
- [セキュリティガイド](../security/MS365_SYNC_SECURITY.md)
- [API仕様書](../docs/API_DOCUMENTATION.md)

---

**最終更新**: 2026-01-31
**バージョン**: 1.0.0
