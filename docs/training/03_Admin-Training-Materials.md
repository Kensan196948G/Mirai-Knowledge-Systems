# Mirai Knowledge Systems 管理者トレーニング資料

## 📚 トレーニング概要

**対象者**: システム管理者、承認者
**所要時間**: 約120分
**前提条件**: ユーザートレーニング完了済み
**目標**: システム管理機能を習得し、運用業務を実施できるようになる

---

## 📋 目次

1. [管理者の役割](#1-管理者の役割)（10分）
2. [ユーザー管理](#2-ユーザー管理)（25分）
3. [ナレッジ承認](#3-ナレッジ承認)（25分）
4. [システム監視](#4-システム監視)（20分）
5. [バックアップと復旧](#5-バックアップと復旧)（15分）
6. [セキュリティ管理](#6-セキュリティ管理)（15分）
7. [トラブルシューティング](#7-トラブルシューティング)（10分）

---

## 1. 管理者の役割

### 1.1 管理者種別

| 役割 | 権限 | 主な業務 |
|------|------|---------|
| システム管理者 | 全権限 | ユーザー管理、システム設定、監視 |
| 承認者 | 承認権限 | ナレッジ承認、コンテンツ管理 |
| 監査者 | 閲覧権限 | ログ確認、コンプライアンス監査 |

### 1.2 日常業務

| 頻度 | 業務 |
|------|------|
| 毎日 | 承認待ちナレッジの確認、アラート確認 |
| 毎週 | ユーザーアカウント確認、バックアップ検証 |
| 毎月 | セキュリティレビュー、キャパシティ確認 |

---

## 2. ユーザー管理

### 2.1 ユーザー一覧画面

**アクセス**: サイドバー → 管理 → ユーザー管理

### 2.2 新規ユーザー作成

**手順**:
1. 「新規作成」ボタンをクリック
2. 以下を入力:
   - ユーザー名（一意）
   - メールアドレス
   - 表示名
   - 役割（施工管理、安全衛生担当など）
   - 所属部署
3. 「作成」をクリック
4. 初期パスワードをユーザーに通知

**初期パスワードルール**:
- 一時的なパスワードを発行
- ユーザーに個別に通知（メールまたは直接）
- 初回ログイン時に変更必須

### 2.3 ユーザー情報編集

**編集可能項目**:
- 表示名
- メールアドレス
- 役割
- 所属部署
- アカウント状態（有効/無効）

### 2.4 パスワードリセット

**手順**:
1. ユーザー一覧からユーザーを選択
2. 「パスワードリセット」をクリック
3. 新しい一時パスワードが生成される
4. ユーザーに通知

### 2.5 アカウントロック解除

**ロック条件**: 5回連続パスワード失敗

**解除手順**:
1. ユーザー詳細画面を開く
2. 「ロック解除」をクリック
3. 必要に応じてパスワードリセット

### 2.6 ユーザー無効化

**退職・異動時**:
1. ユーザー詳細画面を開く
2. 「アカウント無効化」をクリック
3. 確認ダイアログで「無効化」

**注意**: 無効化してもデータは残る（監査対応）

---

## 3. ナレッジ承認

### 3.1 承認待ち一覧

**アクセス**: サイドバー → 管理 → 承認待ち

### 3.2 承認フロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  申請者が   │────▶│  承認者が   │────▶│   公開      │
│  承認申請   │     │  レビュー   │     │   状態      │
└─────────────┘     └──────┬──────┘     └─────────────┘
                          │
                          ▼ 却下
                   ┌─────────────┐
                   │  申請者に   │
                   │  差し戻し   │
                   └─────────────┘
```

### 3.3 承認時のチェックポイント

| 項目 | 確認内容 |
|------|---------|
| 内容の正確性 | 技術的に正しいか |
| 適切な分類 | カテゴリ・タグは適切か |
| 機密情報 | 機密情報が含まれていないか |
| 著作権 | 著作権侵害がないか |
| 読みやすさ | 文章は明確か |

### 3.4 承認操作

**承認**:
1. ナレッジ詳細を確認
2. 「承認」ボタンをクリック
3. （任意）コメントを追加
4. 「確定」

**却下**:
1. ナレッジ詳細を確認
2. 「却下」ボタンをクリック
3. 却下理由を入力（**必須**）
4. 「確定」

### 3.5 却下理由の書き方

**良い例**:
```
タイトルが曖昧なため、より具体的なタイトルに変更してください。
例: 「養生について」→「コンクリート打設後の夏期養生手順」

また、「注意事項」セクションに安全上の注意を追加してください。
```

**悪い例**:
```
内容が不十分です。
```

---

## 4. システム監視

### 4.1 Grafanaダッシュボード

**アクセス**: http://localhost:3000
**ログイン**: admin / (設定したパスワード)

### 4.2 監視項目

| カテゴリ | 監視項目 | 正常値 |
|---------|---------|--------|
| システム | CPU使用率 | < 70% |
| システム | メモリ使用率 | < 80% |
| システム | ディスク使用率 | < 80% |
| アプリ | レスポンスタイム | < 1秒 |
| アプリ | エラー率 | < 1% |
| DB | 接続数 | < 80 |

### 4.3 アラート対応

| アラート | 対応 |
|---------|------|
| MKSBackendDown | サービス再起動、ログ確認 |
| HighCPUUsage | プロセス確認、必要に応じてスケールアップ |
| HighDiskUsage | ログ削除、古いバックアップ削除 |
| PostgreSQLDown | DB再起動、接続確認 |

### 4.4 ログ確認

**アプリケーションログ**:
```bash
# 最新100行
sudo journalctl -u mirai-knowledge-app -n 100

# リアルタイム監視
sudo journalctl -u mirai-knowledge-app -f
```

**Nginxログ**:
```bash
# アクセスログ
tail -f /var/log/nginx/mirai-knowledge-access.log

# エラーログ
tail -f /var/log/nginx/mirai-knowledge-error.log
```

---

## 5. バックアップと復旧

### 5.1 バックアップ構成

| 対象 | 頻度 | 保持期間 | 保存先 |
|------|------|---------|--------|
| PostgreSQL | 毎日 3:00 | 30日 | /var/backups/mirai-knowledge/postgresql |
| アプリデータ | 毎日 4:00 | 30日 | /var/backups/mirai-knowledge/appdata |
| 設定ファイル | 週1回 | 90日 | /var/backups/mirai-knowledge/config |

### 5.2 バックアップ確認

```bash
# バックアップ一覧
ls -la /var/backups/mirai-knowledge/postgresql/

# 最新バックアップの確認
ls -lh /var/backups/mirai-knowledge/postgresql/*.gz | tail -5
```

### 5.3 復旧手順

**PostgreSQL復旧**:
```bash
# 1. サービス停止
sudo systemctl stop mirai-knowledge-app

# 2. バックアップからリストア
./scripts/restore-postgresql.sh /var/backups/mirai-knowledge/postgresql/db_YYYYMMDD_HHMMSS.sql.gz

# 3. サービス再開
sudo systemctl start mirai-knowledge-app

# 4. 動作確認
curl http://localhost:8100/api/v1/health
```

### 5.4 バックアップテスト

**月次で実施**:
1. テスト環境にバックアップをリストア
2. データ整合性確認
3. アプリケーション動作確認
4. 結果を記録

---

## 6. セキュリティ管理

### 6.1 アクセスログ監視

**確認項目**:
- 異常なログイン試行
- 不審なアクセスパターン
- 大量リクエスト

```bash
# ログイン失敗の確認
grep "login failed" /var/log/mirai-knowledge-system/app.log

# IPアドレス別アクセス数
awk '{print $1}' /var/log/nginx/mirai-knowledge-access.log | sort | uniq -c | sort -rn | head -20
```

### 6.2 SSL証明書管理

```bash
# 有効期限確認
./scripts/check-ssl-expiry.sh

# 更新が必要な場合
# 1. 新しい証明書を取得
# 2. 証明書を配置
# 3. Nginx再起動
sudo systemctl reload nginx
```

### 6.3 パスワードポリシー

| 項目 | 設定値 |
|------|--------|
| 最小文字数 | 8文字 |
| 必須文字種 | 英大文字、英小文字、数字、記号 |
| 有効期限 | 90日 |
| 履歴保持 | 過去5回分 |
| ロックアウト | 5回失敗で30分ロック |

### 6.4 セキュリティ監査

**月次チェックリスト**:
- [ ] 不審なアクセスログの確認
- [ ] 無効アカウントの整理
- [ ] 権限設定の確認
- [ ] SSL証明書有効期限確認
- [ ] パッチ適用状況確認

---

## 7. トラブルシューティング

### 7.1 サービスが起動しない

```bash
# 状態確認
sudo systemctl status mirai-knowledge-app

# ログ確認
sudo journalctl -u mirai-knowledge-app -n 50

# 手動起動テスト
cd /mnt/LinuxHDD/Mirai-Knowledge-Systems/backend
source venv/bin/activate
python app_v2.py
```

### 7.2 DBに接続できない

```bash
# PostgreSQL状態確認
sudo systemctl status postgresql

# 接続テスト
psql -U postgres -d mirai_knowledge_db -c "SELECT 1;"

# 接続数確認
psql -U postgres -d mirai_knowledge_db -c "SELECT count(*) FROM pg_stat_activity;"
```

### 7.3 レスポンスが遅い

```bash
# CPU/メモリ確認
top -b -n 1 | head -20

# スロークエリ確認
psql -U postgres -d mirai_knowledge_db -c "SELECT * FROM pg_stat_activity WHERE state = 'active' AND query_start < now() - interval '5 seconds';"

# Gunicornワーカー確認
ps aux | grep gunicorn
```

### 7.4 ディスク容量不足

```bash
# 使用状況確認
df -h

# 大きなファイル特定
du -sh /var/log/* | sort -hr | head -10

# ログローテーション実行
sudo logrotate -f /etc/logrotate.d/mirai-knowledge-system

# 古いバックアップ削除
find /var/backups/mirai-knowledge -name "*.gz" -mtime +30 -delete
```

---

## 📚 参考資料

| 資料 | 内容 |
|------|------|
| [管理者ガイド](../11_運用保守(Operations)/04_Administrator-Guide.md) | 詳細な管理手順 |
| [監視設定ガイド](../11_運用保守(Operations)/07_Monitoring-Setup-Guide.md) | 監視システム詳細 |
| [障害対応フロー](../11_運用保守(Operations)/13_障害対応フロー(Incident-Response).md) | インシデント対応 |
| [バックアップ手順](../11_運用保守(Operations)/08_Backup-Restore-Procedures.md) | バックアップ詳細 |

---

## 📝 トレーニング完了チェックリスト

- [ ] ユーザー作成・編集ができる
- [ ] パスワードリセットができる
- [ ] ナレッジ承認・却下ができる
- [ ] Grafanaダッシュボードを確認できる
- [ ] アラート対応の流れを理解した
- [ ] バックアップ確認方法を理解した
- [ ] 復旧手順を理解した
- [ ] 基本的なトラブルシューティングができる

---

**作成日**: 2026-01-25
**バージョン**: 1.0.0
**Phase**: C-4 ユーザートレーニング
